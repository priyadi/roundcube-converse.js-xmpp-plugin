/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * @license RequireJS text 2.0.14 Copyright (c) 2010-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

// RequireJS UnderscoreJS template plugin
// http://github.com/jfparadis/requirejs-tpl
//
// An alternative to http://github.com/ZeeAgency/requirejs-tpl
//
// Using UnderscoreJS micro-templates at http://underscorejs.org/#template
// Using and RequireJS text.js at http://requirejs.org/docs/api.html#text
// @author JF Paradis
// @version 0.0.2
//
// Released under the MIT license
//
// Usage:
//   require(['backbone', 'tpl!mytemplate'], function (Backbone, mytemplate) {
//     return Backbone.View.extend({
//       initialize: function(){
//         this.render();
//       },
//       render: function(){
//         this.$el.html(mytemplate({message: 'hello'}));
//     });
//   });
//
// Configuration: (optional)
//   require.config({
//     tpl: {
//       extension: '.tpl' // default = '.html'
//     }
//   });

// Converse.js (A browser based XMPP chat client)
// http://conversejs.org
//
// Copyright (c) 2012-2016, Jan-Carel Brand <jc@opkode.com>
// Licensed under the Mozilla Public License (MPLv2)
//

/*
jed.js
v0.5.0beta

https://github.com/SlexAxton/Jed
-----------
A gettext compatible i18n library for modern JavaScript Applications

by Alex Sexton - AlexSexton [at] gmail - @SlexAxton
WTFPL license for use
Dojo CLA for contributions

Jed offers the entire applicable GNU gettext spec'd set of
functions, but also offers some nicer wrappers around them.
The api for gettext was written for a language with no function
overloading, so Jed allows a little more of that.

Many thanks to Joshua I. Miller - unrtst@cpan.org - who wrote
gettext.js back in 2008. I was able to vet a lot of my ideas
against his. I also made sure Jed passed against his tests
in order to offer easy upgrades -- jsgettext.berlios.de
*/

// Underscore 1.3.0 was used to port and is licensed

/**
   sprintf() for JavaScript 0.7-beta1
   http://www.diveintojavascript.com/projects/javascript-sprintf

   Copyright (c) Alexandru Marasteanu <alexaholic [at) gmail (dot] com>
   All rights reserved.

   Redistribution and use in source and binary forms, with or without
   modification, are permitted provided that the following conditions are met:
       * Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.
       * Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in the
         documentation and/or other materials provided with the distribution.
       * Neither the name of sprintf() for JavaScript nor the
         names of its contributors may be used to endorse or promote products
         derived from this software without specific prior written permission.

   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   DISCLAIMED. IN NO EVENT SHALL Alexandru Marasteanu BE LIABLE FOR ANY
   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */

var requirejs,require,define;(function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.slice(0,v.length-1).concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("components/almond/almond.js",function(){}),define("text",["module"],function(e){"use strict";var t,n,r,i,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,f=typeof location!="undefined"&&location.href,l=f&&location.protocol&&location.protocol.replace(/\:/,""),c=f&&location.hostname,h=f&&(location.port||undefined),p={},d=e.config&&e.config()||{};t={version:"2.0.14",strip:function(e){if(e){e=e.replace(u,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=o[t];try{e=new ActiveXObject(n)}catch(r){}if(e){o=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,s=e.lastIndexOf("."),o=e.indexOf("./")===0||e.indexOf("../")===0;return s!==-1&&(!o||s>1)?(t=e.substring(0,s),n=e.substring(s+1)):t=e,r=n||t,s=r.indexOf("!"),s!==-1&&(i=r.substring(s+1)==="strip",r=r.substring(0,s),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,d.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i&&i.isBuild&&!i.inlineText){r();return}d.isBuild=i&&i.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),u=n.toUrl(o),a=d.useXhr||t.useXhr;if(u.indexOf("empty:")===0){r();return}!f||a(u,l,c,h)?t.get(u,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(p.hasOwnProperty(n)){var s=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.ext?"."+o.ext:"",a=o.moduleName+u,f=r.toUrl(o.moduleName+u)+".js";t.load(a,r,function(n){var r=function(e){return i(f,e)};r.asModule=function(e,t){return i.asModule(e,f,t)},t.write(e,a,r,s)},s)}};if(d.env==="node"||!d.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"])n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");i[0]==="ï»¿"&&(i=i.substring(1)),t(i)}catch(s){r&&r(s)}};else if(d.env==="xhr"||!d.env&&t.createXhr())t.get=function(e,n,r,i){var s=t.createXhr(),o;s.open("GET",e,!0);if(i)for(o in i)i.hasOwnProperty(o)&&s.setRequestHeader(o.toLowerCase(),i[o]);d.onXhr&&d.onXhr(s,e),s.onreadystatechange=function(t){var i,o;s.readyState===4&&(i=s.status||0,i>399&&i<600?(o=new Error(e+" HTTP status: "+i),o.xhr=s,r&&r(o)):n(s.responseText),d.onXhrComplete&&d.onXhrComplete(s,e))},s.send(null)};else if(d.env==="rhino"||!d.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),r!==null&&n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};else if(d.env==="xpconnect"||!d.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,o,u,a={};s&&(e=e.replace(/\//g,"\\")),u=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(u,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),o.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(n.available(),a),o.close(),n.close(),t(a.value)}catch(f){throw new Error((u&&u.path||"")+": "+f)}};return t}),define("tpl",["text","underscore"],function(e,t){"use strict";var n={},r="define('{pluginName}!{moduleName}', function () { return {source}; });\n";return{version:"0.0.2",load:function(r,i,s,o){o.tpl&&o.tpl.templateSettings&&(t.templateSettings=o.tpl.templateSettings);if(n[r])s(n[r]);else{var u=o.tpl&&o.tpl.extension||".html",a=o.tpl&&o.tpl.path||"";e.load(a+r+u,i,function(e){n[r]=t.template(e),s(n[r])},o)}},write:function(e,t,i){var s=n[t],o=s&&s.source;o&&i.asModule(e+"!"+t,r.replace("{pluginName}",e).replace("{moduleName}",t).replace("{source}",o))}}}),define("tpl!action",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="chat-message '+((__t=extra_classes)==null?"":__t)+'" data-isodate="'+((__t=isodate)==null?"":__t)+'">\n    <span class="chat-msg-author chat-msg-'+((__t=sender)==null?"":__t)+'">'+((__t=time)==null?"":__t)+" **"+((__t=username)==null?"":__t)+' </span>\n    <span class="chat-msg-content">'+((__t=message)==null?"":__t)+"</span>\n</div>\n";return __p}}),define("tpl!add_contact_dropdown",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<dl class="add-converse-contact dropdown">\n    <dt id="xmpp-contact-search" class="fancy-dropdown">\n        <a class="toggle-xmpp-contact-form icon-plus" href="#" title="'+((__t=label_click_to_chat)==null?"":__t)+'"> '+((__t=label_add_contact)==null?"":__t)+'</a>\n    </dt>\n    <dd class="search-xmpp" style="display:none"><ul></ul></dd>\n</dl>\n';return __p}}),define("tpl!add_contact_form",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li>\n    <form class="pure-form add-xmpp-contact">\n        <input type="text"\n            name="identifier"\n            class="username"\n            placeholder="'+((__t=label_contact_username)==null?"":__t)+'"/>\n        <button class="pure-button button-primary" type="submit">'+((__t=label_add)==null?"":__t)+"</button>\n    </form>\n</li>\n";return __p}}),define("tpl!change_status_message",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form id="set-custom-xmpp-status" class="pure-form">\n<fieldset>\n    <span class="input-button-group">\n        <input type="text" class="custom-xmpp-status" '+((__t=status_message)==null?"":__t)+' placeholder="'+((__t=label_custom_status)==null?"":__t)+'"/>\n        <input type="submit" class="pure-button button-primary" value="'+((__t=label_save)==null?"":__t)+'"/>\n    </span>\n</fieldset>\n</form>\n';return __p}}),define("tpl!chat_status",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="xmpp-status">\n    <a class="choose-xmpp-status '+((__t=chat_status)==null?"":__t)+" icon-"+((__t=chat_status)==null?"":__t)+'" data-value="'+((__t=status_message)==null?"":__t)+'" href="#" title="'+((__t=desc_change_status)==null?"":__t)+'">\n        '+((__t=status_message)==null?"":__t)+'\n    </a>\n    <a class="change-xmpp-status-message icon-pencil" href="#" title="'+((__t=desc_custom_status)==null?"":__t)+'"></a>\n</div>\n';return __p}}),define("tpl!chatarea",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="chat-area">\n    <div class="chat-content"></div>\n    <form class="sendXMPPMessage" action="" method="post">\n        ',show_toolbar&&(__p+='\n            <ul class="chat-toolbar no-text-select"></ul>\n        '),__p+='\n        <textarea type="text" class="chat-textarea" \n            placeholder="'+((__t=label_message)==null?"":__t)+'"/>\n    </form>\n</div>\n';return __p}}),define("tpl!chatbox",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="flyout box-flyout">\n    <div class="dragresize dragresize-top"></div>\n    <div class="dragresize dragresize-topleft"></div>\n    <div class="dragresize dragresize-left"></div>\n    <div class="chat-head chat-head-chatbox">\n        <a class="chatbox-btn close-chatbox-button icon-close" title="'+((__t=info_close)==null?"":__t)+'"></a>\n        <a class="chatbox-btn toggle-chatbox-button icon-minus" title="'+((__t=info_minimize)==null?"":__t)+'"></a>\n        <div class="chat-title">\n            ',url&&(__p+='\n                <a href="'+((__t=url)==null?"":__t)+'" target="_blank" rel="noopener" class="user">\n            '),__p+="\n                    "+((__t=title)==null?"":__t)+"\n            ",url&&(__p+="\n                </a>\n            "),__p+='\n        </div>\n        <p class="user-custom-message"><p/>\n    </div>\n    <div class="chat-body">\n        <div class="chat-content"></div>\n        ',show_textarea&&(__p+='\n        <form class="sendXMPPMessage" action="" method="post">\n            ',show_toolbar&&(__p+='\n                <ul class="chat-toolbar no-text-select"></ul>\n            '),__p+='\n        <textarea\n            type="text"\n            class="chat-textarea"\n            placeholder="'+((__t=label_personal_message)==null?"":__t)+'"/>\n        </form>\n        '),__p+="\n    </div>\n</div>\n";return __p}}),define("tpl!chatroom",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="flyout box-flyout">\n    <div class="dragresize dragresize-top"></div>\n    <div class="dragresize dragresize-topleft"></div>\n    <div class="dragresize dragresize-left"></div>\n    <div class="chat-head chat-head-chatroom">\n        <a class="chatbox-btn close-chatbox-button icon-close"></a>\n        <a class="chatbox-btn toggle-chatbox-button icon-minus"></a>\n        <a class="chatbox-btn configure-chatroom-button icon-wrench" style="display:none"></a>\n        <div class="chat-title"> '+((__t=_.escape(name))==null?"":__t)+' </div>\n        <p class="chatroom-topic"><p/>\n    </div>\n    <div class="chat-body chatroom-body"><span class="spinner centered"/></div>\n</div>\n';return __p}}),define("tpl!chatroom_form",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="chatroom-form-container">\n    <form class="pure-form pure-form-stacked converse-form chatroom-form">\n        <fieldset>\n            <span class="spinner centered"/>\n        </fieldset>\n    </form>\n</div>\n';return __p}}),define("tpl!chatroom_password_form",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="chatroom-form-container">\n    <form class="pure-form converse-form chatroom-form">\n        <fieldset>\n            <legend>'+((__t=heading)==null?"":__t)+"</legend>\n            <label>"+((__t=label_password)==null?"":__t)+'</label>\n            <input type="password" name="password"/>\n        </fieldset>\n        <fieldset>\n            <input class="pure-button button-primary" type="submit" value="'+((__t=label_submit)==null?"":__t)+'"/>\n        </fieldset>\n    </form>\n</div>\n';return __p}}),define("tpl!chatroom_sidebar",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<!-- <div class="occupants"> -->\n<form class="pure-form room-invite">\n    <input class="invited-contact" placeholder="'+((__t=label_invitation)==null?"":__t)+'" type="text"/>\n</form>\n<p class="occupants-heading">'+((__t=label_occupants)==null?"":__t)+':</p>\n<ul class="occupant-list"></ul>\n<!-- </div> -->\n';return __p}}),define("tpl!chatrooms_tab",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li><a class="s" href="#chatrooms">'+((__t=label_rooms)==null?"":__t)+"</a></li>\n";return __p}}),define("tpl!chats_panel",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div id="minimized-chats">\n    <a id="toggle-minimized-chats" href="#"></a>\n    <div class="flyout minimized-chats-flyout"></div>\n</div>\n';return __p}}),define("tpl!choose_status",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<dl id="target" class="dropdown">\n    <dt id="fancy-xmpp-status-select" class="fancy-dropdown"></dt>\n    <dd><ul class="xmpp-status-menu"></ul></dd>\n</dl>\n';return __p}}),define("tpl!contacts_panel",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form class="pure-form set-xmpp-status" action="" method="post">\n    <span id="xmpp-status-holder">\n        <select id="select-xmpp-status" style="display:none">\n            <option value="online">'+((__t=label_online)==null?"":__t)+'</option>\n            <option value="dnd">'+((__t=label_busy)==null?"":__t)+'</option>\n            <option value="away">'+((__t=label_away)==null?"":__t)+"</option>\n            ",include_offline_state&&(__p+='\n            <option value="offline">'+((__t=label_offline)==null?"":__t)+"</option>\n            "),__p+="\n            ",allow_logout&&(__p+='\n            <option value="logout">'+((__t=label_logout)==null?"":__t)+"</option>\n            "),__p+="\n        </select>\n    </span>\n</form>\n";return __p}}),define("tpl!contacts_tab",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li><a class="s current" href="#users">'+((__t=label_contacts)==null?"":__t)+"</a></li>\n";return __p}}),define("tpl!controlbox",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="flyout box-flyout">\n    <div class="dragresize dragresize-top"></div>\n    <div class="dragresize dragresize-topleft"></div>\n    <div class="dragresize dragresize-left"></div>\n    <div class="chat-head controlbox-head">\n        <ul id="controlbox-tabs"></ul>\n        <a class="chatbox-btn close-chatbox-button icon-close"></a>\n    </div>\n    <div class="controlbox-panes"></div>\n</div>\n';return __p}}),define("tpl!controlbox_toggle",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<span class="conn-feedback">'+((__t=label_toggle)==null?"":__t)+'</span>\n<span style="display: none" id="online-count">(0)</span>\n';return __p}}),define("tpl!field",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<field var="'+((__t=name)==null?"":__t)+'">',_.isArray(value)?(__p+="\n    ",_.each(value,function(e){__p+="<value>"+((__t=e)==null?"":__t)+"</value>"}),__p+="\n"):__p+="\n    <value>"+((__t=value)==null?"":__t)+"</value>\n",__p+="</field>\n";return __p}}),define("tpl!form_captcha",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",label&&(__p+="\n<label>\n    "+((__t=label)==null?"":__t)+"\n</label>\n"),__p+='\n<img src="data:'+((__t=type)==null?"":__t)+";base64,"+((__t=data)==null?"":__t)+'">\n<input name="'+((__t=name)==null?"":__t)+'" type="text" ',required&&(__p+=' class="required" '),__p+=" >\n\n\n";return __p}}),define("tpl!form_checkbox",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="<label>"+((__t=label)==null?"":__t)+'</label>\n<input name="'+((__t=name)==null?"":__t)+'" type="'+((__t=type)==null?"":__t)+'" '+((__t=checked)==null?"":__t)+">\n";return __p}}),define("tpl!form_input",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",label&&(__p+="\n<label>\n    "+((__t=label)==null?"":__t)+"\n</label>\n"),__p+='\n<input name="'+((__t=name)==null?"":__t)+'" type="'+((__t=type)==null?"":__t)+'" \n    ',value&&(__p+=' value="'+((__t=value)==null?"":__t)+'" '),__p+="\n    ",required&&(__p+=' class="required" '),__p+=" >\n";return __p}}),define("tpl!form_select",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="<label>"+((__t=label)==null?"":__t)+'</label>\n<select name="'+((__t=name)==null?"":__t)+'"  ',multiple&&(__p+=' multiple="multiple" '),__p+=">"+((__t=options)==null?"":__t)+"</select>\n";return __p}}),define("tpl!form_textarea",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<label class="label-ta">'+((__t=label)==null?"":__t)+'</label>\n<textarea name="'+((__t=name)==null?"":__t)+'">'+((__t=value)==null?"":__t)+"</textarea>\n";return __p}}),define("tpl!form_username",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",label&&(__p+="\n<label>\n    "+((__t=label)==null?"":__t)+"\n</label>\n"),__p+='\n<div class="input-group">\n    <input name="'+((__t=name)==null?"":__t)+'" type="'+((__t=type)==null?"":__t)+'"\n        ',value&&(__p+=' value="'+((__t=value)==null?"":__t)+'" '),__p+="\n        ",required&&(__p+=' class="required" '),__p+=' />\n    <span title="'+((__t=domain)==null?"":__t)+'">'+((__t=domain)==null?"":__t)+"</span>\n</div>\n";return __p}}),define("tpl!group_header",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<a href="#" class="group-toggle icon-'+((__t=toggle_state)==null?"":__t)+'" title="'+((__t=desc_group_toggle)==null?"":__t)+'">'+((__t=label_group)==null?"":__t)+"</a>\n";return __p}}),define("tpl!info",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="chat-info">'+((__t=message)==null?"":__t)+"</div>\n";return __p}}),define("tpl!login_panel",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form class="pure-form pure-form-stacked converse-form" id="converse-login" method="post">\n    ',auto_login&&(__p+='\n        <span class="spinner login-submit"/>\n    '),__p+="\n    ",auto_login||(__p+="\n        ",authentication==LOGIN&&(__p+="\n            <label>"+((__t=label_username)==null?"":__t)+'</label>\n            <input type="text" name="jid" placeholder="'+((__t=placeholder_username)==null?"":__t)+'">\n            <label>'+((__t=label_password)==null?"":__t)+'</label>\n            <input type="password" name="password" placeholder="'+((__t=placeholder_password)==null?"":__t)+'">\n            <input class="pure-button button-primary" type="submit" value="'+((__t=label_login)==null?"":__t)+'">\n            <span class="conn-feedback"></span>\n        '),__p+="\n        ",authentication==ANONYMOUS&&(__p+='\n            <input type="pure-button button-primary" class="submit login-anon" value="'+((__t=label_anon_login)==null?"":__t)+'"/>\n        '),__p+="\n        ",authentication==PREBIND&&(__p+="\n            <p>Disconnected.</p>\n        "),__p+="\n    "),__p+="\n</form>\n";return __p}}),define("tpl!login_tab",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li><a class="current" href="#login-dialog">'+((__t=label_sign_in)==null?"":__t)+"</a></li>\n";return __p}}),define("tpl!message",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<div class="chat-message '+((__t=extra_classes)==null?"":__t)+'" data-isodate="'+((__t=isodate)==null?"":__t)+'" data-msgid="'+((__t=msgid)==null?"":__t)+'">\n    <span class="chat-msg-author chat-msg-'+((__t=sender)==null?"":__t)+'">'+((__t=time)==null?"":__t)+" "+((__t=username)==null?"":__t)+':&nbsp;</span>\n    <span class="chat-msg-content">'+((__t=message)==null?"":__t)+"</span>\n</div>\n";return __p}}),define("tpl!new_day",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<time class="chat-info chat-date" data-isodate="'+((__t=isodate)==null?"":__t)+'">'+((__t=datestring)==null?"":__t)+"</time>\n";return __p}}),define("tpl!occupant",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li class="'+((__t=role)==null?"":__t)+'"\n    ',role==="moderator"&&(__p+='\n       title="'+((__t=desc_moderator)==null?"":__t)+'"\n    '),__p+="\n    ",role==="occupant"&&(__p+='\n       title="'+((__t=desc_occupant)==null?"":__t)+'"\n    '),__p+="\n    ",role==="visitor"&&(__p+='\n       title="'+((__t=desc_visitor)==null?"":__t)+'"\n    '),__p+="\n>"+((__t=nick)==null?"":__t)+"</li>\n";return __p}}),define("tpl!pending_contact",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",allow_chat_pending_contacts&&(__p+='\n<a class="open-chat"href="#">\n'),__p+='\n<span class="pending-contact-name" title="Name: '+((__t=fullname)==null?"":__t)+"\nJID: "+((__t=jid)==null?"":__t)+'">'+((__t=fullname)==null?"":__t)+"</span> \n",allow_chat_pending_contacts&&(__p+="\n</a>\n"),__p+='\n<a class="remove-xmpp-contact icon-remove" title="'+((__t=desc_remove)==null?"":__t)+'" href="#"></a>\n';return __p}}),define("tpl!pending_contacts",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<dt class="roster-group" id="pending-xmpp-contacts"><a href="#" class="group-toggle icon-'+((__t=toggle_state)==null?"":__t)+'" title="'+((__t=desc_group_toggle)==null?"":__t)+'">'+((__t=label_pending_contacts)==null?"":__t)+"</a></dt>\n";return __p}}),define("tpl!register_panel",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form id="converse-register" class="pure-form converse-form">\n    <span class="reg-feedback"></span>\n    <label>'+((__t=label_domain)==null?"":__t)+'</label>\n    <input type="text" name="domain" placeholder="'+((__t=domain_placeholder)==null?"":__t)+'">\n    <p class="form-help">'+((__t=help_providers)==null?"":__t)+' <a href="'+((__t=href_providers)==null?"":__t)+'" class="url" target="_blank" rel="noopener">'+((__t=help_providers_link)==null?"":__t)+'</a>.</p>\n    <input class="pure-button button-primary" type="submit" value="'+((__t=label_register)==null?"":__t)+'">\n</form>\n';return __p}}),define("tpl!register_tab",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li><a class="s" href="#register">'+((__t=label_register)==null?"":__t)+"</a></li>\n";return __p}}),define("tpl!registration_form",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<p class="provider-title">'+((__t=domain)==null?"":__t)+"</p>\n<a href='https://xmpp.net/result.php?domain="+((__t=domain)==null?"":__t)+"&amp;type=client'>\n    <img class=\"provider-score\" src='https://xmpp.net/badge.php?domain="+((__t=domain)==null?"":__t)+"' alt='xmpp.net score' />\n</a>\n<p class=\"title\">"+((__t=title)==null?"":__t)+'</p>\n<p class="instructions">'+((__t=instructions)==null?"":__t)+"</p>\n";return __p}}),define("tpl!registration_request",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<span class="spinner login-submit"/>\n<p class="info">'+((__t=info_message)==null?"":__t)+'</p>\n<button class="pure-button button-cancel hor_centered">'+((__t=cancel)==null?"":__t)+"</button>\n";return __p}}),define("tpl!requesting_contact",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",allow_chat_pending_contacts&&(__p+='\n<a class="open-chat"href="#">\n'),__p+='\n<span class="req-contact-name" title="Name: '+((__t=fullname)==null?"":__t)+"\nJID: "+((__t=jid)==null?"":__t)+'">'+((__t=fullname)==null?"":__t)+"</span>\n",allow_chat_pending_contacts&&(__p+="\n</a>\n"),__p+='\n<span class="request-actions">\n    <a class="accept-xmpp-request icon-checkmark" title="'+((__t=desc_accept)==null?"":__t)+'" href="#"></a>\n    <a class="decline-xmpp-request icon-close" title="'+((__t=desc_decline)==null?"":__t)+'" href="#"></a>\n</span>\n';return __p}}),define("tpl!requesting_contacts",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<dt class="roster-group" id="xmpp-contact-requests"><a href="#" class="group-toggle icon-'+((__t=toggle_state)==null?"":__t)+'" title="'+((__t=desc_group_toggle)==null?"":__t)+'">'+((__t=label_contact_requests)==null?"":__t)+"</a></dt>\n";return __p}}),define("tpl!room_description",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<!-- FIXME: check markup in mockup -->\n<div class="room-info">\n<p class="room-info"><strong>'+((__t=label_desc)==null?"":__t)+"</strong> "+((__t=desc)==null?"":__t)+'</p>\n<p class="room-info"><strong>'+((__t=label_occ)==null?"":__t)+"</strong> "+((__t=occ)==null?"":__t)+'</p>\n<p class="room-info"><strong>'+((__t=label_features)==null?"":__t)+"</strong>\n    <ul>\n        ",passwordprotected&&(__p+='\n        <li class="room-info locked">'+((__t=label_requires_auth)==null?"":__t)+"</li>\n        "),__p+="\n        ",hidden&&(__p+='\n        <li class="room-info">'+((__t=label_hidden)==null?"":__t)+"</li>\n        "),__p+="\n        ",membersonly&&(__p+='\n        <li class="room-info">'+((__t=label_requires_invite)==null?"":__t)+"</li>\n        "),__p+="\n        ",moderated&&(__p+='\n        <li class="room-info">'+((__t=label_moderated)==null?"":__t)+"</li>\n        "),__p+="\n        ",nonanonymous&&(__p+='\n        <li class="room-info">'+((__t=label_non_anon)==null?"":__t)+"</li>\n        "),__p+="\n        ",open&&(__p+='\n        <li class="room-info">'+((__t=label_open_room)==null?"":__t)+"</li>\n        "),__p+="\n        ",persistent&&(__p+='\n        <li class="room-info">'+((__t=label_permanent_room)==null?"":__t)+"</li>\n        "),__p+="\n        ",publicroom&&(__p+='\n        <li class="room-info">'+((__t=label_public)==null?"":__t)+"</li>\n        "),__p+="\n        ",semianonymous&&(__p+='\n        <li class="room-info">'+((__t=label_semi_anon)==null?"":__t)+"</li>\n        "),__p+="\n        ",temporary&&(__p+='\n        <li class="room-info">'+((__t=label_temp_room)==null?"":__t)+"</li>\n        "),__p+="\n        ",unmoderated&&(__p+='\n        <li class="room-info">'+((__t=label_unmoderated)==null?"":__t)+"</li>\n        "),__p+="\n    </ul>\n</p>\n</div>\n";return __p}}),define("tpl!room_item",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<dd class="available-chatroom">\n<a class="open-room" data-room-jid="'+((__t=jid)==null?"":__t)+'"\n   title="'+((__t=open_title)==null?"":__t)+'" href="#">'+((__t=_.escape(name))==null?"":__t)+'</a>\n<a class="room-info icon-room-info" data-room-jid="'+((__t=jid)==null?"":__t)+'"\n   title="'+((__t=info_title)==null?"":__t)+'" href="#">&nbsp;</a>\n</dd>\n';return __p}}),define("tpl!room_panel",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form class="pure-form pure-form-stacked converse-form add-chatroom" action="" method="post">\n    <fieldset>\n        <label>'+((__t=label_room_name)==null?"":__t)+'</label>\n        <input type="text" name="chatroom" class="new-chatroom-name" placeholder="'+((__t=label_room_name)==null?"":__t)+'"/>\n        <label>'+((__t=label_nickname)==null?"":__t)+'</label> <input type="text" name="nick" class="new-chatroom-nick" placeholder="'+((__t=label_nickname)==null?"":__t)+'"/>\n        <input type="submit" class="pure-button button-primary" name="join" value="'+((__t=label_join)==null?"":__t)+'"/>\n    </fieldset>\n    <fieldset>\n        ',server_input_type!="hidden"&&(__p+="\n            <label"+((__t=server_label_global_attr)==null?"":__t)+">"+((__t=label_server)==null?"":__t)+"</label>\n        "),__p+='\n        <input type="'+((__t=server_input_type)==null?"":__t)+'" name="server" class="new-chatroom-server" placeholder="'+((__t=label_server)==null?"":__t)+'"/>\n        <input type="button" class="pure-button button-secondary" name="show" id="show-rooms" value="'+((__t=label_show_rooms)==null?"":__t)+'"/>\n    </fieldset>\n</form>\n<dl id="available-chatrooms"></dl>\n';return __p}}),define("tpl!roster",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form class="pure-form roster-filter-group input-button-group">\n    <input style="display: none;" class="roster-filter" placeholder="'+((__t=placeholder)==null?"":__t)+'">\n    <select style="display: none;" class="filter-type">\n        <option value="contacts">'+((__t=label_contacts)==null?"":__t)+'</option>\n        <option value="groups">'+((__t=label_groups)==null?"":__t)+"</option>\n    </select>\n</form>\n";return __p}}),define("tpl!roster_item",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<a class="open-chat" title="'+((__t=title_fullname)==null?"":__t)+": "+((__t=fullname)==null?"":__t)+"\nJID: "+((__t=jid)==null?"":__t)+"\n"+((__t=desc_chat)==null?"":__t)+'" href="#"><span class="icon-'+((__t=chat_status)==null?"":__t)+'" title="'+((__t=desc_status)==null?"":__t)+'"></span>'+((__t=fullname)==null?"":__t)+"</a>\n",allow_contact_removal&&(__p+='\n<a class="remove-xmpp-contact icon-remove" title="'+((__t=desc_remove)==null?"":__t)+'" href="#"></a>\n'),__p+="\n";return __p}}),define("tpl!search_contact",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li>\n    <form class="search-xmpp-contact">\n        <input type="text"\n            name="identifier"\n            class="username"\n            placeholder="'+((__t=label_contact_name)==null?"":__t)+'"/>\n        <button type="submit">'+((__t=label_search)==null?"":__t)+"</button>\n    </form>\n</li>\n";return __p}}),define("tpl!select_option",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<option value="'+((__t=value)==null?"":__t)+'" ',selected&&(__p+=' selected="selected" '),__p+=" >"+((__t=label)==null?"":__t)+"</option>\n";return __p}}),define("tpl!status_option",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<li>\n    <a href="#" class="'+((__t=value)==null?"":__t)+'" data-value="'+((__t=value)==null?"":__t)+'">\n        <span class="icon-'+((__t=value)==null?"":__t)+'"></span>\n        '+((__t=text)==null?"":__t)+"\n    </a>\n</li>\n";return __p}}),define("tpl!toggle_chats",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+=""+((__t=Minimized)==null?"":__t)+' <span id="minimized-count">('+((__t=num_minimized)==null?"":__t)+')</span>\n<span class="unread-message-count"\n    ',num_unread||(__p+=' style="display: none" '),__p+='\n    href="#">'+((__t=num_unread)==null?"":__t)+"</span>\n";return __p}}),define("tpl!toolbar",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",show_emoticons&&(__p+='\n    <li class="toggle-smiley icon-happy" title="'+((__t=label_insert_smiley)==null?"":__t)+'">\n        <ul>\n            <li><a class="icon-smiley" href="#" data-emoticon=":)"></a></li>\n            <li><a class="icon-wink" href="#" data-emoticon=";)"></a></li>\n            <li><a class="icon-grin" href="#" data-emoticon=":D"></a></li>\n            <li><a class="icon-tongue" href="#" data-emoticon=":P"></a></li>\n            <li><a class="icon-cool" href="#" data-emoticon="8)"></a></li>\n            <li><a class="icon-evil" href="#" data-emoticon=">:)"></a></li>\n            <li><a class="icon-confused" href="#" data-emoticon=":S"></a></li>\n            <li><a class="icon-wondering" href="#" data-emoticon=":\\"></a></li>\n            <li><a class="icon-angry" href="#" data-emoticon=">:("></a></li>\n            <li><a class="icon-sad" href="#" data-emoticon=":("></a></li>\n            <li><a class="icon-shocked" href="#" data-emoticon=":O"></a></li>\n            <li><a class="icon-thumbs-up" href="#" data-emoticon="(^.^)b"></a></li>\n            <li><a class="icon-heart" href="#" data-emoticon="<3"></a></li>\n        </ul>\n    </li>\n'),__p+="\n",show_call_button&&(__p+='\n<li class="toggle-call"><a class="icon-phone" title="'+((__t=label_start_call)==null?"":__t)+'"></a></li>\n'),__p+="\n",show_occupants_toggle&&(__p+='\n<li class="toggle-occupants"><a class="icon-hide-users" title="'+((__t=label_hide_occupants)==null?"":__t)+'"></a></li>\n'),__p+="\n",show_clear_button&&(__p+='\n<li class="toggle-clear"><a class="icon-remove" title="'+((__t=label_clear)==null?"":__t)+'"></a></li>\n'),__p+="\n";return __p}}),define("tpl!toolbar_otr",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+="",allow_otr&&(__p+='\n    <li class="toggle-otr '+((__t=otr_status_class)==null?"":__t)+'" title="'+((__t=otr_tooltip)==null?"":__t)+'">\n        <span class="chat-toolbar-text">'+((__t=otr_translated_status)==null?"":__t)+"</span>\n        ",otr_status==UNENCRYPTED&&(__p+='\n            <span class="icon-unlocked"></span>\n        '),__p+="\n        ",otr_status==UNVERIFIED&&(__p+='\n            <span class="icon-lock"></span>\n        '),__p+="\n        ",otr_status==VERIFIED&&(__p+='\n            <span class="icon-lock"></span>\n        '),__p+="\n        ",otr_status==FINISHED&&(__p+='\n            <span class="icon-unlocked"></span>\n        '),__p+="\n        <ul>\n            ",otr_status==UNENCRYPTED&&(__p+='\n               <li><a class="start-otr" href="#">'+((__t=label_start_encrypted_conversation)==null?"":__t)+"</a></li>\n            "),__p+="\n            ",otr_status!=UNENCRYPTED&&(__p+='\n               <li><a class="start-otr" href="#">'+((__t=label_refresh_encrypted_conversation)==null?"":__t)+'</a></li>\n               <li><a class="end-otr" href="#">'+((__t=label_end_encrypted_conversation)==null?"":__t)+'</a></li>\n               <li><a class="auth-otr" data-scheme="smp" href="#">'+((__t=label_verify_with_smp)==null?"":__t)+"</a></li>\n            "),__p+="\n            ",otr_status==UNVERIFIED&&(__p+='\n               <li><a class="auth-otr" data-scheme="fingerprint" href="#">'+((__t=label_verify_with_fingerprints)==null?"":__t)+"</a></li>\n            "),__p+='\n            <li><a href="http://www.cypherpunks.ca/otr/help/3.2.0/levels.php" target="_blank" rel="noopener">'+((__t=label_whats_this)==null?"":__t)+"</a></li>\n        </ul>\n    </li>\n"),__p+="\n";return __p}}),define("tpl!trimmed_chat",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<a class="chatbox-btn close-chatbox-button icon-close"></a>\n<a class="chat-head-message-count" \n    ',num_unread||(__p+=' style="display: none" '),__p+='\n    href="#">'+((__t=num_unread)==null?"":__t)+'</a>\n<a href="#" class="restore-chat" title="'+((__t=tooltip)==null?"":__t)+'">\n    '+((__t=title)==null?"":__t)+"\n</a>\n";return __p}}),define("tpl!vcard",[],function(){return function(obj){var __t,__p="",__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,"")};with(obj||{})__p+='<form class="pure-form converse-form vcard-info">\n    <fieldset>\n        <legend>The VCard info gets rendered here</legend>\n        <label>Full name:</label>\n        '+((__t=fullname)==null?"":__t)+"\n        <label>URL:</label>\n        "+((__t=url)==null?"":__t)+'\n    </fieldset>\n    <fieldset>\n        <input type="button" class="pure-button button-cancel" value="'+((__t=label_return)==null?"":__t)+'"/>\n    </fieldset>\n</form>\n';return __p}}),define("converse-templates",["tpl!action","tpl!add_contact_dropdown","tpl!add_contact_form","tpl!change_status_message","tpl!chat_status","tpl!chatarea","tpl!chatbox","tpl!chatroom","tpl!chatroom_form","tpl!chatroom_password_form","tpl!chatroom_sidebar","tpl!chatrooms_tab","tpl!chats_panel","tpl!choose_status","tpl!contacts_panel","tpl!contacts_tab","tpl!controlbox","tpl!controlbox_toggle","tpl!field","tpl!form_captcha","tpl!form_checkbox","tpl!form_input","tpl!form_select","tpl!form_textarea","tpl!form_username","tpl!group_header","tpl!info","tpl!login_panel","tpl!login_tab","tpl!message","tpl!new_day","tpl!occupant","tpl!pending_contact","tpl!pending_contacts","tpl!register_panel","tpl!register_tab","tpl!registration_form","tpl!registration_request","tpl!requesting_contact","tpl!requesting_contacts","tpl!room_description","tpl!room_item","tpl!room_panel","tpl!roster","tpl!roster_item","tpl!search_contact","tpl!select_option","tpl!status_option","tpl!toggle_chats","tpl!toolbar","tpl!toolbar_otr","tpl!trimmed_chat","tpl!vcard"],function(){return{action:arguments[0],add_contact_dropdown:arguments[1],add_contact_form:arguments[2],change_status_message:arguments[3],chat_status:arguments[4],chatarea:arguments[5],chatbox:arguments[6],chatroom:arguments[7],chatroom_form:arguments[8],chatroom_password_form:arguments[9],chatroom_sidebar:arguments[10],chatrooms_tab:arguments[11],chats_panel:arguments[12],choose_status:arguments[13],contacts_panel:arguments[14],contacts_tab:arguments[15],controlbox:arguments[16],controlbox_toggle:arguments[17],field:arguments[18],form_captcha:arguments[19],form_checkbox:arguments[20],form_input:arguments[21],form_select:arguments[22],form_textarea:arguments[23],form_username:arguments[24],group_header:arguments[25],info:arguments[26],login_panel:arguments[27],login_tab:arguments[28],message:arguments[29],new_day:arguments[30],occupant:arguments[31],pending_contact:arguments[32],pending_contacts:arguments[33],register_panel:arguments[34],register_tab:arguments[35],registration_form:arguments[36],registration_request:arguments[37],requesting_contact:arguments[38],requesting_contacts:arguments[39],room_description:arguments[40],room_item:arguments[41],room_panel:arguments[42],roster:arguments[43],roster_item:arguments[44],search_contact:arguments[45],select_option:arguments[46],status_option:arguments[47],toggle_chats:arguments[48],toolbar:arguments[49],toolbar_otr:arguments[50],trimmed_chat:arguments[51],vcard:arguments[52]}}),function(e,t){define("utils",["jquery","jquery.browser","underscore","converse-templates"],t)}(this,function(e,t,n,r){"use strict";var i={"text-private":"password","text-single":"text",fixed:"label","boolean":"checkbox",hidden:"hidden","jid-multi":"textarea","list-single":"dropdown","list-multi":"dropdown"};e.expr[":"].emptyVal=function(e){return e.value===""},e.fn.hasScrollBar=function(){return e.contains(document,this.get(0))?this.parent().height()<this.get(0).scrollHeight?!0:!1:!1},e.fn.addHyperlinks=function(){return this.length>0&&this.each(function(t,n){var r=e(n).html(),i=r.match(/\b(https?:\/\/|www\.|https?:\/\/www\.)[^\s<]{2,200}\b/g);if(i)for(t=0;t<i.length;t++){var s=i[t].indexOf("http://")===0||i[t].indexOf("https://")===0?"":"http://",o=encodeURI(decodeURI(i[t])).replace(/[!'()]/g,escape).replace(/\*/g,"%2A");r=r.replace(i[t],'<a target="_blank" rel="noopener" href="'+s+o+'">'+i[t]+"</a>")}e(n).html(r)}),this},e.fn.addEmoticons=function(t){return t&&this.length>0&&this.each(function(t,n){var r=e(n).html();r=r.replace(/&gt;:\)/g,'<span class="emoticon icon-evil"></span>'),r=r.replace(/:\)/g,'<span class="emoticon icon-smiley"></span>'),r=r.replace(/:\-\)/g,'<span class="emoticon icon-smiley"></span>'),r=r.replace(/;\)/g,'<span class="emoticon icon-wink"></span>'),r=r.replace(/;\-\)/g,'<span class="emoticon icon-wink"></span>'),r=r.replace(/:D/g,'<span class="emoticon icon-grin"></span>'),r=r.replace(/:\-D/g,'<span class="emoticon icon-grin"></span>'),r=r.replace(/:P/g,'<span class="emoticon icon-tongue"></span>'),r=r.replace(/:\-P/g,'<span class="emoticon icon-tongue"></span>'),r=r.replace(/:p/g,'<span class="emoticon icon-tongue"></span>'),r=r.replace(/:\-p/g,'<span class="emoticon icon-tongue"></span>'),r=r.replace(/8\)/g,'<span class="emoticon icon-cool"></span>'),r=r.replace(/:S/g,'<span class="emoticon icon-confused"></span>'),r=r.replace(/:\\/g,'<span class="emoticon icon-wondering"></span>'),r=r.replace(/:\/ /g,'<span class="emoticon icon-wondering"></span>'),r=r.replace(/&gt;:\(/g,'<span class="emoticon icon-angry"></span>'),r=r.replace(/:\(/g,'<span class="emoticon icon-sad"></span>'),r=r.replace(/:\-\(/g,'<span class="emoticon icon-sad"></span>'),r=r.replace(/:O/g,'<span class="emoticon icon-shocked"></span>'),r=r.replace(/:\-O/g,'<span class="emoticon icon-shocked"></span>'),r=r.replace(/\=\-O/g,'<span class="emoticon icon-shocked"></span>'),r=r.replace(/\(\^.\^\)b/g,'<span class="emoticon icon-thumbs-up"></span>'),r=r.replace(/&lt;3/g,'<span class="emoticon icon-heart"></span>'),e(n).html(r)}),this};var s={__:function(t){if(typeof Jed=="undefined")return t;typeof this.i18n=="undefined"&&(this.i18n=locales.en),typeof this.i18n=="string"&&(this.i18n=e.parseJSON(this.i18n)),typeof this.jed=="undefined"&&(this.jed=new Jed(this.i18n));var n=this.jed.translate(t);return arguments.length>1?n.fetch.apply(n,[].slice.call(arguments,1)):n.fetch()},___:function(e){return e},refreshWebkit:function(){if(e.browser.webkit){var t=document.getElementById("conversejs");t.style.display="none";var n=t.offsetHeight;t.style.display="block"}},webForm2xForm:function(t){var n=e(t),i;if(n.is("[type=checkbox]"))i=n.is(":checked")&&1||0;else if(n.is("textarea")){i=[];var s=n.val().split("\n");for(var o=0;o<s.length;o++){var u=e.trim(s[o]);if(u==="")continue;i.push(u)}}else i=n.val();return e(r.field({name:n.attr("name"),value:i}))[0]},contains:function(e,t){return function(r){if(typeof e=="object"){var i=!1;return n.each(e,function(e){i=i||r.get(e).toLowerCase().indexOf(t.toLowerCase())!==-1}),i}if(typeof e=="string")return r.get(e).toLowerCase().indexOf(t.toLowerCase())!==-1;throw new TypeError("contains: wrong attribute type. Must be string or array.")}},xForm2webForm:function(t,s){var o=[],u,a,f,l,c;if(t.attr("type")==="list-single"||t.attr("type")==="list-multi"){c=[],f=t.children("value");for(u=0;u<f.length;u++)c.push(e(f[u]).text());a=t.children("option");for(u=0;u<a.length;u++)l=e(a[u]).find("value").text(),o.push(r.select_option({value:l,label:e(a[u]).attr("label"),selected:c.indexOf(l)>=0,required:t.find("required").length}));return r.form_select({name:t.attr("var"),label:t.attr("label"),options:o.join(""),multiple:t.attr("type")==="list-multi",required:t.find("required").length})}if(t.attr("type")==="fixed")return e('<p class="form-help">').text(t.find("value").text());if(t.attr("type")==="jid-multi")return r.form_textarea({name:t.attr("var"),label:t.attr("label")||"",value:t.find("value").text(),required:t.find("required").length});if(t.attr("type")==="boolean")return r.form_checkbox({name:t.attr("var"),type:i[t.attr("type")],label:t.attr("label")||"",checked:t.find("value").text()==="1"&&'checked="1"'||"",required:t.find("required").length});if(t.attr("type")&&t.attr("var")==="username")return r.form_username({domain:" @"+this.domain,name:t.attr("var"),type:i[t.attr("type")],label:t.attr("label")||"",value:t.find("value").text(),required:t.find("required").length});if(t.attr("type"))return r.form_input({name:t.attr("var"),type:i[t.attr("type")],label:t.attr("label")||"",value:t.find("value").text(),required:t.find("required").length});if(t.attr("var")==="ocr")return n.reduce(n.map(t.find("uri"),e.proxy(function(e){return r.form_captcha({label:this.$field.attr("label"),name:this.$field.attr("var"),data:this.$stanza.find('data[cid="'+e.textContent.replace(/^cid:/,"")+'"]').text(),type:e.getAttribute("type"),required:this.$field.find("required").length})},{$stanza:s,$field:t})),function(e,t){return e+t},"")}};return s.contains.not=function(e,t){return function(n){return!s.contains(e,t)(n)}},s}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();if(t===undefined||t>n.length)t=n.length;t-=e.length;var r=n.indexOf(e,t);return r!==-1&&r===t}),String.prototype.splitOnce=function(e){var t=this.split(e);return[t.shift(),t.join(e)]},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),define("polyfill",function(){}),function(e,t){define("converse-core",["jquery","underscore","polyfill","utils","moment_with_locales","strophe","converse-templates","strophe.disco","backbone.browserStorage","backbone.overview"],t)}(this,function(e,t,n,r,i,s,o){var u=s.$build,a=s.$iq,f=s.$pres,l=s.SHA1.b64_sha1;s=s.Strophe,t.templateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g};var c={},h={plugins:{},initialized_plugins:[],templates:o,emit:function(t,n){e(c).trigger(t,n)},once:function(t,n){e(c).one(t,n)},on:function(t,n){e(c).bind(t,n)},off:function(t,n){e(c).unbind(t,n)}};h.STATUS_WEIGHTS={offline:6,unavailable:5,xa:4,away:3,dnd:2,chat:1,online:1},h.LOGIN="login",h.ANONYMOUS="anonymous",h.PREBIND="prebind",h.OPENED="opened",h.CLOSED="closed";var p={0:"ERROR",1:"CONNECTING",2:"CONNFAIL",3:"AUTHENTICATING",4:"AUTHFAIL",5:"CONNECTED",6:"DISCONNECTED",7:"DISCONNECTING",8:"ATTACHED",9:"REDIRECT"};return h.log=function(e,t){var n;typeof console=="undefined"||typeof console.log=="undefined"?n={log:function(){},error:function(){}}:n=console,h.debug&&(t==="error"?n.log("ERROR: "+e):n.log(e))},h.initialize=function(n,o){"use strict";var c=this,h;"onpagehide"in window?h="pagehide":"onbeforeunload"in window?h="beforeunload":"onunload"in window&&(h="unload"),s.log=function(e,t){c.log(e+" "+t,e)},s.error=function(e){c.log(e,"error")},s.addNamespace("CARBONS","urn:xmpp:carbons:2"),s.addNamespace("CHATSTATES","http://jabber.org/protocol/chatstates"),s.addNamespace("CSI","urn:xmpp:csi:0"),s.addNamespace("ROSTERX","http://jabber.org/protocol/rosterx"),s.addNamespace("XFORM","jabber:x:data"),s.addNamespace("NICK","http://jabber.org/protocol/nick"),this.TIMEOUTS={PAUSED:2e4,INACTIVE:9e4},this.INACTIVE="inactive",this.ACTIVE="active",this.COMPOSING="composing",this.PAUSED="paused",this.GONE="gone",this.isConverseLocale=function(e){return typeof locales[e]!="undefined"},this.isMomentLocale=function(e){return i.locale()!==i.locale(e)},this.user_settings=n,this.wrappedChatBox=function(e){if(!e)return;var t=c.chatboxviews.get(e.get("jid"));return{close:t.close.bind(t),focus:t.focus.bind(t),get:e.get.bind(e),open:t.show.bind(t),set:e.set.bind(e)}},this.isLocaleAvailable=function(e,t){if(t(e))return e;var n=e.split("-")[0];if(n!==e&&t(n))return n},this.detectLocale=function(e){var t,n;window.navigator.userLanguage&&(t=this.isLocaleAvailable(window.navigator.userLanguage,e));if(window.navigator.languages&&!t)for(n=0;n<window.navigator.languages.length&&!t;n++)t=this.isLocaleAvailable(window.navigator.languages[n],e);return window.navigator.browserLanguage&&!t&&(t=this.isLocaleAvailable(window.navigator.browserLanguage,e)),window.navigator.language&&!t&&(t=this.isLocaleAvailable(window.navigator.language,e)),window.navigator.systemLanguage&&!t&&(t=this.isLocaleAvailable(window.navigator.systemLanguage,e)),t||"en"},i.locale||(i.locale=i.lang),i.locale(this.detectLocale(this.isMomentLocale)),this.i18n=n.i18n?n.i18n:locales[this.detectLocale(this.isConverseLocale)];var d=r.__.bind(this);this.default_settings={allow_contact_requests:!0,allow_dragresize:!0,animate:!0,authentication:"login",auto_away:0,auto_login:!1,auto_reconnect:!1,auto_subscribe:!1,auto_xa:0,bosh_service_url:undefined,csi_waiting_time:0,debug:!1,expose_rid_and_sid:!1,forward_messages:!1,hide_offline_users:!1,include_offline_state:!1,jid:undefined,keepalive:!1,locked_domain:undefined,message_carbons:!1,password:undefined,prebind:!1,prebind_url:null,rid:undefined,roster_groups:!1,show_only_online_users:!1,sid:undefined,storage:"session",strict_plugin_dependencies:!1,synchronize_availability:!0,visible_toolbar_buttons:{emoticons:!0,call:!1,clear:!0,toggle_occupants:!0},websocket_url:undefined,xhr_custom_status:!1,xhr_custom_status_url:""},t.extend(this,this.default_settings),t.extend(this,t.pick(n,Object.keys(this.default_settings))),this.prebind===!0&&(this.authentication=c.PREBIND);if(this.authentication===c.ANONYMOUS&&!this.jid)throw"Config Error: you need to provide the server's domain via the 'jid' option when using anonymous authentication.";n.visible_toolbar_buttons&&t.extend(this.visible_toolbar_buttons,t.pick(n.visible_toolbar_buttons,["emoticons","call","clear","toggle_occupants"])),e.fx.off=!this.animate,this.callback=o||function(){},this.send_initial_presence=!0,this.msg_counter=0,this.reconnectTimeout=undefined,this.generateResource=function(){return"/converse.js-"+Math.floor(Math.random()*139749825).toString()},this.sendCSI=function(e){if(c.features[s.NS.CSI]||!0)c.connection.send(u(e,{xmlns:s.NS.CSI})),this.inactive=e===c.INACTIVE?!0:!1},this.onUserActivity=function(){this.idle_seconds>0&&(this.idle_seconds=0);if(!c.connection.authenticated)return;this.inactive&&this.sendCSI(c.ACTIVE),this.auto_changed_status===!0&&(this.auto_changed_status=!1,this.xmppstatus.setStatus("online"))},this.onEverySecond=function(){if(!c.connection.authenticated)return;var e=this.xmppstatus.getStatus();this.idle_seconds++,this.csi_waiting_time>0&&this.idle_seconds>this.csi_waiting_time&&!this.inactive&&this.sendCSI(c.INACTIVE),this.auto_away>0&&this.idle_seconds>this.auto_away&&e!=="away"&&e!=="xa"?(this.auto_changed_status=!0,this.xmppstatus.setStatus("away")):this.auto_xa>0&&this.idle_seconds>this.auto_xa&&e!=="xa"&&(this.auto_changed_status=!0,this.xmppstatus.setStatus("xa"))},this.registerIntervalHandler=function(){if(this.auto_away<1&&this.auto_xa<1&&this.csi_waiting_time<1)return;this.idle_seconds=0,this.auto_changed_status=!1,e(window).on("click mousemove keypress focus"+h,this.onUserActivity.bind(this)),window.setInterval(this.onEverySecond.bind(this),1e3)},this.giveFeedback=function(t,n){e(".conn-feedback").each(function(r,i){var s=e(i);s.addClass("conn-feedback").text(t),n?s.addClass(n):s.removeClass("error")})},this.rejectPresenceSubscription=function(e,t){var n=f({to:e,type:"unsubscribed"});t&&t!==""&&n.c("status").t(t),c.connection.send(n)},this.reconnect=function(e){this.connection.disconnect("re-connecting"),this.connection.reset(),c.log("Attempting to reconnect in 5 seconds"),c.giveFeedback(d("Attempting to reconnect in 5 seconds"),"error"),window.clearTimeout(c.reconnectTimeout),c.reconnectTimeout=window.setTimeout(function(){c.authentication!=="prebind"?this.connection.connect(this.connection.jid,this.connection.pass,function(e,t){this.onConnectStatusChanged(e,t,!0)}.bind(this),this.connection.wait,this.connection.hold,this.connection.route):c.prebind_url&&(this.clearSession(),this._tearDown(),this.startNewBOSHSession())}.bind(this),5e3)},this.onConnectStatusChanged=function(e,t,n){c.log("Status changed to: "+p[e]),e===s.Status.CONNECTED||e===s.Status.ATTACHED?(c.send_initial_presence=!0,delete c.disconnection_cause,!c.reconnectTimeout||(window.clearTimeout(c.reconnectTimeout),delete c.reconnectTimeout),typeof n!="undefined"&&n?(c.log(e===s.Status.CONNECTED?"Reconnected":"Reattached"),c.onReconnected()):(c.log(e===s.Status.CONNECTED?"Connected":"Attached"),c.connection.restored&&(c.send_initial_presence=!1),c.onConnected())):e===s.Status.DISCONNECTED?c.disconnection_cause===s.Status.CONNFAIL&&c.auto_reconnect?c.reconnect(t):c.renderLoginPanel():e===s.Status.ERROR?c.giveFeedback(d("Error"),"error"):e===s.Status.CONNECTING?c.giveFeedback(d("Connecting")):e===s.Status.AUTHENTICATING?c.giveFeedback(d("Authenticating")):e===s.Status.AUTHFAIL?(c.giveFeedback(d("Authentication Failed"),"error"),c.connection.disconnect(d("Authentication Failed")),c.disconnection_cause=s.Status.AUTHFAIL):e===s.Status.CONNFAIL?c.disconnection_cause=s.Status.CONNFAIL:e===s.Status.DISCONNECTING&&(c.connection.connected||c.renderLoginPanel(),t&&c.giveFeedback(t,"error"))},this.applyDragResistance=function(e,t){if(typeof e=="undefined")return undefined;if(typeof t=="undefined")return e;var n=10;return e!==t&&Math.abs(e-t)<n?t:e},this.updateMsgCounter=function(){this.msg_counter>0?(document.title.search(/^Messages \(\d+\) /)===-1?document.title="Messages ("+this.msg_counter+") "+document.title:document.title=document.title.replace(/^Messages \(\d+\) /,"Messages ("+this.msg_counter+") "),window.blur(),window.focus()):document.title.search(/^Messages \(\d+\) /)!==-1&&(document.title=document.title.replace(/^Messages \(\d+\) /,""))},this.incrementMsgCounter=function(){this.msg_counter+=1,this.updateMsgCounter()},this.clearMsgCounter=function(){this.msg_counter=0,this.updateMsgCounter()},this.initStatus=function(){var t=new e.Deferred;this.xmppstatus=new this.XMPPStatus;var n=l("converse.xmppstatus-"+c.bare_jid);return this.xmppstatus.id=n,this.xmppstatus.browserStorage=new Backbone.BrowserStorage[c.storage](n),this.xmppstatus.fetch({success:t.resolve,error:t.resolve}),c.emit("statusInitialized"),t.promise()},this.initSession=function(){this.session=new this.Session;var e=l("converse.bosh-session");this.session.id=e,this.session.browserStorage=new Backbone.BrowserStorage[c.storage](e),this.session.fetch()},this.clearSession=function(){this.roster&&this.roster.browserStorage._clear(),this.session.browserStorage._clear()},this.logOut=function(){c.auto_login=!1,c.chatboxviews.closeAllChatBoxes(),c.clearSession(),c.connection.disconnect()},this.registerGlobalEventHandlers=function(){e(document).on("mousemove",function(e){if(!this.resizing||!this.allow_dragresize)return!0;e.preventDefault(),this.resizing.chatbox.resizeChatBox(e)}.bind(this)),e(document).on("mouseup",function(e){if(!this.resizing||!this.allow_dragresize)return!0;e.preventDefault();var t=this.applyDragResistance(this.resizing.chatbox.height,this.resizing.chatbox.model.get("default_height")),n=this.applyDragResistance(this.resizing.chatbox.width,this.resizing.chatbox.model.get("default_width"));this.connection.connected?(this.resizing.chatbox.model.save({height:t}),this.resizing.chatbox.model.save({width:n})):(this.resizing.chatbox.model.set({height:t}),this.resizing.chatbox.model.set({width:n})),this.resizing=null}.bind(this)),e(window).on("blur focus",function(e){c.windowState!==e.type&&e.type==="focus"&&c.clearMsgCounter(),c.windowState=e.type})},this.afterReconnected=function(){this.chatboxes.registerMessageHandler(),this.xmppstatus.sendPresence(),this.giveFeedback(d("Contacts"))},this.onReconnected=function(){var t=new e.Deferred;return this.initStatus().done(function(){this.afterReconnected(),t.resolve()}.bind(this)),t.promise()},this.enableCarbons=function(){if(!this.message_carbons||this.session.get("carbons_enabled"))return;var t=(new s.Builder("iq",{from:this.connection.jid,id:"enablecarbons",type:"set"})).c("enable",{xmlns:s.NS.CARBONS});this.connection.addHandler(function(t){e(t).find("error").length>0?c.log("ERROR: An error occured while trying to enable message carbons."):(this.session.save({carbons_enabled:!0}),c.log("Message carbons have been enabled."))}.bind(this),null,"iq",null,"enablecarbons"),this.connection.send(t)},this.onStatusInitialized=function(e){this.registerIntervalHandler(),this.roster=new this.RosterContacts,this.roster.browserStorage=new Backbone.BrowserStorage[this.storage](l("converse.contacts-"+this.bare_jid)),this.chatboxes.onConnected(),this.giveFeedback(d("Contacts")),typeof this.callback=="function"&&(this.connection.service==="jasmine tests"?this.callback(this):this.callback()),e.resolve(),c.emit("initialized")},this.onConnected=function(n){var r=new e.Deferred;return this.chatboxviews.closeAllChatBoxes(),this.jid=this.connection.jid,this.bare_jid=s.getBareJidFromJid(this.connection.jid),this.resource=s.getResourceFromJid(this.connection.jid),this.domain=s.getDomainFromJid(this.connection.jid),this.features=new this.Features,this.enableCarbons(),this.initStatus().done(t.bind(this.onStatusInitialized,this,r)),c.emit("connected"),c.emit("ready"),r.promise()},this.RosterContact=Backbone.Model.extend({initialize:function(e,n){var r=e.jid,i=s.getBareJidFromJid(r),o=s.getResourceFromJid(r);e.jid=i,this.set(t.extend({id:i,jid:i,fullname:i,chat_status:"offline",user_id:s.getNodeFromJid(r),resources:o?[o]:[],groups:[],image_type:"image/png",image:"iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAIAAABt+uBvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gwHCy455JBsggAABkJJREFUeNrtnM1PE1sUwHvvTD8otWLHST/Gimi1CEgr6M6FEWuIBo2pujDVsNDEP8GN/4MbN7oxrlipG2OCgZgYlxAbkRYw1KqkIDRCSkM7nXvvW8x7vjyNeQ9m7p1p3z1LQk/v/Dhz7vkEXL161cHl9wI5Ag6IA+KAOCAOiAPigDggLhwQB2S+iNZ+PcYY/SWEEP2HAAAIoSAIoihCCP+ngDDGtVotGAz29/cfOXJEUZSOjg6n06lp2sbGRqlUWlhYyGazS0tLbrdbEASrzgksyeYJId3d3el0uqenRxRFAAAA4KdfIIRgjD9+/Pj8+fOpqSndslofEIQwHA6Pjo4mEon//qmFhYXHjx8vLi4ihBgDEnp7e9l8E0Jo165dQ0NDd+/eDYVC2/qsJElDQ0OEkKWlpa2tLZamxAhQo9EIBoOjo6MXL17csZLe3l5FUT59+lQul5l5JRaAVFWNRqN37tw5ceKEQVWRSOTw4cOFQuHbt2+iKLYCIISQLMu3b99OJpOmKAwEAgcPHszn8+vr6wzsiG6UQQhxuVyXLl0aGBgwUW0sFstkMl6v90fo1KyAMMYDAwPnzp0zXfPg4GAqlWo0Gk0MiBAiy/L58+edTqf5Aa4onj59OhaLYYybFRCEMBaL0fNxBw4cSCQStN0QRUBut3t4eJjq6U+dOiVJElVPRBFQIBDo6+ujCqirqyscDlONGykC2lYyYSR6pBoQQapHZwAoHo/TuARYAOrs7GQASFEUqn6aIiBJkhgA6ujooFpUo6iaTa7koFwnaoWadLNe81tbWwzoaJrWrICWl5cZAFpbW6OabVAEtLi4yABQsVjUNK0pAWWzWQaAcrlcswKanZ1VVZUqHYRQEwOq1Wpv3ryhCmh6erpcLjdrNl+v1ycnJ+l5UELI27dvv3//3qxxEADgy5cvExMT9Mznw4cPtFtAdAPFarU6Pj5eKpVM17yxsfHy5cvV1VXazXu62gVBKBQKT58+rdVqJqrFGL948eLdu3dU8/g/H4FBUaJYLAqC0NPTY9brMD4+PjY25mDSracOCABACJmZmXE6nUePHjWu8NWrV48ePSKEsGlAs7Agfd5nenq6Wq0mk0kjDzY2NvbkyRMIIbP2PLvhBUEQ8vl8NpuNx+M+n29bzhVjvLKycv/+/YmJCcazQuwA6YzW1tYmJyf1SY+2trZ/rRk1Go1SqfT69esHDx4UCgVmNaa/zZ/9ABUhRFXVYDB48uTJeDweiUQkSfL7/T9MA2NcqVTK5fLy8vL8/PzU1FSxWHS5XJaM4wGr9sUwxqqqer3eUCgkSZJuUBBCfTRvc3OzXC6vrKxUKhWn02nhCJ5lM4oQQo/HgxD6+vXr58+fHf8sDOp+HQDg8XgclorFU676dKLlo6yWRdItIBwQB8QBcUCtfosRQjRNQwhhjPUC4w46WXryBSHU1zgEQWBz99EFhDGu1+t+v//48ePxeFxRlD179ng8nh0Efgiher2+vr6ur3HMzMysrq7uTJVdACGEurq6Ll++nEgkPB7Pj9jPoDHqOxyqqubz+WfPnuVyuV9XPeyeagAAAoHArVu3BgcHab8CuVzu4cOHpVKJUnfA5GweY+xyuc6cOXPv3r1IJMLAR8iyPDw8XK/Xi8Wiqqqmm5KZgBBC7e3tN27cuHbtGuPVpf7+/lAoNDs7W61WzfVKpgHSSzw3b95MpVKW3MfRaDQSiczNzVUqFRMZmQOIEOL1eq9fv3727FlL1t50URRFluX5+flqtWpWEGAOIFEUU6nUlStXLKSjy759+xwOx9zcnKZpphzGHMzhcDiTydgk9r1w4YIp7RPTAAmCkMlk2FeLf/tIEKbTab/fbwtAhJBoNGrutpNx6e7uPnTokC1eMU3T0um0DZPMkZER6wERQnw+n/FFSxpy7Nix3bt3WwwIIcRgIWnHkkwmjecfRgGx7DtuV/r6+iwGhDHev3+/bQF1dnYaH6E2CkiWZdsC2rt3r8WAHA5HW1ubbQGZcjajgOwTH/4qNko1Wlg4IA6IA+KAOKBWBUQIsfNojyliKIoRRfH9+/dut9umf3wzpoUNNQ4BAJubmwz+ic+OxefzWWlBhJD29nbug7iT5sIBcUAcEAfEAXFAHBAHxOVn+QMrmWpuPZx12gAAAABJRU5ErkJggg==",status:""},e)),this.on("destroy",function(){this.removeFromRoster()}.bind(this)),this.on("change:chat_status",function(e){c.emit("contactStatusChanged",e.attributes)})},subscribe:function(e){this.save("ask","subscribe");var t=f({to:this.get("jid"),type:"subscribe"});e&&e!==""&&t.c("status").t(e).up();var n=c.xmppstatus.get("fullname");return n&&n!==""&&t.c("nick",{xmlns:s.NS.NICK}).t(n).up(),c.connection.send(t),this},ackSubscribe:function(){c.connection.send(f({type:"subscribe",to:this.get("jid")}))},ackUnsubscribe:function(e){c.connection.send(f({type:"unsubscribe",to:this.get("jid")})),this.destroy()},unauthorize:function(e){return c.rejectPresenceSubscription(this.get("jid"),e),this},authorize:function(e){var t=f({to:this.get("jid"),type:"subscribed"});return e&&e!==""&&t.c("status").t(e),c.connection.send(t),this},removeResource:function(e){var n=this.get("resources"),r;return e?(r=t.indexOf(n,e),r!==-1&&(n.splice(r,1),this.save({resources:n})),n.length):(this.save({resources:[]}),0)},removeFromRoster:function(e){var t=a({type:"set"}).c("query",{xmlns:s.NS.ROSTER}).c("item",{jid:this.get("jid"),subscription:"remove"});return c.connection.sendIQ(t,e,e),this},showInRoster:function(){var e=this.get("chat_status");return c.show_only_online_users&&e!=="online"||c.hide_offline_users&&e==="offline"?this.get("ask")==="subscribe"||this.get("subscription")==="from"||this.get("requesting")===!0?!0:!1:!0}}),this.RosterContacts=Backbone.Collection.extend({model:c.RosterContact,comparator:function(e,t){var n,r,i=e.get("chat_status")||"offline",s=t.get("chat_status")||"offline";return c.STATUS_WEIGHTS[i]===c.STATUS_WEIGHTS[s]?(n=e.get("fullname").toLowerCase(),r=t.get("fullname").toLowerCase(),n<r?-1:n>r?1:0):c.STATUS_WEIGHTS[i]<c.STATUS_WEIGHTS[s]?-1:1},subscribeToSuggestedItems:function(t){return e(t).find("item").each(function(e,t){this.getAttribute("action")==="add"&&c.roster.addAndSubscribe(this.getAttribute("jid"),null,c.xmppstatus.get("fullname"))}),!0},isSelf:function(e){return s.getBareJidFromJid(e)===s.getBareJidFromJid(c.connection.jid)},addAndSubscribe:function(e,t,n,r,i){this.addContact(e,t,n,i).done(function(e){e instanceof c.RosterContact&&e.subscribe(r)})},sendContactAddIQ:function(e,n,r,i,o){n=t.isEmpty(n)?e:n;var u=a({type:"set"}).c("query",{xmlns:s.NS.ROSTER}).c("item",{jid:e,name:n});t.map(r,function(e){u.c("group").t(e).up()}),c.connection.sendIQ(u,i,o)},addContact:function(n,r,i,s){var o=new e.Deferred;return i=i||[],r=t.isEmpty(r)?n:r,this.sendContactAddIQ(n,r,i,function(e){var u=this.create(t.extend({ask:undefined,fullname:r,groups:i,jid:n,requesting:!1,subscription:"none"},s),{sort:!1});o.resolve(u)}.bind(this),function(e){alert(d("Sorry, there was an error while trying to add "+r+" as a contact.")),c.log(e),o.resolve(e)}),o.promise()},addResource:function(e,n){var r=this.get(e),i;r&&(i=r.get("resources"),i?t.indexOf(i,n)===-1&&(i.push(n),r.set({resources:i})):r.set({resources:[n]}))},subscribeBack:function(e){var t=this.get(e);t instanceof c.RosterContact?t.authorize().subscribe():this.addContact(e,"",[],{subscription:"from"}).done(function(e){e instanceof c.RosterContact&&e.authorize().subscribe()})},getNumOnlineContacts:function(){var e=0,n=["offline","unavailable"],r=this.models,i=r.length,s;c.show_only_online_users&&(n=t.union(n,["dnd","xa","away"]));for(s=0;s<i;s++)t.indexOf(n,r[s].get("chat_status"))===-1&&e++;return e},onRosterPush:function(t){var n=t.getAttribute("id"),r=t.getAttribute("from");return r&&r!==""&&s.getBareJidFromJid(r)!==c.bare_jid?(c.connection.send(a({type:"error",id:n,from:c.connection.jid}).c("error",{type:"cancel"}).c("service-unavailable",{xmlns:s.NS.ROSTER})),!0):(c.connection.send(a({type:"result",id:n,from:c.connection.jid})),e(t).children("query").find("item").each(function(e,t){this.updateContact(t)}.bind(this)),c.emit("rosterPush",t),!0)},fetchFromServer:function(e){var t=a({type:"get",id:c.connection.getUniqueId("roster")}).c("query",{xmlns:s.NS.ROSTER});return c.connection.sendIQ(t,function(){this.onReceivedFromServer.apply(this,arguments),e.apply(this,arguments)}.bind(this))},onReceivedFromServer:function(t){c.emit("roster",t),e(t).children("query").find("item").each(function(e,t){this.updateContact(t)}.bind(this))},updateContact:function(t){var n=t.getAttribute("jid");if(this.isSelf(n))return;var r=[],i=this.get(n),o=t.getAttribute("ask"),u=t.getAttribute("subscription");e.map(t.getElementsByTagName("group"),function(e){r.push(s.getText(e))});if(!i){if(u==="none"&&o===null||u==="remove")return;this.create({ask:o,fullname:t.getAttribute("name")||n,groups:r,jid:n,subscription:u},{sort:!1})}else{if(u==="remove")return i.destroy();i.save({subscription:u,ask:o,requesting:null,groups:r})}},createRequestingContact:function(t){var n=s.getBareJidFromJid(t.getAttribute("from")),r=e(t).children("nick[xmlns="+s.NS.NICK+"]").text(),i={jid:n,subscription:"none",ask:null,requesting:!0,fullname:r||n};this.create(i),c.emit("contactRequest",i)},handleIncomingSubscription:function(e){var t=e.getAttribute("from"),n=s.getBareJidFromJid(t),r=this.get(n);c.allow_contact_requests||c.rejectPresenceSubscription(t,d("This client does not allow presence subscriptions")),c.auto_subscribe?!r||r.get("subscription")!=="to"?this.subscribeBack(n):r.authorize():r?r.get("subscription")!=="none"?r.authorize():r.get("ask")==="subscribe"&&r.authorize():r||this.createRequestingContact(e)},presenceHandler:function(t){var n=e(t),r=t.getAttribute("type");if(r==="error")return!0;var i=t.getAttribute("from"),o=s.getBareJidFromJid(i),u=s.getResourceFromJid(i),a=n.find("show").text()||"online",f=n.find("status"),l=this.get(o);if(this.isSelf(o)){c.connection.jid!==i&&r!=="unavailable"&&(c.synchronize_availability===!0||c.synchronize_availability===u)&&(c.xmppstatus.save({status:a}),f.length&&c.xmppstatus.save({status_message:f.text()}));return}if((n.find("x").attr("xmlns")||"").indexOf(s.NS.MUC)===0)return;l&&f.text()!==l.get("status")&&l.save({status:f.text()});if(r==="subscribed"&&l)l.ackSubscribe();else if(r==="unsubscribed"&&l)l.ackUnsubscribe();else{if(r==="unsubscribe")return;r==="subscribe"?this.handleIncomingSubscription(t):r==="unavailable"&&l?l.removeResource(u)===0&&l.save({chat_status:"offline"}):l&&(this.addResource(o,u),l.save({chat_status:a}))}}}),this.Message=Backbone.Model.extend({idAttribute:"msgid",defaults:function(){return{msgid:c.connection.getUniqueId()}}}),this.Messages=Backbone.Collection.extend({model:c.Message,comparator:"time"}),this.ChatBox=Backbone.Model.extend({initialize:function(){this.messages=new c.Messages,this.messages.browserStorage=new Backbone.BrowserStorage[c.storage](l("converse.messages"+this.get("jid")+c.bare_jid)),this.save(t.extend(this.getDefaultSettings(),{chat_state:undefined,box_id:l(this.get("jid")),time_opened:this.get("time_opened")||i().valueOf(),url:"",user_id:s.getNodeFromJid(this.get("jid"))}))},getDefaultSettings:function(){var e=this.get("height"),t=this.get("width");return{height:c.applyDragResistance(e,this.get("default_height")),width:c.applyDragResistance(t,this.get("default_width")),num_unread:this.get("num_unread")||0}},createMessage:function(e,n){n=n||e.find("delay");var r=e.children("body").text(),o=n.length>0,u=this.get("fullname"),a=e.attr("type")==="groupchat",f=e.attr("id"),l=e.find(c.COMPOSING).length&&c.COMPOSING||e.find(c.PAUSED).length&&c.PAUSED||e.find(c.INACTIVE).length&&c.INACTIVE||e.find(c.ACTIVE).length&&c.ACTIVE||e.find(c.GONE).length&&c.GONE,h,p,d,v;return a?v=s.unescapeNode(s.getResourceFromJid(e.attr("from"))):v=s.getBareJidFromJid(e.attr("from")),u=(t.isEmpty(u)?v:u).split(" ")[0],o?(h=n.attr("stamp"),p=h):p=i().format(),a&&v===this.get("nick")||!a&&v===c.bare_jid?d="me":d="them",this.messages.create({chat_state:l,delayed:o,fullname:u,message:r||undefined,msgid:f,sender:d,time:p})}}),this.ChatBoxes=Backbone.Collection.extend({model:c.ChatBox,comparator:"time_opened",registerMessageHandler:function(){c.connection.addHandler(function(e){return this.onMessage(e),!0}.bind(this),null,"message","chat")},chatBoxShouldBeShown:function(e){return!0},onChatBoxesFetched:function(e){e.each(function(e){this.chatBoxShouldBeShown(e)&&e.trigger("show")}.bind(this))},onConnected:function(){this.browserStorage=new Backbone.BrowserStorage[c.storage](l("converse.chatboxes-"+c.bare_jid)),this.registerMessageHandler(),this.fetch({add:!0,success:this.onChatBoxesFetched.bind(this)})},onMessage:function(t){var n=e(t),r,i,o,u,a,f,l,h,p,d=n.attr("from"),v=n.attr("to"),m=s.getResourceFromJid(v);return m&&m!==c.resource?(c.log("Ignore incoming message intended for a different resource: "+v,"info"),!0):d===c.connection.jid?(c.log("Ignore incoming message sent from this client's JID: "+d,"info"),!0):(i=n.find("forwarded"),i.length&&(n=i.children("message"),o=i.children("delay"),d=n.attr("from"),v=n.attr("to")),u=s.getBareJidFromJid(d),a=s.getResourceFromJid(d),f=u===c.bare_jid,l=n.attr("id"),f?(r=s.getBareJidFromJid(v),p=s.getResourceFromJid(v)):(r=u,p=a),h=this.getChatBox(r,n.find("body").length>0),h?l&&h.messages.findWhere({msgid:l})?!0:(h.createMessage(n,o),c.roster.addResource(r,p),c.emit("message",t),!0):!0)},getChatBox:function(e,n){e=e.toLowerCase();var r=s.getBareJidFromJid(e),i=this.get(r);if(!i&&n){var o=c.roster.get(r);if(o===undefined){c.log("Could not get roster item for JID "+r,"error");return}i=this.create({id:r,jid:r,fullname:t.isEmpty(o.get("fullname"))?e:o.get("fullname"),image_type:o.get("image_type"),image:o.get("image"),url:o.get("url")})}return i}}),this.ChatBoxViews=Backbone.Overview.extend({initialize:function(){this.model.on("add",this.onChatBoxAdded,this)},_ensureElement:function(){if(!this.el){var n=e("#conversejs");n.length||(n=e('<div id="conversejs">'),e("body").append(n)),n.html(c.templates.chats_panel()),this.setElement(n,!1)}else this.setElement(t.result(this,"el"),!1)},onChatBoxAdded:function(e){var t=this.get(e.get("id"));return t&&(delete t.model,t.model=e,t.initialize()),t},closeAllChatBoxes:function(){return this.each(function(e){e.close()}),this},showChat:function(e){var t=this.model.get(e.jid);return t||(t=this.model.create(e,{error:function(e,t){c.log(t.responseText)}})),t.trigger("show",!0),t}}),this.XMPPStatus=Backbone.Model.extend({initialize:function(){this.set({status:this.getStatus()}),this.on("change",function(e){t.has(e.changed,"status")&&c.emit("statusChanged",this.get("status")),t.has(e.changed,"status_message")&&c.emit("statusMessageChanged",this.get("status_message"))}.bind(this))},constructPresence:function(e,t){typeof e=="undefined"&&(e=this.get("status")||"online"),typeof t=="undefined"&&(t=this.get("status_message"));var n;return e==="unavailable"||e==="probe"||e==="error"||e==="unsubscribe"||e==="unsubscribed"||e==="subscribe"||e==="subscribed"?n=f({type:e}):e==="offline"?(n=f({type:"unavailable"}),t&&n.c("show").t(e)):(e==="online"?n=f():n=f().c("show").t(e).up(),t&&n.c("status").t(t)),n},sendPresence:function(e,t){c.connection.send(this.constructPresence(e,t))},setStatus:function(e){this.sendPresence(e),this.save({status:e})},getStatus:function(){return this.get("status")||"online"},setStatusMessage:function(t){this.sendPresence(this.getStatus(),t);var n=this.get("status_message");this.save({status_message:t}),this.xhr_custom_status&&e.ajax({url:this.xhr_custom_status_url,type:"POST",data:{msg:t}}),n===t&&this.trigger("update-status-ui",this)}}),this.Session=Backbone.Model,this.Feature=Backbone.Model,this.Features=Backbone.Collection.extend({model:c.Feature,initialize:function(){this.addClientIdentities().addClientFeatures(),this.browserStorage=new Backbone.BrowserStorage[c.storage](l("converse.features"+c.bare_jid)),this.on("add",this.onFeatureAdded,this),this.browserStorage.records.length===0?(c.connection.disco.info(c.domain,null,this.onInfo.bind(this)),c.connection.disco.items(c.domain,null,this.onItems.bind(this))):this.fetch({add:!0})},onFeatureAdded:function(e){c.emit("serviceDiscovered",e)},addClientIdentities:function(){return c.connection.disco.addIdentity("client","web","Converse.js"),this},addClientFeatures:function(){return c.connection.disco.addFeature(s.NS.BOSH),c.connection.disco.addFeature(s.NS.CHATSTATES),c.connection.disco.addFeature(s.NS.DISCO_INFO),c.connection.disco.addFeature(s.NS.ROSTERX),c.message_carbons&&c.connection.disco.addFeature(s.NS.CARBONS),this},onItems:function(t){e(t).find("query item").each(function(t,n){c.connection.disco.info(e(n).attr("jid"),null,this.onInfo.bind(this))}.bind(this))},onInfo:function(t){var n=e(t);if(n.find("identity[category=server][type=im]").length===0&&n.find("identity[category=conference][type=text]").length===0)return;n.find("feature").each(function(t,r){var i=e(r).attr("var");this[i]=!0,this.create({"var":i,from:n.attr("from")})}.bind(this))}}),this.setUpXMLLogging=function(){this.debug&&(this.connection.xmlInput=function(e){c.log(e)},this.connection.xmlOutput=function(e){c.log(e)})},this.startNewBOSHSession=function(){e.ajax({url:this.prebind_url,type:"GET",dataType:"json",success:function(e){this.connection.attach(e.jid,e.sid,e.rid,this.onConnectStatusChanged)}.bind(this),error:function(e){delete this.connection,this.emit("noResumeableSession")}.bind(this)})},this.attemptPreboundSession=function(e){if(this.jid&&this.sid&&this.rid)return this.connection.attach(this.jid,this.sid,this.rid,this.onConnectStatusChanged);if(!this.keepalive)throw new Error("initConnection: If you use prebind and not keepalive, then you MUST supply JID, RID and SID values");if(!this.jid)throw new Error("initConnection: when using 'keepalive' with 'prebind, you must supply the JID of the current user.");try{return this.connection.restore(this.jid,this.onConnectStatusChanged)}catch(t){this.log("Could not restore session for jid: "+this.jid+" Error message: "+t.message),this.clearSession()}this.prebind_url?this.startNewBOSHSession():(delete this.connection,this.emit("noResumeableSession"))},this.attemptNonPreboundSession=function(){if(this.keepalive)try{return this.connection.restore(undefined,this.onConnectStatusChanged)}catch(e){this.log("Could not restore session. Error message: "+e.message),this.clearSession()}if(this.auto_login){if(!this.jid)throw new Error("initConnection: If you use auto_login, you also need to provide a jid value");if(this.authentication===c.ANONYMOUS)this.connection.connect(this.jid.toLowerCase(),null,this.onConnectStatusChanged);else if(this.authentication===c.LOGIN){if(!this.password)throw new Error("initConnection: If you use auto_login and authentication='login' then you also need to provide a password.");var t=s.getResourceFromJid(this.jid);t?this.jid=s.getBareJidFromJid(this.jid).toLowerCase()+"/"+t:this.jid=this.jid.toLowerCase()+c.generateResource(),this.connection.connect(this.jid,this.password,this.onConnectStatusChanged)}}},this.initConnection=function(){if(this.connection&&this.connection.connected)this.setUpXMLLogging(),this.onConnected();else{if(!this.bosh_service_url&&!this.websocket_url)throw new Error("initConnection: you must supply a value for either the bosh_service_url or websocket_url or both.");if(("WebSocket"in window||"MozWebSocket"in window)&&this.websocket_url)this.connection=new s.Connection(this.websocket_url);else{if(!this.bosh_service_url)throw new Error("initConnection: this browser does not support websockets and bosh_service_url wasn't specified.");this.connection=new s.Connection(this.bosh_service_url,{keepalive:this.keepalive})}this.setUpXMLLogging(),this.authentication===c.PREBIND?this.attemptPreboundSession():this.attemptNonPreboundSession()}},this._tearDown=function(){return this.roster&&this.roster.off().reset(),this.chatboxes.remove(),this.features&&this.features.reset(),this},this._initialize=function(){return this.chatboxes=new this.ChatBoxes,this.chatboxviews=new this.ChatBoxViews({model:this.chatboxes}),this.initSession(),this.initConnection(),this},this.wrappedOverride=function(e,n,r){return this._super[e]=r,n.apply(this,t.rest(arguments,3))},this._overrideAttribute=function(e,n){var r=n.overrides[e];if(typeof r=="function"){var i=t.partial(c.wrappedOverride.bind(c),e,r,c[e].bind(c));c[e]=i}else c[e]=r},this._extendObject=function(e,n){e.prototype._super||(e.prototype._super={converse:c}),t.each(n,function(n,r){if(r==="events")e.prototype[r]=t.extend(n,e.prototype[r]);else if(typeof n=="function"){var i=t.partial(c.wrappedOverride,r,n,e.prototype[r]);e.prototype[r]=i}else e.prototype[r]=n})},this.initializePlugins=function(){typeof c._super=="undefined"&&(c._super={converse:c});var e=function(e){t.extend(c.default_settings,e),t.extend(c,e),t.extend(c,t.pick(c.user_settings,Object.keys(e)))};t.each(t.keys(this.plugins),function(n){var r=this.plugins[n];r.updateSettings=e;if(t.contains(this.initialized_plugins,n))return;r.converse=c,t.each(Object.keys(r.overrides||{}),function(e){var t,n=r.overrides[e];if(typeof n=="object"){if(typeof c[e]=="undefined"){t="Error: Plugin tried to override "+e+" but it's not found.";if(c.strict_plugin_dependencies)throw t;c.log(t)}this._extendObject(c[e],n)}else this._overrideAttribute(e,r)}.bind(this)),typeof r.initialize=="function"&&r.initialize.bind(r)(this),this.initialized_plugins.push(n)}.bind(this))},n.connection&&(this.connection=n.connection),this.initializePlugins(),this._initialize(),this.registerGlobalEventHandlers()},h}),function(e,t){define("converse-api",["jquery","underscore","moment_with_locales","strophe","utils","converse-core"],t)}(this,function(e,t,n,r,i,s){var o=r.Strophe;return{initialize:function(e,t){s.initialize(e,t)},disconnect:function(){s.connection.disconnect()},user:{logout:function(){s.logOut()},status:{get:function(){return s.xmppstatus.get("status")},set:function(e,n){var r={status:e};if(!t.contains(t.keys(s.STATUS_WEIGHTS),e))throw new Error("Invalid availability value. See https://xmpp.org/rfcs/rfc3921.html#rfc.section.2.2.2.1");typeof n=="string"&&(r.status_message=n),s.xmppstatus.sendPresence(e),s.xmppstatus.save(r)},message:{get:function(){return s.xmppstatus.get("status_message")},set:function(e){s.xmppstatus.save({status_message:e})}}}},settings:{get:function(e){if(t.contains(Object.keys(s.default_settings),e))return s[e]},set:function(e,n){var r={};typeof e=="object"?t.extend(s,t.pick(e,Object.keys(s.default_settings))):typeof e=="string"&&(r[e]=n,t.extend(s,t.pick(r,Object.keys(s.default_settings))))}},contacts:{get:function(e){var n=function(e){var t=s.roster.get(o.getBareJidFromJid(e));return t?t.attributes:null};if(typeof e=="undefined")e=s.roster.pluck("jid");else if(typeof e=="string")return n(e);return t.map(e,n)},add:function(e,n){if(typeof e!="string"||e.indexOf("@")<0)throw new TypeError("contacts.add: invalid jid");s.roster.addAndSubscribe(e,t.isEmpty(n)?e:n)}},chats:{open:function(e){var n;return typeof e=="undefined"?(s.log("chats.open: You need to provide at least one JID","error"),null):typeof e=="string"?(n=s.wrappedChatBox(s.chatboxes.getChatBox(e,!0)),n.open(),n):t.map(e,function(e){return n=s.wrappedChatBox(s.chatboxes.getChatBox(e,!0)),n.open(),n})},get:function(e){return typeof e=="undefined"?(s.log("chats.get: You need to provide at least one JID","error"),null):typeof e=="string"?s.wrappedChatBox(s.chatboxes.getChatBox(e,!0)):t.map(e,t.partial(t.compose(s.wrappedChatBox,s.chatboxes.getChatBox.bind(s.chatboxes)),t,!0))}},tokens:{get:function(e){if(!s.expose_rid_and_sid||typeof s.connection=="undefined")return null;if(e.toLowerCase()==="rid")return s.connection.rid||s.connection._proto.rid;if(e.toLowerCase()==="sid")return s.connection.sid||s.connection._proto.sid}},listen:{once:function(e,t){s.once(e,t)},on:function(e,t){s.on(e,t)},not:function(e,t){s.off(e,t)},stanza:function(e,t,n){typeof t=="function"?(n=t,t={}):t=t||{},s.connection.addHandler(n,t.ns,t.name,t.type,t.id,t.from,t)}},send:function(e){s.connection.send(e)},plugins:{add:function(e,t){s.plugins[e]=t},remove:function(e){delete s.plugins[e]},override:function(e,t){s._overrideAttribute(e,t)},extend:function(e,t){s._extendObject(e,t)}},env:{$build:r.$build,$iq:r.$iq,$msg:r.$msg,$pres:r.$pres,Strophe:r.Strophe,b64_sha1:r.SHA1.b64_sha1,_:t,jQuery:e,moment:n,utils:i}}}),function(e,t){function l(e){return f.PF.compile(e||"nplurals=2; plural=(n != 1);")}function c(e,t){this._key=e,this._i18n=t}var n=Array.prototype,r=Object.prototype,i=n.slice,s=r.hasOwnProperty,o=n.forEach,u={},a={forEach:function(e,t,n){var r,i,a;if(e===null)return;if(o&&e.forEach===o)e.forEach(t,n);else if(e.length===+e.length){for(r=0,i=e.length;r<i;r++)if(r in e&&t.call(n,e[r],r,e)===u)return}else for(a in e)if(s.call(e,a)&&t.call(n,e[a],a,e)===u)return},extend:function(e){return this.forEach(i.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e}},f=function(e){this.defaults={locale_data:{messages:{"":{domain:"messages",lang:"en",plural_forms:"nplurals=2; plural=(n != 1);"}}},domain:"messages"},this.options=a.extend({},this.defaults,e),this.textdomain(this.options.domain);if(e.domain&&!this.options.locale_data[this.options.domain])throw new Error("Text domain set to non-existent domain: `"+e.domain+"`")};f.context_delimiter=String.fromCharCode(4),a.extend(c.prototype,{onDomain:function(e){return this._domain=e,this},withContext:function(e){return this._context=e,this},ifPlural:function(e,t){return this._val=e,this._pkey=t,this},fetch:function(e){return{}.toString.call(e)!="[object Array]"&&(e=[].slice.call(arguments)),(e&&e.length?f.sprintf:function(e){return e})(this._i18n.dcnpgettext(this._domain,this._context,this._key,this._pkey,this._val),e)}}),a.extend(f.prototype,{translate:function(e){return new c(e,this)},textdomain:function(e){if(!e)return this._textdomain;this._textdomain=e},gettext:function(e){return this.dcnpgettext.call(this,t,t,e)},dgettext:function(e,n){return this.dcnpgettext.call(this,e,t,n)},dcgettext:function(e,n){return this.dcnpgettext.call(this,e,t,n)},ngettext:function(e,n,r){return this.dcnpgettext.call(this,t,t,e,n,r)},dngettext:function(e,n,r,i){return this.dcnpgettext.call(this,e,t,n,r,i)},dcngettext:function(e,n,r,i){return this.dcnpgettext.call(this,e,t,n,r,i)},pgettext:function(e,n){return this.dcnpgettext.call(this,t,e,n)},dpgettext:function(e,t,n){return this.dcnpgettext.call(this,e,t,n)},dcpgettext:function(e,t,n){return this.dcnpgettext.call(this,e,t,n)},npgettext:function(e,n,r,i){return this.dcnpgettext.call(this,t,e,n,r,i)},dnpgettext:function(e,t,n,r,i){return this.dcnpgettext.call(this,e,t,n,r,i)},dcnpgettext:function(e,t,n,r,i){r=r||n,e=e||this._textdomain,i=typeof i=="undefined"?1:i;var s;if(!this.options)return s=new f,s.dcnpgettext.call(s,undefined,undefined,n,r,i);if(!this.options.locale_data)throw new Error("No locale data provided.");if(!this.options.locale_data[e])throw new Error("Domain `"+e+"` was not found.");if(!this.options.locale_data[e][""])throw new Error("No locale meta information provided.");if(!n)throw new Error("No translation key found.");if(typeof i!="number"){i=parseInt(i,10);if(isNaN(i))throw new Error("The number that was passed in is not a number.")}var o=t?t+f.context_delimiter+n:n,u=this.options.locale_data,a=u[e],c=a[""].plural_forms||(u.messages||this.defaults.locale_data.messages)[""].plural_forms,h=l(c)(i)+1,p,d;if(!a)throw new Error("No domain named `"+e+"` could be found.");return p=a[o],!p||h>=p.length?(this.options.missing_key_callback&&this.options.missing_key_callback(o),d=[null,n,r],d[l(c)(i)+1]):(d=p[h],d?d:(d=[null,n,r],d[l(c)(i)+1]))}});var h=function(){function e(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function t(e,t){for(var n=[];t>0;n[--t]=e);return n.join("")}var n=function(){return n.cache.hasOwnProperty(arguments[0])||(n.cache[arguments[0]]=n.parse(arguments[0])),n.format.call(null,n.cache[arguments[0]],arguments)};return n.format=function(n,r){var i=1,s=n.length,o="",u,a=[],f,l,c,p,d,v;for(f=0;f<s;f++){o=e(n[f]);if(o==="string")a.push(n[f]);else if(o==="array"){c=n[f];if(c[2]){u=r[i];for(l=0;l<c[2].length;l++){if(!u.hasOwnProperty(c[2][l]))throw h('[sprintf] property "%s" does not exist',c[2][l]);u=u[c[2][l]]}}else c[1]?u=r[c[1]]:u=r[i++];if(/[^s]/.test(c[8])&&e(u)!="number")throw h("[sprintf] expecting number but found %s",e(u));if(typeof u=="undefined"||u===null)u="";switch(c[8]){case"b":u=u.toString(2);break;case"c":u=String.fromCharCode(u);break;case"d":u=parseInt(u,10);break;case"e":u=c[7]?u.toExponential(c[7]):u.toExponential();break;case"f":u=c[7]?parseFloat(u).toFixed(c[7]):parseFloat(u);break;case"o":u=u.toString(8);break;case"s":u=(u=String(u))&&c[7]?u.substring(0,c[7]):u;break;case"u":u=Math.abs(u);break;case"x":u=u.toString(16);break;case"X":u=u.toString(16).toUpperCase()}u=/[def]/.test(c[8])&&c[3]&&u>=0?"+"+u:u,d=c[4]?c[4]=="0"?"0":c[4].charAt(1):" ",v=c[6]-String(u).length,p=c[6]?t(d,v):"",a.push(c[5]?u+p:p+u)}}return a.join("")},n.cache={},n.parse=function(e){var t=e,n=[],r=[],i=0;while(t){if((n=/^[^\x25]+/.exec(t))!==null)r.push(n[0]);else if((n=/^\x25{2}/.exec(t))!==null)r.push("%");else{if((n=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(t))===null)throw"[sprintf] huh?";if(n[2]){i|=1;var s=[],o=n[2],u=[];if((u=/^([a-z_][a-z_\d]*)/i.exec(o))===null)throw"[sprintf] huh?";s.push(u[1]);while((o=o.substring(u[0].length))!=="")if((u=/^\.([a-z_][a-z_\d]*)/i.exec(o))!==null)s.push(u[1]);else{if((u=/^\[(\d+)\]/.exec(o))===null)throw"[sprintf] huh?";s.push(u[1])}n[2]=s}else i|=2;if(i===3)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";r.push(n)}t=t.substring(n[0].length)}return r},n}(),p=function(e,t){return t.unshift(e),h.apply(null,t)};f.parse_plural=function(e,t){return e=e.replace(/n/g,t),f.parse_expression(e)},f.sprintf=function(e,t){return{}.toString.call(t)=="[object Array]"?p(e,[].slice.call(t)):h.apply(this,[].slice.call(arguments))},f.prototype.sprintf=function(){return f.sprintf.apply(this,arguments)},f.PF={},f.PF.parse=function(e){var t=f.PF.extractPluralExpr(e);return f.PF.parser.parse.call(f.PF.parser,t)},f.PF.compile=function(e){function t(e){return e===!0?1:e?e:0}var n=f.PF.parse(e);return function(e){return t(f.PF.interpreter(n)(e))}},f.PF.interpreter=function(e){return function(t){var n;switch(e.type){case"GROUP":return f.PF.interpreter(e.expr)(t);case"TERNARY":if(f.PF.interpreter(e.expr)(t))return f.PF.interpreter(e.truthy)(t);return f.PF.interpreter(e.falsey)(t);case"OR":return f.PF.interpreter(e.left)(t)||f.PF.interpreter(e.right)(t);case"AND":return f.PF.interpreter(e.left)(t)&&f.PF.interpreter(e.right)(t);case"LT":return f.PF.interpreter(e.left)(t)<f.PF.interpreter(e.right)(t);case"GT":return f.PF.interpreter(e.left)(t)>f.PF.interpreter(e.right)(t);case"LTE":return f.PF.interpreter(e.left)(t)<=f.PF.interpreter(e.right)(t);case"GTE":return f.PF.interpreter(e.left)(t)>=f.PF.interpreter(e.right)(t);case"EQ":return f.PF.interpreter(e.left)(t)==f.PF.interpreter(e.right)(t);case"NEQ":return f.PF.interpreter(e.left)(t)!=f.PF.interpreter(e.right)(t);case"MOD":return f.PF.interpreter(e.left)(t)%f.PF.interpreter(e.right)(t);case"VAR":return t;case"NUM":return e.val;default:throw new Error("Invalid Token found.")}}},f.PF.extractPluralExpr=function(e){e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,""),/;\s*$/.test(e)||(e=e.concat(";"));var t=/nplurals\=(\d+);/,n=/plural\=(.*);/,r=e.match(t),i={},s;if(r.length>1){i.nplurals=r[1],e=e.replace(t,""),s=e.match(n);if(!(s&&s.length>1))throw new Error("`plural` expression not found: "+e);return s[1]}throw new Error("nplurals not found in plural_forms string: "+e)},f.PF.parser=function(){var e={trace:function(){},yy:{},symbols_:{error:2,expressions:3,e:4,EOF:5,"?":6,":":7,"||":8,"&&":9,"<":10,"<=":11,">":12,">=":13,"!=":14,"==":15,"%":16,"(":17,")":18,n:19,NUMBER:20,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"?",7:":",8:"||",9:"&&",10:"<",11:"<=",12:">",13:">=",14:"!=",15:"==",16:"%",17:"(",18:")",19:"n",20:"NUMBER"},productions_:[0,[3,2],[4,5],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,1],[4,1]],performAction:function(t,n,r,i,s,o,u){var a=o.length-1;switch(s){case 1:return{type:"GROUP",expr:o[a-1]};case 2:this.$={type:"TERNARY",expr:o[a-4],truthy:o[a-2],falsey:o[a]};break;case 3:this.$={type:"OR",left:o[a-2],right:o[a]};break;case 4:this.$={type:"AND",left:o[a-2],right:o[a]};break;case 5:this.$={type:"LT",left:o[a-2],right:o[a]};break;case 6:this.$={type:"LTE",left:o[a-2],right:o[a]};break;case 7:this.$={type:"GT",left:o[a-2],right:o[a]};break;case 8:this.$={type:"GTE",left:o[a-2],right:o[a]};break;case 9:this.$={type:"NEQ",left:o[a-2],right:o[a]};break;case 10:this.$={type:"EQ",left:o[a-2],right:o[a]};break;case 11:this.$={type:"MOD",left:o[a-2],right:o[a]};break;case 12:this.$={type:"GROUP",expr:o[a-1]};break;case 13:this.$={type:"VAR"};break;case 14:this.$={type:"NUM",val:Number(t)}}},table:[{3:1,4:2,17:[1,3],19:[1,4],20:[1,5]},{1:[3]},{5:[1,6],6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{4:17,17:[1,3],19:[1,4],20:[1,5]},{5:[2,13],6:[2,13],7:[2,13],8:[2,13],9:[2,13],10:[2,13],11:[2,13],12:[2,13],13:[2,13],14:[2,13],15:[2,13],16:[2,13],18:[2,13]},{5:[2,14],6:[2,14],7:[2,14],8:[2,14],9:[2,14],10:[2,14],11:[2,14],12:[2,14],13:[2,14],14:[2,14],15:[2,14],16:[2,14],18:[2,14]},{1:[2,1]},{4:18,17:[1,3],19:[1,4],20:[1,5]},{4:19,17:[1,3],19:[1,4],20:[1,5]},{4:20,17:[1,3],19:[1,4],20:[1,5]},{4:21,17:[1,3],19:[1,4],20:[1,5]},{4:22,17:[1,3],19:[1,4],20:[1,5]},{4:23,17:[1,3],19:[1,4],20:[1,5]},{4:24,17:[1,3],19:[1,4],20:[1,5]},{4:25,17:[1,3],19:[1,4],20:[1,5]},{4:26,17:[1,3],19:[1,4],20:[1,5]},{4:27,17:[1,3],19:[1,4],20:[1,5]},{6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[1,28]},{6:[1,7],7:[1,29],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{5:[2,3],6:[2,3],7:[2,3],8:[2,3],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,3]},{5:[2,4],6:[2,4],7:[2,4],8:[2,4],9:[2,4],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,4]},{5:[2,5],6:[2,5],7:[2,5],8:[2,5],9:[2,5],10:[2,5],11:[2,5],12:[2,5],13:[2,5],14:[2,5],15:[2,5],16:[1,16],18:[2,5]},{5:[2,6],6:[2,6],7:[2,6],8:[2,6],9:[2,6],10:[2,6],11:[2,6],12:[2,6],13:[2,6],14:[2,6],15:[2,6],16:[1,16],18:[2,6]},{5:[2,7],6:[2,7],7:[2,7],8:[2,7],9:[2,7],10:[2,7],11:[2,7],12:[2,7],13:[2,7],14:[2,7],15:[2,7],16:[1,16],18:[2,7]},{5:[2,8],6:[2,8],7:[2,8],8:[2,8],9:[2,8],10:[2,8],11:[2,8],12:[2,8],13:[2,8],14:[2,8],15:[2,8],16:[1,16],18:[2,8]},{5:[2,9],6:[2,9],7:[2,9],8:[2,9],9:[2,9],10:[2,9],11:[2,9],12:[2,9],13:[2,9],14:[2,9],15:[2,9],16:[1,16],18:[2,9]},{5:[2,10],6:[2,10],7:[2,10],8:[2,10],9:[2,10],10:[2,10],11:[2,10],12:[2,10],13:[2,10],14:[2,10],15:[2,10],16:[1,16],18:[2,10]},{5:[2,11],6:[2,11],7:[2,11],8:[2,11],9:[2,11],10:[2,11],11:[2,11],12:[2,11],13:[2,11],14:[2,11],15:[2,11],16:[2,11],18:[2,11]},{5:[2,12],6:[2,12],7:[2,12],8:[2,12],9:[2,12],10:[2,12],11:[2,12],12:[2,12],13:[2,12],14:[2,12],15:[2,12],16:[2,12],18:[2,12]},{4:30,17:[1,3],19:[1,4],20:[1,5]},{5:[2,2],6:[1,7],7:[2,2],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,2]}],defaultActions:{6:[2,1]},parseError:function(t,n){throw new Error(t)},parse:function(t){function d(e){r.length=r.length-2*e,i.length=i.length-e,s.length=s.length-e}function v(){var e;return e=n.lexer.lex()||1,typeof e!="number"&&(e=n.symbols_[e]||e),e}var n=this,r=[0],i=[null],s=[],o=this.table,u="",a=0,f=0,l=0,c=2,h=1;this.lexer.setInput(t),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,typeof this.lexer.yylloc=="undefined"&&(this.lexer.yylloc={});var p=this.lexer.yylloc;s.push(p),typeof this.yy.parseError=="function"&&(this.parseError=this.yy.parseError);var m,g,y,b,w,E,S={},x,T,N,C;for(;;){y=r[r.length-1],this.defaultActions[y]?b=this.defaultActions[y]:(m==null&&(m=v()),b=o[y]&&o[y][m]);if(typeof b=="undefined"||!b.length||!b[0]){if(!l){C=[];for(x in o[y])this.terminals_[x]&&x>2&&C.push("'"+this.terminals_[x]+"'");var k="";this.lexer.showPosition?k="Parse error on line "+(a+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+C.join(", ")+", got '"+this.terminals_[m]+"'":k="Parse error on line "+(a+1)+": Unexpected "+(m==1?"end of input":"'"+(this.terminals_[m]||m)+"'"),this.parseError(k,{text:this.lexer.match,token:this.terminals_[m]||m,line:this.lexer.yylineno,loc:p,expected:C})}if(l==3){if(m==h)throw new Error(k||"Parsing halted.");f=this.lexer.yyleng,u=this.lexer.yytext,a=this.lexer.yylineno,p=this.lexer.yylloc,m=v()}for(;;){if(c.toString()in o[y])break;if(y==0)throw new Error(k||"Parsing halted.");d(1),y=r[r.length-1]}g=m,m=c,y=r[r.length-1],b=o[y]&&o[y][c],l=3}if(b[0]instanceof Array&&b.length>1)throw new Error("Parse Error: multiple actions possible at state: "+y+", token: "+m);switch(b[0]){case 1:r.push(m),i.push(this.lexer.yytext),s.push(this.lexer.yylloc),r.push(b[1]),m=null,g?(m=g,g=null):(f=this.lexer.yyleng,u=this.lexer.yytext,a=this.lexer.yylineno,p=this.lexer.yylloc,l>0&&l--);break;case 2:T=this.productions_[b[1]][1],S.$=i[i.length-T],S._$={first_line:s[s.length-(T||1)].first_line,last_line:s[s.length-1].last_line,first_column:s[s.length-(T||1)].first_column,last_column:s[s.length-1].last_column},E=this.performAction.call(S,u,f,a,this.yy,b[1],i,s);if(typeof E!="undefined")return E;T&&(r=r.slice(0,-1*T*2),i=i.slice(0,-1*T),s=s.slice(0,-1*T)),r.push(this.productions_[b[1]][0]),i.push(S.$),s.push(S._$),N=o[r[r.length-2]][r[r.length-1]],r.push(N);break;case 3:return!0}}return!0}},t=function(){var e={EOF:1,parseError:function(t,n){if(!this.yy.parseError)throw new Error(t);this.yy.parseError(t,n)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this},input:function(){var e=this._input[0];this.yytext+=e,this.yyleng++,this.match+=e,this.matched+=e;var t=e.match(/\n/);return t&&this.yylineno++,this._input=this._input.slice(1),e},unput:function(e){return this._input=e+this._input,this},more:function(){return this._more=!0,this},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=(new Array(e.length+1)).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var e,t,n,r;this._more||(this.yytext="",this.match="");var i=this._currentRules();for(var s=0;s<i.length;s++){t=this._input.match(this.rules[i[s]]);if(t){r=t[0].match(/\n.*/g),r&&(this.yylineno+=r.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:r?r[r.length-1].length-1:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,i[s],this.conditionStack[this.conditionStack.length-1]);if(e)return e;return}}if(this._input==="")return this.EOF;this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var t=this.next();return typeof t!="undefined"?t:this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(t){this.begin(t)}};return e.performAction=function(t,n,r,i){var s=i;switch(r){case 0:break;case 1:return 20;case 2:return 19;case 3:return 8;case 4:return 9;case 5:return 6;case 6:return 7;case 7:return 11;case 8:return 13;case 9:return 10;case 10:return 12;case 11:return 14;case 12:return 15;case 13:return 16;case 14:return 17;case 15:return 18;case 16:return 5;case 17:return"INVALID"}},e.rules=[/^\s+/,/^[0-9]+(\.[0-9]+)?\b/,/^n\b/,/^\|\|/,/^&&/,/^\?/,/^:/,/^<=/,/^>=/,/^</,/^>/,/^!=/,/^==/,/^%/,/^\(/,/^\)/,/^$/,/^./],e.conditions={INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],inclusive:!0}},e}();return e.lexer=t,e}(),typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=f),exports.Jed=f):(typeof define=="function"&&define.amd&&define("jed",[],function(){return f}),e.Jed=f)}(this),function(e,t){define("converse-chatview",["converse-core","converse-api"],t)}(this,function(e,t){"use strict";var n=t.env.jQuery,r=t.env.utils,i=t.env.Strophe,s=t.env.$msg,o=t.env._,u=r.__.bind(e),a=t.env.moment,f={ENTER:13,FORWARD_SLASH:47};t.plugins.add("chatview",{overrides:{ChatBoxViews:{onChatBoxAdded:function(t){var n=this.get(t.get("id"));!n&&!t.get("chatroom")?(n=new e.ChatBoxView({model:t}),this.add(t.get("id"),n),this.trimChats(n)):this._super.onChatBoxAdded.apply(this,arguments)}}},initialize:function(){this.updateSettings({show_toolbar:!0}),e.ChatBoxView=Backbone.View.extend({length:200,tagName:"div",className:"chatbox",is_chatroom:!1,events:{"click .close-chatbox-button":"close","click .toggle-chatbox-button":"minimize","keypress textarea.chat-textarea":"keyPressed","click .toggle-smiley":"toggleEmoticonMenu","click .toggle-smiley ul li":"insertEmoticon","click .toggle-clear":"clearMessages","click .toggle-call":"toggleCall","mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},initialize:function(){n(window).on("resize",o.debounce(this.setDimensions.bind(this),100)),this.model.messages.on("add",this.onMessageAdded,this),this.model.on("show",this.show,this),this.model.on("destroy",this.hide,this),this.model.on("change:chat_state",this.sendChatState,this),this.model.on("change:chat_status",this.onChatStatusChanged,this),this.model.on("change:image",this.renderAvatar,this),this.model.on("change:minimized",this.onMinimizedChanged,this),this.model.on("change:status",this.onStatusChanged,this),this.model.on("showHelpMessages",this.showHelpMessages,this),this.model.on("sendMessage",this.sendMessage,this),this.render().fetchMessages().insertIntoPage().hide(),e.emit("chatBoxInitialized",this)},render:function(){return this.$el.attr("id",this.model.get("box_id")).html(e.templates.chatbox(o.extend(this.model.toJSON(),{show_toolbar:e.show_toolbar,show_textarea:!0,title:this.model.get("fullname"),info_close:u("Close this chat box"),info_minimize:u("Minimize this chat box"),label_personal_message:u("Personal message")}))),this.setWidth(),this.$content=this.$el.find(".chat-content"),this.renderToolbar().renderAvatar(),this.$content.on("scroll",o.debounce(this.onScroll.bind(this),100)),e.emit("chatBoxOpened",this),window.setTimeout(r.refreshWebkit,50),this.showStatusMessage()},setWidth:function(){this.model.get("width")&&this.$el.css("width",this.model.get("width"))},onScroll:function(t){n(t.target).scrollTop()===0&&this.model.messages.length&&this.fetchArchivedMessages({before:this.model.messages.at(0).get("archive_id"),"with":this.model.get("jid"),max:e.archived_messages_page_size})},fetchMessages:function(){return this.model.messages.fetch({add:!0,success:function(){if(!e.features.findWhere({"var":i.NS.MAM}))return;this.model.messages.length<e.archived_messages_page_size&&this.fetchArchivedMessages({before:"","with":this.model.get("jid"),max:e.archived_messages_page_size})}.bind(this)}),this},fetchArchivedMessages:function(t){if(!e.features.findWhere({"var":i.NS.MAM})){e.log("Attempted to fetch archived messages but this user's server doesn't support XEP-0313");return}this.addSpinner(),e.queryForArchivedMessages(t,function(t){this.clearSpinner(),t.length&&o.map(t,e.chatboxes.onMessage.bind(e.chatboxes))}.bind(this),function(){this.clearSpinner(),e.log("Error or timeout while trying to fetch archived messages","error")}.bind(this))},insertIntoPage:function(){return n("#conversejs").prepend(this.$el),this},adjustToViewport:function(){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight,window.innerHeight||0);e<=480?(this.model.set("height",undefined),this.model.set("width",undefined)):e<=this.model.get("width")?this.model.set("width",undefined):t<=this.model.get("height")&&this.model.set("height",undefined)},initDragResize:function(){var t=this.$el.find(".box-flyout");if(typeof this.model.get("height")=="undefined"){var n=t.height(),r=t.width();this.model.set("height",n),this.model.set("default_height",n),this.model.set("width",r),this.model.set("default_width",r)}var i=t.css("min-width"),s=t.css("min-height");return this.model.set("min_width",i.endsWith("px")?Number(i.replace(/px$/,"")):0),this.model.set("min_height",s.endsWith("px")?Number(s.replace(/px$/,"")):0),this.prev_pageY=0,this.prev_pageX=0,e.connection.connected&&(this.height=this.model.get("height"),this.width=this.model.get("width")),this},setDimensions:function(){this.adjustToViewport(),this.setChatBoxHeight(this.model.get("height")),this.setChatBoxWidth(this.model.get("width"))},clearStatusNotification:function(){this.$content.find("div.chat-event").remove()},showStatusNotification:function(e,t){t||this.clearStatusNotification();var r=this.$content.scrollTop()+this.$content.innerHeight()>=this.$content[0].scrollHeight;this.$content.append(n('<div class="chat-info chat-event"></div>').text(e)),r&&this.scrollDown()},addSpinner:function(){this.$content.first().hasClass("spinner")||this.$content.prepend('<span class="spinner"/>')},clearSpinner:function(){this.$content.children(":first").is("span.spinner")&&this.$content.children(":first").remove()},prependDayIndicator:function(t){var n=a(t).startOf("day");this.$content.prepend(e.templates.new_day({isodate:n.format(),datestring:n.format("dddd MMM Do YYYY")}))},appendMessage:function(e){o.compose(o.debounce(this.scrollDown.bind(this),50),this.$content.append.bind(this.$content))(this.renderMessage(e))},showMessage:function(t){var r=this.$content.children(".chat-message:first"),i=r.data("isodate"),s,u,f,l,c,h;if(!i){this.appendMessage(t);return}u=a(t.time)||a,s=this.$content.children(".chat-message:last").data("isodate");if(typeof s!="undefined"&&(u.isAfter(s)||u.isSame(s))){u.isAfter(s,"day")&&(f=a(u).startOf("day"),this.$content.append(e.templates.new_day({isodate:u.format(),datestring:u.format("dddd MMM Do YYYY")}))),this.appendMessage(t);return}typeof i!="undefined"&&(u.isBefore(i)||u.isSame(i)&&!u.isSame(s))?(r.prev().length===0&&this.prependDayIndicator(i),u.isBefore(i,"day")?(o.compose(this.scrollDownMessageHeight.bind(this),function(e){return this.$content.prepend(e),e}.bind(this))(this.renderMessage(t)),this.prependDayIndicator(u)):o.compose(this.scrollDownMessageHeight.bind(this),function(e){return e.insertBefore(r),e})(this.renderMessage(t))):(u=u.format(),l=this.$content.children(".chat-message"),c=o.map(l,function(e){return n(e).data("isodate")}),c.push(u),c.sort(),h=c.indexOf(u)-1,o.compose(this.scrollDownMessageHeight.bind(this),function(e){return e.insertAfter(this.$content.find('.chat-message[data-isodate="'+c[h]+'"]')),e}.bind(this))(this.renderMessage(t)))},renderMessage:function(t){var r=a(t.time)||a,i=t.message,s=i.match(/^\/(.*?)(?: (.*))?$/),o=this.model.get("fullname")||t.fullname,f=t.delayed&&"delayed"||"",l,c;return s&&s[1]==="me"?(i=i.replace(/^\/me/,""),l=e.templates.action,c=o):(l=e.templates.message,c=t.sender==="me"&&u("me")||o),this.$content.find("div.chat-event").remove(),this.is_chatroom&&t.sender==="them"&&(new RegExp("\\b"+this.model.get("nick")+"\\b")).test(i)&&(f+=" mentioned"),n(l({msgid:t.msgid,sender:t.sender,time:r.format("hh:mm"),isodate:r.format(),username:c,message:"",extra_classes:f})).children(".chat-msg-content").first().text(i).addHyperlinks().addEmoticons(e.visible_toolbar_buttons.emoticons).parent()},showHelpMessages:function(e,t,r){var i,s=e.length;for(i=0;i<s;i++)this.$content.append(n('<div class="chat-'+(t||"info")+'">'+e[i]+"</div>"));return r===!0?this.$content.append('<span class="spinner"/>'):r===!1&&this.$content.find("span.spinner").remove(),this.scrollDown()},handleChatStateMessage:function(t){t.get("chat_state")===e.COMPOSING?(this.showStatusNotification(t.get("fullname")+" "+u("is typing")),this.clear_status_timeout=window.setTimeout(this.clearStatusNotification.bind(this),1e4)):t.get("chat_state")===e.PAUSED?this.showStatusNotification(t.get("fullname")+" "+u("has stopped typing")):o.contains([e.INACTIVE,e.ACTIVE],t.get("chat_state"))?this.$content.find("div.chat-event").remove():t.get("chat_state")===e.GONE&&this.showStatusNotification(t.get("fullname")+" "+u("has gone away"))},handleTextMessage:function(t){this.showMessage(o.clone(t.attributes)),t.get("sender")!=="me"&&e.windowState==="blur"&&e.incrementMsgCounter(),!this.model.get("minimized")&&!this.$el.is(":visible")&&this.show()},onMessageAdded:function(e){typeof this.clear_status_timeout!="undefined"&&(window.clearTimeout(this.clear_status_timeout),delete this.clear_status_timeout),e.get("message")?this.handleTextMessage(e):this.handleChatStateMessage(e)},createMessageStanza:function(t){return s({from:e.connection.jid,to:this.model.get("jid"),type:"chat",id:t.get("msgid")}).c("body").t(t.get("message")).up().c(e.ACTIVE,{xmlns:i.NS.CHATSTATES}).up()},sendMessage:function(t){var n=this.createMessageStanza(t);e.connection.send(n),e.forward_messages&&e.connection.send(s({to:e.bare_jid,type:"chat",id:t.get("msgid")}).c("forwarded",{xmlns:"urn:xmpp:forward:0"}).c("delay",{xmns:"urn:xmpp:delay",stamp:(new Date).getTime()}).up().cnode(n.tree()))},onMessageSubmitted:function(t){if(!e.connection.authenticated)return this.showHelpMessages(["Sorry, the connection has been lost, and your message could not be sent"],"error");var n=t.replace(/^\s*/,"").match(/^\/(.*)\s*$/),r;if(n){if(n[1]==="clear")return this.clearMessages();if(n[1]==="help"){r=["<strong>/help</strong>:"+u("Show this menu")+"","<strong>/me</strong>:"+u("Write in the third person")+"","<strong>/clear</strong>:"+u("Remove messages")+""],this.showHelpMessages(r);return}}var i=e.xmppstatus.get("fullname");i=o.isEmpty(i)?e.bare_jid:i;var s=this.model.messages.create({fullname:i,sender:"me",time:a().format(),message:t});this.sendMessage(s)},sendChatState:function(){e.connection.send(s({to:this.model.get("jid"),type:"chat"}).c(this.model.get("chat_state"),{xmlns:i.NS.CHATSTATES}))},setChatState:function(t,n){return typeof this.chat_state_timeout!="undefined"&&(window.clearTimeout(this.chat_state_timeout),delete this.chat_state_timeout),t===e.COMPOSING?this.chat_state_timeout=window.setTimeout(this.setChatState.bind(this),e.TIMEOUTS.PAUSED,e.PAUSED):t===e.PAUSED&&(this.chat_state_timeout=window.setTimeout(this.setChatState.bind(this),e.TIMEOUTS.INACTIVE,e.INACTIVE)),!n&&this.model.get("chat_state")!==t&&this.model.set("chat_state",t),this},keyPressed:function(t){var r=n(t.target),i;t.keyCode===f.ENTER?(t.preventDefault(),i=r.val(),r.val("").focus(),i!==""&&(this.model.get("chatroom")?this.onChatRoomMessageSubmitted(i):this.onMessageSubmitted(i),e.emit("messageSend",i)),this.setChatState(e.ACTIVE)):this.model.get("chatroom")||this.setChatState(e.COMPOSING,t.keyCode===f.FORWARD_SLASH)},onStartVerticalResize:function(t){if(!e.allow_dragresize)return!0;this.height=this.$el.children(".box-flyout").height(),e.resizing={chatbox:this,direction:"top"},this.prev_pageY=t.pageY},onStartHorizontalResize:function(t){if(!e.allow_dragresize)return!0;this.width=this.$el.children(".box-flyout").width(),e.resizing={chatbox:this,direction:"left"},this.prev_pageX=t.pageX},onStartDiagonalResize:function(t){this.onStartHorizontalResize(t),this.onStartVerticalResize(t),e.resizing.direction="topleft"},setChatBoxHeight:function(t){this.model.get("minimized")||(t?t=e.applyDragResistance(t,this.model.get("default_height"))+"px":t="",this.$el.children(".box-flyout")[0].style.height=t)},setChatBoxWidth:function(t){this.model.get("minimized")||(t?t=e.applyDragResistance(t,this.model.get("default_width"))+"px":t="",this.$el[0].style.width=t,this.$el.children(".box-flyout")[0].style.width=t)},resizeChatBox:function(t){var n;e.resizing.direction.indexOf("top")===0&&(n=t.pageY-this.prev_pageY,n&&(this.height=this.height-n>(this.model.get("min_height")||0)?this.height-n:this.model.get("min_height"),this.prev_pageY=t.pageY,this.setChatBoxHeight(this.height))),e.resizing.direction.indexOf("left")!==-1&&(n=this.prev_pageX-t.pageX,n&&(this.width=this.width+n>(this.model.get("min_width")||0)?this.width+n:this.model.get("min_width"),this.prev_pageX=t.pageX,this.setChatBoxWidth(this.width)))},clearMessages:function(e){e&&e.preventDefault&&e.preventDefault();var t=confirm(u("Are you sure you want to clear the messages from this chat box?"));return t===!0&&(this.$content.empty(),this.model.messages.reset(),this.model.messages.browserStorage._clear()),this},insertEmoticon:function(e){e.stopPropagation(),this.$el.find(".toggle-smiley ul").slideToggle(200);var t=this.$el.find("textarea.chat-textarea"),r=t.val(),i=n(e.target);i=i.is("a")?i:i.children("a"),r&&r[r.length-1]!==" "&&(r+=" "),t.focus().val(r+i.data("emoticon")+" ")},toggleEmoticonMenu:function(e){e.stopPropagation(),this.$el.find(".toggle-smiley ul").slideToggle(200)},toggleCall:function(t){t.stopPropagation(),e.emit("callButtonClicked",{connection:e.connection,model:this.model})},onChatStatusChanged:function(e){var t=e.get("chat_status"),n=e.get("fullname");n=o.isEmpty(n)?e.get("jid"):n,this.$el.is(":visible")&&(t==="offline"?this.showStatusNotification(n+" "+u("has gone offline")):t==="away"?this.showStatusNotification(n+" "+u("has gone away")):t==="dnd"?this.showStatusNotification(n+" "+u("is busy")):t==="online"&&this.$el.find("div.chat-event").remove())},onStatusChanged:function(t){this.showStatusMessage(),e.emit("contactStatusMessageChanged",{contact:t.attributes,message:t.get("status")})},onMinimizedChanged:function(e){e.get("minimized")?this.minimize():this.maximize()},showStatusMessage:function(e){return e=e||this.model.get("status"),typeof e=="string"&&this.$el.find("p.user-custom-message").text(e).attr("title",e),this},close:function(t){return t&&t.preventDefault&&t.preventDefault(),e.connection.connected?(this.model.destroy(),this.setChatState(e.INACTIVE)):this.hide(),e.emit("chatBoxClosed",this),this},onMaximized:function(){e.chatboxviews.trimChats(this),r.refreshWebkit(),this.$content.scrollTop(this.model.get("scroll")),this.setChatState(e.ACTIVE).focus(),e.emit("chatBoxMaximized",this)},onMinimized:function(){r.refreshWebkit(),e.emit("chatBoxMinimized",this)},maximize:function(){return n("#conversejs").prepend(this.$el),this.$el.show("fast",this.onMaximized.bind(this)),this},minimize:function(t){t&&t.preventDefault&&t.preventDefault(),this.model.save({scroll:this.$content.scrollTop()}),this.setChatState(e.INACTIVE).model.minimize(),this.$el.hide("fast",this.onMinimized.bind(this))},renderToolbar:function(t){if(!e.show_toolbar)return;return t=o.extend(t||{},{label_clear:u("Clear all messages"),label_hide_occupants:u("Hide the list of occupants"),label_insert_smiley:u("Insert a smiley"),label_start_call:u("Start a call"),show_call_button:e.visible_toolbar_buttons.call,show_clear_button:e.visible_toolbar_buttons.clear,show_emoticons:e.visible_toolbar_buttons.emoticons,show_occupants_toggle:this.is_chatroom&&e.visible_toolbar_buttons.toggle_occupants}),this.$el.find(".chat-toolbar").html(e.templates.toolbar(o.extend(this.model.toJSON(),t||{}))),this},renderAvatar:function(){if(!this.model.get("image"))return;var e="data:"+this.model.get("image_type")+";base64,"+this.model.get("image"),t=n('<canvas height="32px" width="32px" class="avatar"></canvas>').get(0);if(!t.getContext||!t.getContext("2d"))return this;var r=t.getContext("2d"),i=new Image;return i.onload=function(){var e=i.width/i.height;e<1?r.drawImage(i,0,0,32,32*(1/e)):r.drawImage(i,0,0,32,32*e)},i.src=e,this.$el.find(".chat-title").before(t),this},focus:function(){return this.$el.find(".chat-textarea").focus(),e.emit("chatBoxFocused",this),this},hide:function(){return this.$el.is(":visible")&&this.$el.css("opacity")==="1"&&(this.$el.hide(),r.refreshWebkit()),this},show:function(t){return typeof this.debouncedShow=="undefined"&&(this.debouncedShow=o.debounce(function(t){if(this.$el.is(":visible")&&this.$el.css("opacity")==="1"){t&&this.focus();return}this.initDragResize().setDimensions(),this.$el.fadeIn(function(){e.connection.connected&&this.model.save(),e.chatboxviews.trimChats(this),this.setChatState(e.ACTIVE),this.scrollDown(),t&&this.focus()}.bind(this))},250,!0)),this.debouncedShow.apply(this,arguments),this},scrollDownMessageHeight:function(e){return this.$content.is(":visible")&&this.$content.scrollTop(this.$content.scrollTop()+e[0].scrollHeight),this},scrollDown:function(){return this.$content.is(":visible")&&this.$content.scrollTop(this.$content[0].scrollHeight),this}})}})}),function(e,t){define("converse-mam",["converse-core","converse-api","strophe.rsm"],t)}(this,function(e,t){"use strict";var n=t.env.jQuery,r=t.env.Strophe,i=t.env.$iq,s=t.env._,o=t.env.moment,u=["max","first","last","after","before","index","count"],a=["with","start","end"];r.addNamespace("MAM","urn:xmpp:mam:0"),r.addNamespace("RSM","http://jabber.org/protocol/rsm"),t.plugins.add("mam",{overrides:{Features:{addClientFeatures:function(){return e.connection.disco.addFeature(r.NS.MAM),this._super.addClientFeatures.apply(this,arguments)}},ChatBoxes:{createMessage:function(e,t){var n=this._super.createMessage.apply(this,arguments);n.save({archive_id:e.find('result[xmlns="'+r.NS.MAM+'"]').attr("id")})}}},initialize:function(){this.updateSettings({archived_messages_page_size:"20",message_archiving:"never",message_archiving_timeout:8e3}),e.queryForArchivedMessages=function(t,f,l){var c,h=[];typeof t=="function"&&(f=t,l=f);if(!e.features.findWhere({"var":r.NS.MAM})){e.log("This server does not support XEP-0313, Message Archive Management"),l(null);return}var p=e.connection.getUniqueId(),d={type:"set"};if(typeof t!="undefined"&&t.groupchat){if(!t["with"])throw new Error('You need to specify a "with" value containing the chat room JID, when querying groupchat messages.');d.to=t["with"]}var v=i(d).c("query",{xmlns:r.NS.MAM,queryid:p});typeof t!="undefined"&&(v.c("x",{xmlns:r.NS.XFORM,type:"submit"}).c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value").t(r.NS.MAM).up().up(),t["with"]&&!t.groupchat&&v.c("field",{"var":"with"}).c("value").t(t["with"]).up().up(),s.each(["start","end"],function(e){if(t[e]){c=o(t[e]);if(!c.isValid())throw new TypeError("archive.query: invalid date provided for: "+e);v.c("field",{"var":e}).c("value").t(c.format()).up().up()}}),v.up(),t instanceof r.RSM?v.cnode(t.toXML()):s.intersection(u,s.keys(t)).length&&v.cnode((new r.RSM(t)).toXML())),e.connection.addHandler(function(e){var i=n(e),o,u;if(typeof f=="function")return o=i.find('fin[xmlns="'+r.NS.MAM+'"]'),o.length?(u=new r.RSM({xml:o.find("set")[0]}),s.extend(u,s.pick(t,["max"])),s.extend(u,s.pick(t,a)),f(h,u),!1):(p===i.find("result").attr("queryid")&&h.push(e),!0);return!1},r.NS.MAM),e.connection.sendIQ(v,null,l,e.message_archiving_timeout)},s.extend(t,{archive:{query:e.queryForArchivedMessages.bind(e)}}),e.onMAMError=function(t){n(t).find("feature-not-implemented").length?e.log("Message Archive Management (XEP-0313) not supported by this browser"):(e.log("An error occured while trying to set archiving preferences."),e.log(t))},e.onMAMPreferences=function(t,o){var u=n(o).find('prefs[xmlns="'+r.NS.MAM+'"]'),a=u.attr("default"),f;a!==e.message_archiving?(f=i({type:"set"}).c("prefs",{xmlns:r.NS.MAM,"default":e.message_archiving}),u.children().each(function(e,t){f.cnode(t).up()}),e.connection.sendIQ(f,s.partial(function(t,n){t.save({preferences:{"default":e.message_archiving}})},t),e.onMAMError)):t.save({preferences:{"default":e.message_archiving}})};var f=function(t,n){var o=n.get("preferences")||{};n.get("var")===r.NS.MAM&&o["default"]!==e.message_archiving&&e.connection.sendIQ(i({type:"get"}).c("prefs",{xmlns:r.NS.MAM}),s.partial(e.onMAMPreferences,n),s.partial(e.onMAMError,n))};e.on("serviceDiscovered",f.bind(e.features))}})}),function(e,t){define("converse-rosterview",["converse-core","converse-api"],t)}(this,function(e,t){"use strict";var n=t.env.jQuery,r=t.env.utils,i=t.env.Strophe,s=t.env.$iq,o=t.env.b64_sha1,u=t.env._,a=r.__.bind(e);t.plugins.add("rosterview",{overrides:{afterReconnected:function(){this.rosterview.registerRosterXHandler(),this.rosterview.registerPresenceHandler(),this._super.afterReconnected.apply(this,arguments)}},initialize:function(){this.updateSettings({allow_chat_pending_contacts:!1,allow_contact_removal:!0,show_toolbar:!0});var t={dnd:a("This contact is busy"),online:a("This contact is online"),offline:a("This contact is offline"),unavailable:a("This contact is unavailable"),xa:a("This contact is away for an extended period"),away:a("This contact is away")},f=a("Click to hide these contacts"),l=a("Contacts"),c=a("Groups"),h=a("My contacts"),p=a("Pending contacts"),d=a("Contact requests"),v=a("Ungrouped"),m={};m[h]=0,m[v]=1,m[d]=2,m[p]=3,e.RosterView=Backbone.Overview.extend({tagName:"div",id:"converse-roster",events:{"keydown .roster-filter":"liveFilter","click .onX":"clearFilter","mousemove .x":"togglePointer","change .filter-type":"changeFilterType"},initialize:function(){this.roster_handler_ref=this.registerRosterHandler(),this.rosterx_handler_ref=this.registerRosterXHandler(),this.presence_ref=this.registerPresenceHandler(),e.roster.on("add",this.onContactAdd,this),e.roster.on("change",this.onContactChange,this),e.roster.on("destroy",this.update,this),e.roster.on("remove",this.update,this),this.model.on("add",this.onGroupAdd,this),this.model.on("reset",this.reset,this),this.$roster=n('<dl class="roster-contacts" style="display: none;"></dl>')},unregisterHandlers:function(){e.connection.deleteHandler(this.roster_handler_ref),delete this.roster_handler_ref,e.connection.deleteHandler(this.rosterx_handler_ref),delete this.rosterx_handler_ref,e.connection.deleteHandler(this.presence_ref),delete this.presence_ref},update:u.debounce(function(){var t=n("#online-count");return t.text("("+e.roster.getNumOnlineContacts()+")"),t.is(":visible")||t.show(),this.$roster.parent().length===0&&this.$el.append(this.$roster.show()),this.showHideFilter()},e.animate?100:0),render:function(){return this.$el.html(e.templates.roster({placeholder:a("Type to filter"),label_contacts:l,label_groups:c})),e.allow_contact_requests||this.$el.addClass("no-contact-requests"),this},fetch:function(){return this.model.fetch({silent:!0,success:function(t,n,r){t.length!==0&&this.positionFetchedGroups(t,n,r),e.roster.fetch({add:!0,success:function(t){t.length===0?e.roster.fetchFromServer(function(){e.xmppstatus.sendPresence()}):e.send_initial_presence&&e.xmppstatus.sendPresence()}})}.bind(this)}),this},changeFilterType:function(e){e&&e.preventDefault&&e.preventDefault(),this.clearFilter(),this.filter(this.$(".roster-filter").val(),e.target.value)},tog:function(e){return e?"addClass":"removeClass"},togglePointer:function(e){e&&e.preventDefault&&e.preventDefault();var t=e.target;n(t)[this.tog(t.offsetWidth-18<e.clientX-t.getBoundingClientRect().left)]("onX")},filter:function(e,t){e=e.toLowerCase(),t==="groups"?u.each(this.getAll(),function(t,n){t.model.get("name").toLowerCase().indexOf(e.toLowerCase())===-1?t.hide():t.model.contacts.length>0&&t.show()}):u.each(this.getAll(),function(n){n.filter(e,t)})},liveFilter:u.debounce(function(e){e&&e.preventDefault&&e.preventDefault();var t=this.$(".roster-filter"),n=t.val(),r=this.$(".filter-type").val();t[this.tog(n)]("x"),this.filter(n,r)},300),clearFilter:function(e){e&&e.preventDefault&&(e.preventDefault(),n(e.target).removeClass("x onX").val("")),this.filter("")},showHideFilter:function(){if(!this.$el.is(":visible"))return;var e=this.$(".roster-filter"),t=this.$(".filter-type"),n=e.is(":visible");if(n&&e.val().length>0)return;return this.$roster.hasScrollBar()?n||(e.show(),t.show()):(e.hide(),t.hide()),this},reset:function(){return e.roster.reset(),this.removeAll(),this.$roster=n('<dl class="roster-contacts" style="display: none;"></dl>'),this.render().update(),this},registerRosterHandler:function(){e.connection.addHandler(e.roster.onRosterPush.bind(e.roster),i.NS.ROSTER,"iq","set")},registerRosterXHandler:function(){var t=0;e.connection.addHandler(function(r){return window.setTimeout(function(){e.connection.flush(),e.roster.subscribeToSuggestedItems.bind(e.roster)(r)},t),t+=n(r).find("item").length*250,!0},i.NS.ROSTERX,"message",null)},registerPresenceHandler:function(){e.connection.addHandler(function(t){return e.roster.presenceHandler(t),!0}.bind(this),null,"presence",null)},onGroupAdd:function(t){var n=new e.RosterGroupView({model:t});this.add(t.get("name"),n.render()),this.positionGroup(n)},onContactAdd:function(e){this.addRosterContact(e).update()},onContactChange:function(e){this.updateChatBox(e).update(),u.has(e.changed,"subscription")&&(e.changed.subscription==="from"?this.addContactToGroup(e,p):u.contains(["both","to"],e.get("subscription"))&&this.addExistingContact(e)),u.has(e.changed,"ask")&&e.changed.ask==="subscribe"&&this.addContactToGroup(e,p),u.has(e.changed,"subscription")&&e.changed.requesting==="true"&&this.addContactToGroup(e,d),this.liveFilter()},updateChatBox:function(t){var n=e.chatboxes.get(t.get("jid")),r={};return n?(u.has(t.changed,"chat_status")&&(r.chat_status=t.get("chat_status")),u.has(t.changed,"status")&&(r.status=t.get("status")),n.save(r),this):this},positionFetchedGroups:function(t,n,r){t.sort(),t.each(function(t,n){var r=this.get(t.get("name"));r||(r=new e.RosterGroupView({model:t}),this.add(t.get("name"),r.render())),n===0?this.$roster.append(r.$el):this.appendGroup(r)}.bind(this))},positionGroup:function(e){var t=this.$roster.find(".roster-group"),r=t.length?this.model.indexOf(e.model):0;return r===0?this.$roster.prepend(e.$el):r===this.model.length-1?this.appendGroup(e):n(t.eq(r)).before(e.$el),this},appendGroup:function(e){var t=this.$roster.find(".roster-group").last(),n=t.siblings("dd");return n.length>0?n.last().after(e.$el):t.after(e.$el),this},getGroup:function(e){var t=this.get(e);return t?t.model:this.model.create({name:e,id:o(e)})},addContactToGroup:function(e,t){this.getGroup(t).contacts.add(e)},addExistingContact:function(t){var n;e.roster_groups?(n=t.get("groups"),n.length===0&&(n=[v])):n=[h],u.each(n,u.bind(this.addContactToGroup,this,t))},addRosterContact:function(e){return e.get("subscription")==="both"||e.get("subscription")==="to"?this.addExistingContact(e):e.get("ask")==="subscribe"||e.get("subscription")==="from"?this.addContactToGroup(e,p):e.get("requesting")===!0&&this.addContactToGroup(e,d),this}}),e.RosterContactView=Backbone.View.extend({tagName:"dd",events:{"click .accept-xmpp-request":"acceptRequest","click .decline-xmpp-request":"declineRequest","click .open-chat":"openChat","click .remove-xmpp-contact":"removeContact"},initialize:function(){this.model.on("change",this.render,this),this.model.on("remove",this.remove,this),this.model.on("destroy",this.remove,this),this.model.on("open",this.openChat,this)},render:function(){if(!this.model.showInRoster())return this.$el.hide(),this;this.$el[0].style.display==="none"&&this.$el.show();var n=this.model,r=n.get("ask"),i=n.get("chat_status"),s=n.get("requesting"),o=n.get("subscription"),f=["current-xmpp-contact","pending-xmpp-contact","requesting-xmpp-contact"].concat(u.keys(t));u.each(f,function(e){this.el.className.indexOf(e)!==-1&&this.$el.removeClass(e)},this),this.$el.addClass(i).data("status",i);if(r==="subscribe"||o==="from")this.$el.addClass("pending-xmpp-contact"),this.$el.html(e.templates.pending_contact(u.extend(n.toJSON(),{desc_remove:a("Click to remove this contact"),allow_chat_pending_contacts:e.allow_chat_pending_contacts})));else if(s===!0)this.$el.addClass("requesting-xmpp-contact"),this.$el.html(e.templates.requesting_contact(u.extend(n.toJSON(),{desc_accept:a("Click to accept this contact request"),desc_decline:a("Click to decline this contact request"),allow_chat_pending_contacts:e.allow_chat_pending_contacts}))),e.controlboxtoggle.showControlBox();else if(o==="both"||o==="to")this.$el.addClass("current-xmpp-contact"),this.$el.removeClass(u.without(["both","to"],o)[0]).addClass(o),this.$el.html(e.templates.roster_item(u.extend(n.toJSON(),{desc_status:t[i||"offline"],desc_chat:a("Click to chat with this contact"),desc_remove:a("Click to remove this contact"),title_fullname:a("Name"),allow_contact_removal:e.allow_contact_removal})));return this},openChat:function(t){return t&&t.preventDefault&&t.preventDefault(),e.chatboxviews.showChat(this.model.attributes)},removeContact:function(t){t&&t.preventDefault&&t.preventDefault();if(!e.allow_contact_removal)return;var n=confirm(a("Are you sure you want to remove this contact?"));if(n===!0){var r=s({type:"set"}).c("query",{xmlns:i.NS.ROSTER}).c("item",{jid:this.model.get("jid"),subscription:"remove"});e.connection.sendIQ(r,function(e){this.model.destroy(),this.remove()}.bind(this),function(t){alert(a("Sorry, there was an error while trying to remove "+name+" as a contact.")),e.log(t)})}},acceptRequest:function(t){t&&t.preventDefault&&t.preventDefault(),e.roster.sendContactAddIQ(this.model.get("jid"),this.model.get("fullname"),[],function(){this.model.authorize().subscribe()}.bind(this))},declineRequest:function(e){e&&e.preventDefault&&e.preventDefault();var t=confirm(a("Are you sure you want to decline this contact request?"));return t===!0&&this.model.unauthorize().destroy(),this}}),e.RosterGroup=Backbone.Model.extend({initialize:function(t,n){this.set(u.extend({description:f,state:e.OPENED},t)),this.contacts=new e.RosterContacts}}),e.RosterGroupView=Backbone.Overview.extend({tagName:"dt",className:"roster-group",events:{"click a.group-toggle":"toggle"},initialize:function(){this.model.contacts.on("add",this.addContact,this),this.model.contacts.on("change:subscription",this.onContactSubscriptionChange,this),this.model.contacts.on("change:requesting",this.onContactRequestChange,this),this.model.contacts.on("change:chat_status",function(e){this.model.contacts.sort(),this.positionContact(e).render()},this),this.model.contacts.on("destroy",this.onRemove,this),this.model.contacts.on("remove",this.onRemove,this),e.roster.on("change:groups",this.onContactGroupChange,this)},render:function(){return this.$el.attr("data-group",this.model.get("name")),this.$el.html(n(e.templates.group_header({label_group:this.model.get("name"),desc_group_toggle:this.model.get("description"),toggle_state:this.model.get("state")}))),this},addContact:function(t){var n=new e.RosterContactView({model:t});this.add(t.get("id"),n),n=this.positionContact(t).render(),t.showInRoster()&&(this.model.get("state")===e.CLOSED?(n.$el[0].style.display!=="none"&&n.$el.hide(),this.$el.is(":visible")||this.$el.show()):this.$el[0].style.display!=="block"&&this.show())},positionContact:function(e){var t=this.get(e.get("id")),n=this.model.contacts.indexOf(e);return t.$el.detach(),n===0?this.$el.after(t.$el):n===this.model.contacts.length-1?this.$el.nextUntil("dt").last().after(t.$el):this.$el.nextUntil("dt").eq(n).before(t.$el),t},show:function(){this.$el.show(),u.each(this.getAll(),function(e){e.model.showInRoster()&&e.$el.show()})},hide:function(){this.$el.nextUntil("dt").addBack().hide()},filter:function(t){var n;t.length===0?(this.model.get("state")===e.OPENED&&this.model.contacts.each(function(e){e.showInRoster()&&this.get(e.get("id")).$el.show()}.bind(this)),this.showIfNecessary()):(t=t.toLowerCase(),n=this.model.contacts.filter(r.contains.not("fullname",t)),n.length===this.model.contacts.length?this.hide():(u.each(n,function(e){this.get(e.get("id")).$el.hide()}.bind(this)),u.each(this.model.contacts.reject(r.contains.not("fullname",t)),function(e){this.get(e.get("id")).$el.show()}.bind(this)),this.showIfNecessary()))},showIfNecessary:function(){!this.$el.is(":visible")&&this.model.contacts.length>0&&this.$el.show()},toggle:function(t){t&&t.preventDefault&&t.preventDefault();var r=n(t.target);r.hasClass("icon-opened")?(this.$el.nextUntil("dt").slideUp(),this.model.save({state:e.CLOSED}),r.removeClass("icon-opened").addClass("icon-closed")):(r.removeClass("icon-closed").addClass("icon-opened"),this.model.save({state:e.OPENED}),this.filter(e.rosterview.$(".roster-filter").val(),e.rosterview.$(".filter-type").val()))},onContactGroupChange:function(e){var t=u.contains(e.get("groups"),this.model.get("name")),n=e.get("id"),r=!this.get(n);t&&!r?this.model.contacts.remove(n):!t&&r&&this.addContact(e)},onContactSubscriptionChange:function(e){this.model.get("name")===p&&e.get("subscription")!=="from"&&this.model.contacts.remove(e.get("id"))},onContactRequestChange:function(e){this.model.get("name")===d&&!e.get("requesting")&&this.model.contacts.remove(e.get("id"))},onRemove:function(e){this.remove(e.get("id")),this.model.contacts.length===0&&this.$el.hide()}}),e.RosterGroups=Backbone.Collection.extend({model:e.RosterGroup,comparator:function(e,t){e=e.get("name"),t=t.get("name");var n=u.keys(m),r=u.contains(n,e),i=u.contains(n,t);if(!r&&!i)return e.toLowerCase()<t.toLowerCase()?-1:e.toLowerCase()>t.toLowerCase()?1:0;if(r&&i)return m[e]<m[t]?-1:m[e]>m[t]?1:0;if(!r&&i)return t===h?1:-1;if(r&&!i)return e===h?-1:1}})}})}),function(e,t){define("converse-controlbox",["converse-core","converse-api","converse-rosterview","converse-chatview"],t)}(this,function(e,t){"use strict";var n=t.env.Strophe,r=t.env.b64_sha1,i=t.env.utils,s=t.env.jQuery,o=t.env._,u=i.__.bind(e),a=t.env.moment;t.plugins.add("controlbox",{overrides:{initSession:function(){this.controlboxtoggle=new this.ControlBoxToggle,this._super.initSession.apply(this,arguments)},initConnection:function(){this._super.initConnection.apply(this,arguments),this.connection&&this.addControlBox()},_tearDown:function(){this._super._tearDown.apply(this,arguments),this.rosterview&&(this.rosterview.unregisterHandlers(),this.rosterview.model.off().reset(),this.rosterview.undelegateEvents().remove())},clearSession:function(){this._super.clearSession.apply(this,arguments),this.connection.connected&&this.chatboxes.get("controlbox").save({connected:!1})},ChatBoxes:{chatBoxShouldBeShown:function(e){return this._super.chatBoxShouldBeShown.apply(this,arguments)&&e.get("id")!=="controlbox"},onChatBoxesFetched:function(e,t){this._super.onChatBoxesFetched.apply(this,arguments),o.include(o.pluck(t,"id"),"controlbox")||this.add({id:"controlbox",box_id:"controlbox"}),this.get("controlbox").save({connected:!0})}},ChatBoxViews:{onChatBoxAdded:function(t){var n=this.get(t.get("id"));!n&&t.get("box_id")==="controlbox"?(n=new e.ControlBoxView({model:t}),this.add(t.get("id"),n)):this._super.onChatBoxAdded.apply(this,arguments)},closeAllChatBoxes:function(){return this.each(function(e){e.model.get("id")!=="controlbox"&&e.close()}),this},getOldestMaximizedChat:function(e){return e.push("controlbox"),this._super.getOldestMaximizedChat.apply(this,arguments)},getChatBoxWidth:function(t){var n=this.get("controlbox");return t.model.get("id")==="controlbox"?!n||!n.$el.is(":visible")?e.controlboxtoggle.$el.outerWidth(!0):n.$el.outerWidth(!0):this._super.getChatBoxWidth.apply(this,arguments)}},ChatBox:{initialize:function(){this.get("id")==="controlbox"?this.set(o.extend(this.getDefaultSettings(),{time_opened:a(0).valueOf()})):this._super.initialize.apply(this,arguments)}},ChatBoxView:{insertIntoPage:function(){return this.$el.insertAfter(e.chatboxviews.get("controlbox").$el),this},maximize:function(){var t=e.chatboxviews;return this.$el.insertAfter(t.get("controlbox").$el).show("fast",this.onMaximized.bind(this)),this}}},initialize:function(){var e=this.converse;this.updateSettings({allow_logout:!0,default_domain:undefined,show_controlbox_by_default:!1,xhr_user_search:!1,xhr_user_search_url:""});var t=u("Contacts");e.addControlBox=function(){return e.chatboxes.add({id:"controlbox",box_id:"controlbox",closed:!e.show_controlbox_by_default})},e.renderLoginPanel=function(){e._tearDown();var t=e.chatboxviews.get("controlbox");t.model.set({connected:!1}),t.renderLoginPanel()},e.ControlBoxView=e.ChatBoxView.extend({tagName:"div",className:"chatbox",id:"controlbox",events:{"click a.close-chatbox-button":"close","click ul#controlbox-tabs li a":"switchTab","mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},initialize:function(){this.$el.insertAfter(e.controlboxtoggle.$el),s(window).on("resize",o.debounce(this.setDimensions.bind(this),100)),this.model.on("change:connected",this.onConnected,this),this.model.on("destroy",this.hide,this),this.model.on("hide",this.hide,this),this.model.on("show",this.show,this),this.model.on("change:closed",this.ensureClosedState,this),this.render(),this.model.get("connected")&&this.initRoster(),typeof this.model.get("closed")=="undefined"&&this.model.set("closed",!e.show_controlbox_by_default),this.model.get("closed")?this.hide():this.show()},render:function(){return!e.connection.connected||!e.connection.authenticated||e.connection.disconnecting?this.renderLoginPanel():(!this.contactspanel||!this.contactspanel.$el.is(":visible"))&&this.renderContactsPanel(),this},giveFeedback:function(e,t){var n=this.$(".conn-feedback");n.addClass("conn-feedback").text(e),t&&n.addClass(t)},onConnected:function(){this.model.get("connected")&&this.render().initRoster()},initRoster:function(){var t=new e.RosterGroups;return t.browserStorage=new Backbone.BrowserStorage[e.storage](r("converse.roster.groups"+e.bare_jid)),e.rosterview=new e.RosterView({model:t}),this.contactspanel.$el.append(e.rosterview.$el),e.rosterview.render().fetch().update(),this},renderLoginPanel:function(){var t=this.$(".conn-feedback");this.$el.html(e.templates.controlbox(this.model.toJSON()));var n={$parent:this.$el.find(".controlbox-panes"),model:this};return this.loginpanel?this.loginpanel.delegateEvents().initialize(n):this.loginpanel=new e.LoginPanel(n),this.loginpanel.render(),this.initDragResize().setDimensions(),t.length&&t.text()!==u("Connecting")&&this.$(".conn-feedback").replaceWith(t),this},renderContactsPanel:function(){this.$el.html(e.templates.controlbox(this.model.toJSON())),this.contactspanel=new e.ContactsPanel({$parent:this.$el.find(".controlbox-panes")}),this.contactspanel.render(),e.xmppstatusview=new e.XMPPStatusView({model:e.xmppstatus}),e.xmppstatusview.render(),this.initDragResize().setDimensions()},close:function(t){return t&&t.preventDefault&&t.preventDefault(),e.connection.connected?this.model.save({closed:!0}):this.model.trigger("hide"),e.emit("controlBoxClosed",this),this},ensureClosedState:function(){this.model.get("closed")?this.hide():this.show()},hide:function(t){return this.$el.hide("fast",function(){i.refreshWebkit(),e.emit("chatBoxClosed",this),e.controlboxtoggle.show(function(){typeof t=="function"&&t()})}),this},onControlBoxToggleHidden:function(){this.$el.show("fast",function(){e.rosterview&&e.rosterview.update(),i.refreshWebkit(),e.emit("controlBoxOpened",this)}.bind(this))},show:function(){return e.controlboxtoggle.hide(this.onControlBoxToggleHidden.bind(this)),this},switchTab:function(e){e&&e.preventDefault&&e.preventDefault();var t=s(e.target),n=t.parent().siblings("li").children("a"),r=s(t.attr("href"));return s(n.attr("href")).hide(),n.removeClass("current"),t.addClass("current"),r.show(),this},showHelpMessages:function(e){return}}),e.LoginPanel=Backbone.View.extend({tagName:"div",id:"login-dialog",className:"controlbox-pane",events:{"submit form#converse-login":"authenticate"},initialize:function(t){t.$parent.html(this.$el.html(e.templates.login_panel({LOGIN:e.LOGIN,ANONYMOUS:e.ANONYMOUS,PREBIND:e.PREBIND,auto_login:e.auto_login,authentication:e.authentication,label_username:u("XMPP Username:"),label_password:u("Password:"),label_anon_login:u("Click here to log in anonymously"),label_login:u("Log In"),placeholder_username:(e.locked_domain||e.default_domain)&&u("Username")||u("user@server"),placeholder_password:u("password")}))),this.$tabs=t.$parent.parent().find("#controlbox-tabs")},render:function(){return this.$tabs.append(e.templates.login_tab({label_sign_in:u("Sign in")})),this.$el.find("input#jid").focus(),this.$el.is(":visible")||this.$el.show(),this},authenticate:function(t){t&&t.preventDefault&&t.preventDefault();var r=s(t.target);if(e.authentication===e.ANONYMOUS){this.connect(r,e.jid,null);return}var i=r.find("input[name=jid]"),o=i.val(),u=r.find("input[name=password]"),a=u.val(),f=!1;o||(f=!0,i.addClass("error")),a||(f=!0,u.addClass("error"));if(f)return;return e.locked_domain?o=n.escapeNode(o)+"@"+e.locked_domain:e.default_domain&&o.indexOf("@")===-1&&(o=o+"@"+e.default_domain),this.connect(r,o,a),!1},connect:function(t,r,i){var s;t&&t.find("input[type=submit]").hide().after('<span class="spinner login-submit"/>'),r&&(s=n.getResourceFromJid(r),s?r=n.getBareJidFromJid(r).toLowerCase()+"/"+s:r=r.toLowerCase()+e.generateResource()),e.connection.connect(r,i,e.onConnectStatusChanged)},remove:function(){this.$tabs.empty(),this.$el.parent().empty()}}),e.XMPPStatusView=Backbone.View.extend({el:"span#xmpp-status-holder",events:{"click a.choose-xmpp-status":"toggleOptions","click #fancy-xmpp-status-select a.change-xmpp-status-message":"renderStatusChangeForm","submit #set-custom-xmpp-status":"setStatusMessage","click .dropdown dd ul li a":"setStatus"},initialize:function(){this.model.on("change:status",this.updateStatusUI,this),this.model.on("change:status_message",this.updateStatusUI,this),this.model.on("update-status-ui",this.updateStatusUI,this)},render:function(){var t=this.$el.find("select#select-xmpp-status"),n=this.model.get("status")||"offline",r=s("option",t),i,o=[];return this.$el.html(e.templates.choose_status()),this.$el.find("#fancy-xmpp-status-select").html(e.templates.chat_status({status_message:this.model.get("status_message")||u("I am %1$s",this.getPrettyStatus(n)),chat_status:n,desc_custom_status:u("Click here to write a custom status message"),desc_change_status:u("Click to change your chat status")})),r.each(function(){o.push(e.templates.status_option({value:s(this).val(),text:this.text}))}),i=this.$el.find("#target dd ul").hide(),i.append(o.join("")),t.remove(),this},toggleOptions:function(e){e.preventDefault(),s(e.target).parent().parent().siblings("dd").find("ul").toggle("fast")},renderStatusChangeForm:function(t){t.preventDefault();var n=this.model.get("status")||"offline",r=e.templates.change_status_message({status_message:n,label_custom_status:u("Custom status"),label_save:u("Save")}),i=this.$el.find(".xmpp-status");i.parent().addClass("no-border"),i.replaceWith(r),this.$el.find(".custom-xmpp-status").focus().focus()},setStatusMessage:function(e){e.preventDefault(),this.model.setStatusMessage(s(e.target).find("input").val())},setStatus:function(t){t.preventDefault();var n=s(t.currentTarget),r=n.attr("data-value");r==="logout"?(this.$el.find(".dropdown dd ul").hide(),e.logOut()):(this.model.setStatus(r),this.$el.find(".dropdown dd ul").hide())},getPrettyStatus:function(e){return e==="chat"?u("online"):e==="dnd"?u("busy"):e==="xa"?u("away for long"):e==="away"?u("away"):e==="offline"?u("offline"):u(e)||u("online")},updateStatusUI:function(t){var n=t.get("status"),r=t.get("status_message")||u("I am %1$s",this.getPrettyStatus(n));this.$el.find("#fancy-xmpp-status-select").removeClass("no-border").html(e.templates.chat_status({chat_status:n,status_message:r,desc_custom_status:u("Click here to write a custom status message"),desc_change_status:u("Click to change your chat status")}))}}),e.ContactsPanel=Backbone.View.extend({tagName:"div",className:"controlbox-pane",id:"users",events:{"click a.toggle-xmpp-contact-form":"toggleContactForm","submit form.add-xmpp-contact":"addContactFromForm","submit form.search-xmpp-contact":"searchContacts","click a.subscribe-to-user":"addContactFromList"},initialize:function(e){e.$parent.append(this.$el),this.$tabs=e.$parent.parent().find("#controlbox-tabs")},render:function(){var n,r=e.templates.contacts_panel({label_online:u("Online"),label_busy:u("Busy"),label_away:u("Away"),label_offline:u("Offline"),label_logout:u("Log out"),include_offline_state:e.include_offline_state,allow_logout:e.allow_logout});return this.$tabs.append(e.templates.contacts_tab({label_contacts:t})),e.xhr_user_search?n=e.templates.search_contact({label_contact_name:u("Contact name"),label_search:u("Search")}):n=e.templates.add_contact_form({label_contact_username:u("e.g. user@example.com"),label_add:u("Add")}),e.allow_contact_requests&&(r+=e.templates.add_contact_dropdown({label_click_to_chat:u("Click to add new chat contacts"),label_add_contact:u("Add a contact")})),this.$el.html(r),this.$el.find(".search-xmpp ul").append(n),this},toggleContactForm:function(e){e.preventDefault(),this.$el.find(".search-xmpp").toggle("fast",function(){s(this).is(":visible")&&s(this).find("input.username").focus()})},searchContacts:function(t){t.preventDefault(),s.getJSON(e.xhr_user_search_url+"?q="+s(t.target).find("input.username").val(),function(e){var t=s(".search-xmpp ul");t.find("li.found-user").remove(),t.find("li.chat-info").remove(),e.length||t.append('<li class="chat-info">'+u("No users found")+"</li>"),s(e).each(function(e,r){t.append(s('<li class="found-user"></li>').append(s('<a class="subscribe-to-user" href="#" title="'+u("Click to add as a chat contact")+'"></a>').attr("data-recipient",n.getNodeFromJid(r.id)+"@"+n.getDomainFromJid(r.id)).text(r.fullname)))})})},addContactFromForm:function(t){t.preventDefault();var n=s(t.target).find("input"),r=n.val();if(!r){n.addClass("error");return}e.roster.addAndSubscribe(r),s(".search-xmpp").hide()},addContactFromList:function(t){t.preventDefault();var n=s(t.target),r=n.attr("data-recipient"),i=n.text();e.roster.addAndSubscribe(r,i),n.parent().remove(),s(".search-xmpp").hide()}}),e.ControlBoxToggle=Backbone.View.extend({tagName:"a",className:"toggle-controlbox",id:"toggle-controlbox",events:{click:"onClick"},attributes:{href:"#"},initialize:function(){this.render()},render:function(){return s("#conversejs").prepend(this.$el.html(e.templates.controlbox_toggle({label_toggle:u("Toggle chat")}))),this.$el.hide(),this},hide:function(e){this.$el.fadeOut("fast",e)},show:function(e){this.$el.show("fast",e)},showControlBox:function(){var t=e.chatboxes.get("controlbox");t||(t=e.addControlBox()),e.connection.connected?t.save({closed:!1}):t.trigger("show")},onClick:function(t){t.preventDefault();if(s("div#controlbox").is(":visible")){var n=e.chatboxes.get("controlbox");e.connection.connected?n.save({closed:!0}):n.trigger("hide")}else this.showControlBox()}})}})}),function(e,t){define("converse-muc",["converse-core","converse-api","typeahead","converse-chatview","converse-controlbox"],t)}(this,function(e,t){"use strict";var n=t.env.Strophe,r=t.env.$iq,i=t.env.$build,s=t.env.$msg,o=t.env.$pres,u=t.env.b64_sha1,a=t.env.utils,f=t.env.jQuery,l=t.env._,c=t.env.moment,h=a.__.bind(e),p=a.___;n.addNamespace("MUC_ADMIN",n.NS.MUC+"#admin"),n.addNamespace("MUC_OWNER",n.NS.MUC+"#owner"),n.addNamespace("MUC_REGISTER","jabber:iq:register"),n.addNamespace("MUC_ROOMCONF",n.NS.MUC+"#roomconfig"),n.addNamespace("MUC_USER",n.NS.MUC+"#user"),t.plugins.add("muc",{overrides:{wrappedChatBox:function(t){if(!t)return;var n=e.chatboxviews.get(t.get("jid")),r=this._super.wrappedChatBox.apply(this,arguments);return r.is_chatroom=n.is_chatroom,r},Features:{addClientFeatures:function(){this._super.addClientFeatures.apply(this,arguments),e.connection.disco.addFeature("jabber:x:conference"),this.allow_muc&&this.connection.disco.addFeature(n.NS.MUC)}},ControlBoxView:{renderContactsPanel:function(){var e=this._super.converse;this._super.renderContactsPanel.apply(this,arguments),e.allow_muc&&(this.roomspanel=new e.RoomsPanel({$parent:this.$el.find(".controlbox-panes"),model:new(Backbone.Model.extend({id:u("converse.roomspanel"+e.bare_jid),browserStorage:new Backbone.BrowserStorage[e.storage](u("converse.roomspanel"+e.bare_jid))}))}),this.roomspanel.render().model.fetch(),this.roomspanel.model.get("nick")||this.roomspanel.model.save({nick:n.getNodeFromJid(e.bare_jid)}))},onConnected:function(){var e=this._super.converse;this._super.onConnected.apply(this,arguments);if(this.model.get("connected")){e.features.off("add",this.featureAdded,this),e.features.on("add",this.featureAdded,this);var t=e.features.findWhere({"var":n.NS.MUC});t&&this.featureAdded(t)}},featureAdded:function(e){var t=this._super.converse;if(e.get("var")===n.NS.MUC&&t.allow_muc){this.roomspanel.model.save({muc_domain:e.get("from")});var r=this.$el.find("input.new-chatroom-server");r.is(":focus")||r.val(this.roomspanel.model.get("muc_domain"))}}},ChatBoxes:{registerMessageHandler:function(){this._super.registerMessageHandler.apply(this,arguments),this._super.converse.connection.addHandler(function(e){return this.onInvite(e),!0}.bind(this),"jabber:x:conference","message")},onInvite:function(e){var t=this._super.converse,r=f(e),i=r.children('x[xmlns="jabber:x:conference"]'),s=n.getBareJidFromJid(r.attr("from")),o=i.attr("jid"),a=i.attr("reason"),c=t.roster.get(s),d;t.auto_join_on_invite?d=!0:(c=c?c.get("fullname"):n.getNodeFromJid(s),a?d=confirm(h(p('%1$s has invited you to join a chat room: %2$s, and left the following reason: "%3$s"'),c,o,a)):d=confirm(h(p("%1$s has invited you to join a chat room: %2$s"),c,o)));if(d===!0){var v=t.chatboxviews.showChat({id:o,jid:o,name:n.unescapeNode(n.getNodeFromJid(o)),nick:n.unescapeNode(n.getNodeFromJid(t.connection.jid)),chatroom:!0,box_id:u(o),password:i.attr("password")});l.contains([n.Status.CONNECTING,n.Status.CONNECTED],v.get("connection_status"))||t.chatboxviews.get(o).join(null)}}},ChatBoxViews:{onChatBoxAdded:function(t){var n=this.get(t.get("id"));!n&&t.get("chatroom")?(n=new e.ChatRoomView({model:t}),this.add(t.get("id"),n)):this._super.onChatBoxAdded.apply(this,arguments)}}},initialize:function(){var e=this.converse;this.updateSettings({allow_muc:!0,auto_join_on_invite:!1,auto_list_rooms:!1,hide_muc_server:!1,muc_history_max_stanzas:undefined,show_toolbar:!0}),e.ChatRoomView=e.ChatBoxView.extend({length:300,tagName:"div",className:"chatbox chatroom",events:{"click .close-chatbox-button":"close","click .toggle-chatbox-button":"minimize","click .configure-chatroom-button":"configureChatRoom","click .toggle-smiley":"toggleEmoticonMenu","click .toggle-smiley ul li":"insertEmoticon","click .toggle-clear":"clearChatRoomMessages","click .toggle-call":"toggleCall","click .toggle-occupants a":"toggleOccupants","keypress textarea.chat-textarea":"keyPressed","mousedown .dragresize-top":"onStartVerticalResize","mousedown .dragresize-left":"onStartHorizontalResize","mousedown .dragresize-topleft":"onStartDiagonalResize"},is_chatroom:!0,initialize:function(){f(window).on("resize",l.debounce(this.setDimensions.bind(this),100)),this.model.messages.on("add",this.onMessageAdded,this),this.model.on("change:minimized",function(e){e.get("minimized")?this.hide():this.maximize()},this),this.model.on("destroy",function(){this.hide().leave()},this),this.occupantsview=new e.ChatRoomOccupantsView({model:new e.ChatRoomOccupants({nick:this.model.get("nick")})});var t=u("converse.occupants"+e.bare_jid+this.model.get("id")+this.model.get("nick"));this.occupantsview.model.browserStorage=new Backbone.BrowserStorage[e.storage](t),this.occupantsview.chatroomview=this,this.render().$el.hide(),this.occupantsview.model.fetch({add:!0}),this.join(null,{maxstanzas:e.muc_history_max_stanzas}),this.fetchMessages(),e.emit("chatRoomOpened",this),this.$el.insertAfter(e.chatboxviews.get("controlbox").$el),this.model.get("minimized")?this.hide():this.show()},render:function(){return this.$el.attr("id",this.model.get("box_id")).html(e.templates.chatroom(this.model.toJSON())),this.renderChatArea(),this.$content.on("scroll",l.debounce(this.onScroll.bind(this),100)),this.setWidth(),setTimeout(e.refreshWebkit,50),this},renderChatArea:function(){return this.$(".chat-area").length||(this.$(".chatroom-body").empty().append(e.templates.chatarea({show_toolbar:e.show_toolbar,label_message:h("Message")})).append(this.occupantsview.render().$el),this.renderToolbar(),this.$content=this.$el.find(".chat-content")),this.toggleOccupants(null,!0),this},toggleOccupants:function(e,t){e&&(e.preventDefault(),e.stopPropagation()),t&&this.model.set({hidden_occupants:!this.model.get("hidden_occupants")});var n=this.$(".icon-hide-users");this.model.get("hidden_occupants")?(this.model.save({hidden_occupants:!1}),n.removeClass("icon-show-users").addClass("icon-hide-users"),this.$(".chat-area").removeClass("full"),this.$("div.occupants").removeClass("hidden"),this.scrollDown()):(this.model.save({hidden_occupants:!0}),n.removeClass("icon-hide-users").addClass("icon-show-users"),this.$(".occupants").addClass("hidden"),this.$(".chat-area").addClass("full"),this.scrollDown())},directInvite:function(t,n){var r={xmlns:"jabber:x:conference",jid:this.model.get("jid")};n!==null&&(r.reason=n),this.model.get("password")&&(r.password=this.model.get("password"));var i=s({from:e.connection.jid,to:t,id:e.connection.getUniqueId()}).c("x",r);e.connection.send(i),e.emit("roomInviteSent",{room:this,recipient:t,reason:n})},onCommandError:function(e){this.showStatusNotification(h("Error: could not execute the command"),!0)},sendChatRoomMessage:function(t){var n=e.connection.getUniqueId(),r=s({to:this.model.get("jid"),from:e.connection.jid,type:"groupchat",id:n}).c("body").t(t).up().c("x",{xmlns:"jabber:x:event"}).c("composing");e.connection.send(r);var i=e.xmppstatus.get("fullname");this.model.messages.create({fullname:l.isEmpty(i)?e.bare_jid:i,sender:"me",time:c().format(),message:t,msgid:n})},setAffiliation:function(t,s,o,u,a,f){var l=i("item",{jid:s,affiliation:o}),c=r({to:t,type:"set"}).c("query",{xmlns:n.NS.MUC_ADMIN}).cnode(l.node);return u!==null&&c.c("reason",u),e.connection.sendIQ(c.tree(),a,f)},modifyRole:function(t,s,o,u,a,f){var l=i("item",{nick:s,role:o}),c=r({to:t,type:"set"}).c("query",{xmlns:n.NS.MUC_ADMIN}).cnode(l.node);return u!==null&&c.c("reason",u),e.connection.sendIQ(c.tree(),a,f)},member:function(e,t,n,r,i){return this.setAffiliation(e,t,"member",n,r,i)},revoke:function(e,t,n,r,i){return this.setAffiliation(e,t,"none",n,r,i)},owner:function(e,t,n,r,i){return this.setAffiliation(e,t,"owner",n,r,i)},admin:function(e,t,n,r,i){return this.setAffiliation(e,t,"admin",n,r,i)},validateRoleChangeCommand:function(e,t){return t.length<1||t.length>2?(this.showStatusNotification(h('Error: the "'+e+"\" command takes two arguments, the user's nickname and optionally a reason."),!0),!1):!0},clearChatRoomMessages:function(e){typeof e!="undefined"&&e.stopPropagation();var t=confirm(h("Are you sure you want to clear the messages from this room?"));return t===!0&&this.$content.empty(),this},onChatRoomMessageSubmitted:function(t){var n=t.replace(/^\s*/,"").match(/^\/(.*?)(?: (.*))?$/)||[!1,"",""],r=n[2]&&n[2].splitOnce(" ")||[];switch(n[1]){case"admin":if(!this.validateRoleChangeCommand(n[1],r))break;this.setAffiliation(this.model.get("jid"),r[0],"admin",r[1],undefined,this.onCommandError.bind(this));break;case"ban":if(!this.validateRoleChangeCommand(n[1],r))break;this.setAffiliation(this.model.get("jid"),r[0],"outcast",r[1],undefined,this.onCommandError.bind(this));break;case"clear":this.clearChatRoomMessages();break;case"deop":if(!this.validateRoleChangeCommand(n[1],r))break;this.modifyRole(this.model.get("jid"),r[0],"occupant",r[1],undefined,this.onCommandError.bind(this));break;case"help":this.showHelpMessages(["<strong>/admin</strong>: "+h("Change user's affiliation to admin"),"<strong>/ban</strong>: "+h("Ban user from room"),"<strong>/clear</strong>: "+h("Remove messages"),"<strong>/deop</strong>: "+h("Change user role to occupant"),"<strong>/help</strong>: "+h("Show this menu"),"<strong>/kick</strong>: "+h("Kick user from room"),"<strong>/me</strong>: "+h("Write in 3rd person"),"<strong>/member</strong>: "+h("Grant membership to a user"),"<strong>/mute</strong>: "+h("Remove user's ability to post messages"),"<strong>/nick</strong>: "+h("Change your nickname"),"<strong>/op</strong>: "+h("Grant moderator role to user"),"<strong>/owner</strong>: "+h("Grant ownership of this room"),"<strong>/revoke</strong>: "+h("Revoke user's membership"),"<strong>/topic</strong>: "+h("Set room topic"),"<strong>/voice</strong>: "+h("Allow muted user to post messages")]);break;case"kick":if(!this.validateRoleChangeCommand(n[1],r))break;this.modifyRole(this.model.get("jid"),r[0],"none",r[1],undefined,this.onCommandError.bind(this));break;case"mute":if(!this.validateRoleChangeCommand(n[1],r))break;this.modifyRole(this.model.get("jid"),r[0],"visitor",r[1],undefined,this.onCommandError.bind(this));break;case"member":if(!this.validateRoleChangeCommand(n[1],r))break;this.setAffiliation(this.model.get("jid"),r[0],"member",r[1],undefined,this.onCommandError.bind(this));break;case"nick":e.connection.send(o({from:e.connection.jid,to:this.getRoomJIDAndNick(n[2]),id:e.connection.getUniqueId()}).tree());break;case"owner":if(!this.validateRoleChangeCommand(n[1],r))break;this.setAffiliation(this.model.get("jid"),r[0],"owner",r[1],undefined,this.onCommandError.bind(this));break;case"op":if(!this.validateRoleChangeCommand(n[1],r))break;this.modifyRole(this.model.get("jid"),r[0],"moderator",r[1],undefined,this.onCommandError.bind(this));break;case"revoke":if(!this.validateRoleChangeCommand(n[1],r))break;this.setAffiliation(this.model.get("jid"),r[0],"none",r[1],undefined,this.onCommandError.bind(this));break;case"topic":e.connection.send(s({to:this.model.get("jid"),from:e.connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(n[2]).tree());break;case"voice":if(!this.validateRoleChangeCommand(n[1],r))break;this.modifyRole(this.model.get("jid"),r[0],"occupant",r[1],undefined,this.onCommandError.bind(this));break;default:this.sendChatRoomMessage(t)}},handleMUCStanza:function(e){var t,r,i,s=e.getAttribute("from"),o=f(e).find('[xmlns="'+n.NS.MAM+'"]').length>0;if(!s||this.model.get("id")!==s.split("/")[0]||o)return!0;if(e.nodeName==="message")l.compose(this.onChatRoomMessage.bind(this),this.showStatusMessages.bind(this))(e);else if(e.nodeName==="presence"){r=e.getElementsByTagName("x");if(r.length>0)for(i=0;i<r.length;i++){t=r[i].getAttribute("xmlns");if(t&&t.match(n.NS.MUC)){this.onChatRoomPresence(e);break}}}return!0},getRoomJIDAndNick:function(e){e=e||this.model.get("nick");var t=this.model.get("jid"),r=n.getNodeFromJid(t),i=n.getDomainFromJid(t);return r+"@"+i+(e!==null?"/"+e:"")},join:function(t,r,i){var s=o({from:e.connection.jid,to:this.getRoomJIDAndNick()}).c("x",{xmlns:n.NS.MUC});return typeof r=="object"&&Object.keys(r).length&&(s=s.c("history",r).up()),t&&s.cnode(n.xmlElement("password",[],t)),typeof i!="undefined"&&i!==null&&s.up.cnode(i),this.handler||(this.handler=e.connection.addHandler(this.handleMUCStanza.bind(this))),this.model.set("connection_status",n.Status.CONNECTING),e.connection.send(s)},leave:function(t){var r=e.connection.getUniqueId(),i=o({type:"unavailable",id:r,from:e.connection.jid,to:this.getRoomJIDAndNick()});t!==null&&i.c("status",t),e.connection.addHandler(function(){this.model.set("connection_status",n.Status.DISCONNECTED)}.bind(this),null,"presence",null,r),e.connection.send(i)},renderConfigurationForm:function(e){var t=this.$el.find("form.chatroom-form"),n=t.children("fieldset:first"),r=f(e),i=r.find("field"),s=r.find("title").text(),o=r.find("instructions").text();n.find("span.spinner").remove(),n.append(f("<legend>").text(s)),o&&o!==s&&n.append(f('<p class="instructions">').text(o)),l.each(i,function(e){n.append(a.xForm2webForm(f(e),r))}),t.append("<fieldset></fieldset>"),n=t.children("fieldset:last"),n.append('<input type="submit" class="pure-button button-primary" value="'+h("Save")+'"/>'),n.append('<input type="button" class="pure-button button-cancel" value="'+h("Cancel")+'"/>'),n.find("input[type=button]").on("click",this.cancelConfiguration.bind(this)),t.on("submit",this.saveConfiguration.bind(this))},sendConfiguration:function(t,i,s){var o=r({to:this.model.get("jid"),type:"set"}).c("query",{xmlns:n.NS.MUC_OWNER}).c("x",{xmlns:n.NS.XFORM,type:"submit"});return l.each(t,function(e){o.cnode(e).up()}),e.connection.sendIQ(o.tree(),i,s)},saveConfiguration:function(e){e.preventDefault();var t=this,n=f(e.target).find(":input:not([type=button]):not([type=submit])"),r=n.length,i=[];n.each(function(){i.push(a.webForm2xForm(this)),--r||t.sendConfiguration(i,t.onConfigSaved.bind(t),t.onErrorConfigSaved.bind(t))}),this.$el.find("div.chatroom-form-container").hide(function(){f(this).remove(),t.$el.find(".chat-area").removeClass("hidden"),t.$el.find(".occupants").removeClass("hidden")})},onConfigSaved:function(e){},onErrorConfigSaved:function(e){this.showStatusNotification(h("An error occurred while trying to save the form."))},cancelConfiguration:function(e){e.preventDefault();var t=this;this.$el.find("div.chatroom-form-container").hide(function(){f(this).remove(),t.$el.find(".chat-area").removeClass("hidden"),t.$el.find(".occupants").removeClass("hidden")})},configureChatRoom:function(t){t.preventDefault();if(this.$el.find("div.chatroom-form-container").length)return;this.$(".chatroom-body").children().addClass("hidden"),this.$(".chatroom-body").append(e.templates.chatroom_form()),e.connection.sendIQ(r({to:this.model.get("jid"),type:"get"}).c("query",{xmlns:n.NS.MUC_OWNER}).tree(),this.renderConfigurationForm.bind(this))},submitPassword:function(e){e.preventDefault();var t=this.$el.find(".chatroom-form").find("input[type=password]").val();this.$el.find(".chatroom-form-container").replaceWith('<span class="spinner centered"/>'),this.join(t)},renderPasswordForm:function(){this.$(".chatroom-body").children().hide(),this.$("span.centered.spinner").remove(),this.$(".chatroom-body").append(e.templates.chatroom_password_form({heading:h("This chatroom requires a password"),label_password:h("Password: "),label_submit:h("Submit")})),this.$(".chatroom-form").on("submit",this.submitPassword.bind(this))},showDisconnectMessage:function(e){this.$(".chat-area").hide(),this.$(".occupants").hide(),this.$("span.centered.spinner").remove(),this.$(".chatroom-body").append(f("<p>"+e+"</p>"))},infoMessages:{100:h("This room is not anonymous"),102:h("This room now shows unavailable members"),103:h("This room does not show unavailable members"),104:h("Non-privacy-related room configuration has changed"),170:h("Room logging is now enabled"),171:h("Room logging is now disabled"),172:h("This room is now non-anonymous"),173:h("This room is now semi-anonymous"),174:h("This room is now fully-anonymous"),201:h("A new room has been created")},disconnectMessages:{301:h("You have been banned from this room"),307:h("You have been kicked from this room"),321:h("You have been removed from this room because of an affiliation change"),322:h("You have been removed from this room because the room has changed to members-only and you're not a member"),332:h("You have been removed from this room because the MUC (Multi-user chat) service is being shut down.")},actionInfoMessages:{301:p("<strong>%1$s</strong> has been banned"),303:p("<strong>%1$s</strong>'s nickname has changed"),307:p("<strong>%1$s</strong> has been kicked out"),321:p("<strong>%1$s</strong> has been removed because of an affiliation change"),322:p("<strong>%1$s</strong> has been removed for not being a member")},newNicknameMessages:{210:p("Your nickname has been automatically changed to: <strong>%1$s</strong>"),303:p("Your nickname has been changed to: <strong>%1$s</strong>")},showStatusMessages:function(t,r){var i=f(t),s,o=[],u=[],a=[];i.find('x[xmlns="'+n.NS.MUC_USER+'"]').each(function(t,s){var c=f(s).find("item");n.getBareJidFromJid(c.attr("jid"))===e.bare_jid&&c.attr("affiliation")==="owner"&&this.$el.find("a.configure-chatroom-button").show(),f(s).find("item reason").each(function(e,t){f(t).text()&&a.push(f(t).text())}),f(s).find("status").each(function(e,t){var s=t.getAttribute("code"),a=n.unescapeNode(n.getResourceFromJid(i.attr("from")));r&&s==="210"?u.push(h(this.newNicknameMessages[s],a)):r&&s==="303"?u.push(h(this.newNicknameMessages[s],c.attr("nick"))):r&&l.contains(l.keys(this.disconnectMessages),s)?o.push(this.disconnectMessages[s]):!r&&l.contains(l.keys(this.actionInfoMessages),s)?u.push(h(this.actionInfoMessages[s],a)):l.contains(l.keys(this.infoMessages),s)?u.push(this.infoMessages[s]):s!=="110"&&f(t).text()&&u.push(f(t).text())}.bind(this))}.bind(this));if(o.length>0){for(s=0;s<o.length;s++)this.showDisconnectMessage(o[s]);for(s=0;s<a.length;s++)this.showDisconnectMessage(h('The reason given is: "'+a[s]+'"'),!0);this.model.set("connection_status",n.Status.DISCONNECTED);return}for(s=0;s<u.length;s++)this.$content.append(e.templates.info({message:u[s]}));for(s=0;s<a.length;s++)this.showStatusNotification(h('The reason given is: "'+a[s]+'"'),!0);return this.scrollDown(),t},showErrorMessage:function(e){e.attr("type")==="auth"?e.find("not-authorized").length?this.renderPasswordForm():e.find("registration-required").length?this.showDisconnectMessage(h("You are not on the member list of this room")):e.find("forbidden").length&&this.showDisconnectMessage(h("You have been banned from this room")):e.attr("type")==="modify"?e.find("jid-malformed").length&&this.showDisconnectMessage(h("No nickname was specified")):e.attr("type")==="cancel"&&(e.find("not-allowed").length?this.showDisconnectMessage(h("You are not allowed to create new rooms")):e.find("not-acceptable").length?this.showDisconnectMessage(h("Your nickname doesn't conform to this room's policies")):e.find("conflict").length?this.showDisconnectMessage(h("Your nickname is already taken")):e.find("item-not-found").length?this.showDisconnectMessage(h("This room does not (yet) exist")):e.find("service-unavailable").length&&this.showDisconnectMessage(h("This room has reached it's maximum number of occupants")))},onChatRoomPresence:function(e){var t=f(e),r,i=this.model.get("nick");t.attr("type")==="error"?(this.model.set("connection_status",n.Status.DISCONNECTED),this.showErrorMessage(t.find("error"))):(r=t.find("status[code='110']").length||t.attr("from")===this.model.get("id")+"/"+n.escapeNode(i),this.model.get("connection_status")!==n.Status.CONNECTED&&this.model.set("connection_status",n.Status.CONNECTED),this.showStatusMessages(e,r)),this.occupantsview.updateOccupantsOnPresence(e)},onChatRoomMessage:function(t){var r=f(t),i=r.find("forwarded"),s;i.length&&(r=i.children("message"),s=i.children("delay"));var o=r.attr("from"),u=r.attr("id"),a=n.getResourceFromJid(o),l=a&&n.unescapeNode(a)||"",c=r.children("subject").text();return u&&this.model.messages.findWhere({msgid:u})?!0:(c&&(this.$el.find(".chatroom-topic").text(c).attr("title",c),this.$content.append(e.templates.info({message:h("Topic set by %1$s to: %2$s",l,c)}))),l===""?!0:(this.model.createMessage(r,s),l!==this.model.get("nick")&&e.emit("message",t),!0))},fetchArchivedMessages:function(r){if(!e.features.findWhere({"var":n.NS.MAM})){e.log("Attempted to fetch archived messages but this user's server doesn't support XEP-0313");return}this.addSpinner(),t.archive.query(l.extend(r,{groupchat:!0}),function(e){this.clearSpinner(),e.length&&l.map(e,this.onChatRoomMessage.bind(this))}.bind(this),function(){this.clearSpinner(),e.log("Error while trying to fetch archived messages","error")}.bind(this))}}),e.ChatRoomOccupant=Backbone.Model,e.ChatRoomOccupantView=Backbone.View.extend({tagName:"li",initialize:function(){this.model.on("add",this.render,this),this.model.on("change",this.render,this),this.model.on("destroy",this.destroy,this)},render:function(){var t=e.templates.occupant(l.extend(this.model.toJSON(),{desc_moderator:h("This user is a moderator"),desc_occupant:h("This user can send messages in this room"),desc_visitor:h("This user can NOT send messages in this room")}));return this.$el.replaceWith(t),this.setElement(t,!0),this},destroy:function(){this.$el.remove()}}),e.ChatRoomOccupants=Backbone.Collection.extend({model:e.ChatRoomOccupant}),e.ChatRoomOccupantsView=Backbone.Overview.extend({tagName:"div",className:"occupants",initialize:function(){this.model.on("add",this.onOccupantAdded,this)},render:function(){return this.$el.html(e.templates.chatroom_sidebar({label_invitation:h("Invite..."),label_occupants:h("Occupants")})),this.initInviteWidget()},onOccupantAdded:function(t){var n=this.get(t.get("id"));n?(delete n.model,n.model=t,n.initialize()):n=this.add(t.get("id"),new e.ChatRoomOccupantView({model:t})),this.$(".occupant-list").append(n.render().$el)},parsePresence:function(e){var t=n.getResourceFromJid(e.getAttribute("from")),r={id:t,nick:t,type:e.getAttribute("type"),states:[]};return l.each(e.childNodes,function(e){switch(e.nodeName){case"status":r.status=e.textContent||null;break;case"show":r.show=e.textContent||null;break;case"x":e.getAttribute("xmlns")===n.NS.MUC_USER&&l.each(e.childNodes,function(e){switch(e.nodeName){case"item":r.affiliation=e.getAttribute("affiliation"),r.role=e.getAttribute("role"),r.jid=e.getAttribute("jid"),r.nick=e.getAttribute("nick")||r.nick;break;case"status":e.getAttribute("code")&&r.states.push(e.getAttribute("code"))}})}}),r},updateOccupantsOnPresence:function(e){var t,n=this.parsePresence(e);switch(n.type){case"error":return!0;case"unavailable":t=this.model.get(n.id),t&&t.destroy();break;default:t=this.model.get(n.id),t?t.save(n):this.model.create(n)}},initInviteWidget:function(){var t=this.$("input.invited-contact");return t.typeahead({minLength:1,highlight:!0},{name:"contacts-dataset",source:function(t,n){var r=[];l.each(e.roster.filter(a.contains(["fullname","jid"],t)),function(e){r.push({value:e.get("fullname"),jid:e.get("jid")})}),n(r)},templates:{suggestion:l.template('<p data-jid="{{jid}}">{{value}}</p>')}}),t.on("typeahead:selected",function(e,t,n){var r=prompt(h(p('You are about to invite %1$s to the chat room "%2$s". '),t.value,this.model.get("id"))+h("You may optionally include a message, explaining the reason for the invitation."));r!==null&&this.chatroomview.directInvite(t.jid,r),f(e.target).typeahead("val","")}.bind(this)),this}}),e.RoomsPanel=Backbone.View.extend({tagName:"div",className:"controlbox-pane",id:"chatrooms",events:{"submit form.add-chatroom":"createChatRoom","click input#show-rooms":"showRooms","click a.open-room":"createChatRoom","click a.room-info":"showRoomInfo","change input[name=server]":"setDomain","change input[name=nick]":"setNick"},initialize:function(e){this.$parent=e.$parent,this.model.on("change:muc_domain",this.onDomainChange,this),this.model.on("change:nick",this.onNickChange,this)},render:function(){return this.$parent.append(this.$el.html(e.templates.room_panel({server_input_type:e.hide_muc_server&&"hidden"||"text",server_label_global_attr:e.hide_muc_server&&" hidden"||"",label_room_name:h("Room name"),label_nickname:h("Nickname"),label_server:h("Server"),label_join:h("Join Room"),label_show_rooms:h("Show rooms")})).hide()),this.$tabs=this.$parent.parent().find("#controlbox-tabs"),this.$tabs.append(e.templates.chatrooms_tab({label_rooms:h("Rooms")})),this},onDomainChange:function(t){var n=this.$el.find("input.new-chatroom-server");n.val(t.get("muc_domain")),e.auto_list_rooms&&this.updateRoomsList()},onNickChange:function(e){var t=this.$el.find("input.new-chatroom-nick");t.val(e.get("nick"))},informNoRoomsFound:function(){var e=this.$el.find("#available-chatrooms");e.html("<dt>"+h("No rooms on %1$s",this.model.get("muc_domain"))+"</dt>"),f("input#show-rooms").show().siblings("span.spinner").remove()},onRoomsFound:function(t){var r,i,s,o,u=this.$el.find("#available-chatrooms");this.rooms=f(t).find("query").find("item");if(this.rooms.length){u.html("<dt>"+h("Rooms on %1$s",this.model.get("muc_domain"))+"</dt>"),o=document.createDocumentFragment();for(s=0;s<this.rooms.length;s++)r=n.unescapeNode(f(this.rooms[s]).attr("name")||f(this.rooms[s]).attr("jid")),i=f(this.rooms[s]).attr("jid"),o.appendChild(f(e.templates.room_item({name:r,jid:i,open_title:h("Click to open this room"),info_title:h("Show more information on this room")}))[0]);u.append(o),f("input#show-rooms").show().siblings("span.spinner").remove()}else this.informNoRoomsFound();return!0},updateRoomsList:function(){e.connection.sendIQ(r({to:this.model.get("muc_domain"),from:e.connection.jid,type:"get"}).c("query",{xmlns:n.NS.DISCO_ITEMS}),this.onRoomsFound.bind(this),this.informNoRoomsFound.bind(this))},showRooms:function(){var e=this.$el.find("#available-chatrooms"),t=this.$el.find("input.new-chatroom-server"),n=t.val();if(!n){t.addClass("error");return}this.$el.find("input.new-chatroom-name").removeClass("error"),t.removeClass("error"),e.empty(),f("input#show-rooms").hide().after('<span class="spinner"/>'),this.model.save({muc_domain:n}),this.updateRoomsList()},showRoomInfo:function(t){var n=t.target,r=f(n).parent("dd"),i=r.find("div.room-info");i.length?i.remove():(r.find("span.spinner").remove(),r.append('<span class="spinner hor_centered"/>'),e.connection.disco.info(f(n).attr("data-room-jid"),null,function(t){var n=f(t);r.find("span.spinner").replaceWith(e.templates.room_description({desc:n.find('field[var="muc#roominfo_description"] value').text(),occ:n.find('field[var="muc#roominfo_occupants"] value').text(),hidden:n.find('feature[var="muc_hidden"]').length,membersonly:n.find('feature[var="muc_membersonly"]').length,moderated:n.find('feature[var="muc_moderated"]').length,nonanonymous:n.find('feature[var="muc_nonanonymous"]').length,open:n.find('feature[var="muc_open"]').length,passwordprotected:n.find('feature[var="muc_passwordprotected"]').length,persistent:n.find('feature[var="muc_persistent"]').length,publicroom:n.find('feature[var="muc_public"]').length,semianonymous:n.find('feature[var="muc_semianonymous"]').length,temporary:n.find('feature[var="muc_temporary"]').length,unmoderated:n.find('feature[var="muc_unmoderated"]').length,label_desc:h("Description:"),label_occ:h("Occupants:"),label_features:h("Features:"),label_requires_auth:h("Requires authentication"),label_hidden:h("Hidden"),label_requires_invite:h("Requires an invitation"),label_moderated:h("Moderated"),label_non_anon:h("Non-anonymous"),label_open_room:h("Open room"),label_permanent_room:h("Permanent room"),label_public:h("Public"),label_semi_anon:h("Semi-anonymous"),label_temp_room:h("Temporary room"),label_unmoderated:h("Unmoderated")}))}.bind(this)))},createChatRoom:function(t){t.preventDefault();var r,i,s,o,a,l=this.$el.find("input.new-chatroom-nick"),c=l.val(),h;c?l.removeClass("error"):l.addClass("error");if(t.type==="click")r=f(t.target).text(),a=f(t.target).attr("data-room-jid");else{i=this.$el.find("input.new-chatroom-name"),o=this.$el.find("input.new-chatroom-server"),s=o.val(),r=i.val().trim(),i.val("");if(!r||!s){r||i.addClass("error"),s||o.addClass("error");return}a=n.escapeNode(r.toLowerCase())+"@"+s.toLowerCase(),i.removeClass("error"),o.removeClass("error"),this.model.save({muc_domain:s})}if(!c)return;h=e.chatboxviews.showChat({id:a,jid:a,name:r||n.unescapeNode(n.getNodeFromJid(a)),nick:c,chatroom:!0,box_id:u(a)})},setDomain:function(e){this.model.save({muc_domain:e.target.value})},setNick:function(e){this.model.save({nick:e.target.value})}}),l.extend(t,{rooms:{open:function(t,r){r||(r=n.getNodeFromJid(e.bare_jid));if(typeof r!="string")throw new TypeError("rooms.open: invalid nick, must be string");var i=function(t){t=t.toLowerCase();var i=e.chatboxes.get(t);return e.log("jid"),i||(i=e.chatboxviews.showChat({id:t,jid:t,name:n.unescapeNode(n.getNodeFromJid(t)),nick:r,chatroom:!0,box_id:u(t)})),e.wrappedChatBox(e.chatboxes.getChatBox(t,!0))};if(typeof t=="undefined")throw new TypeError("rooms.open: You need to provide at least one JID");return typeof t=="string"?i(t):l.map(t,i)},get:function(t){if(typeof t=="undefined")throw new TypeError("rooms.get: You need to provide at least one JID");return typeof t=="string"?e.wrappedChatBox(e.chatboxes.getChatBox(t,!0)):l.map(t,l.partial(e.wrappedChatBox,l.bind(e.chatboxes.getChatBox,e.chatboxes,l,!0)))}}})}})}),function(e,t){define("converse-vcard",["converse-core","converse-api","strophe.vcard"],t)}(this,function(e,t){"use strict";var n=t.env.Strophe,r=t.env.jQuery,i=t.env._,s=t.env.moment;t.plugins.add("vcard",{overrides:{Features:{addClientFeatures:function(){this._super.addClientFeatures.apply(this,arguments),e.use_vcards&&e.connection.disco.addFeature(n.NS.VCARD)}},RosterContacts:{createRequestingContact:function(t){var r=n.getBareJidFromJid(t.getAttribute("from"));e.getVCard(r,i.partial(e.createRequestingContactFromVCard,t),function(n,r){e.log("Error while retrieving vcard for "+r),e.createRequestingContactFromVCard(t,n,r)})}}},initialize:function(){this.updateSettings({use_vcards:!0}),e.createRequestingContactFromVCard=function(t,i,o,u,a,f,l){var c=n.getBareJidFromJid(o),h=r(t).children('nick[xmlns="'+n.NS.NICK+'"]').text(),p={jid:c,subscription:"none",ask:null,requesting:!0,fullname:u||h||c,image:a,image_type:f,url:l,vcard_updated:s().format()};e.roster.create(p),e.emit("contactRequest",p)},e.onVCardError=function(t,n,r){var i=e.roster.get(t);i&&i.save({vcard_updated:s().format()}),r&&r(n,t)},e.onVCardData=function(t,n,o){var u=r(n).find("vCard"),a=u.find("FN").text(),f=u.find("BINVAL").text(),l=u.find("TYPE").text(),c=u.find("URL").text();if(t){var h=e.roster.get(t);h&&(a=i.isEmpty(a)?h.get("fullname")||t:a,h.save({fullname:a,image_type:l,image:f,url:c,vcard_updated:s().format()}))}o&&o(n,t,a,f,l,c)},e.getVCard=function(t,n,r){e.use_vcards?e.connection.vcard.get(i.partial(e.onVCardData,t,i,n),t,i.partial(e.onVCardError,t,i,r)):n&&n(null,t)};var t=function(t,n){if(!e.use_vcards)return;var r=n.model.get("jid"),i=e.roster.get(r);i&&!i.get("vcard_updated")&&e.getVCard(r,function(e,t,r,i,s,o){n.model.save({fullname:r||t,url:o,image_type:s,image:i})},function(){e.log("updateVCardForChatBox: Error occured while fetching vcard")})};e.on("chatBoxInitialized",t);var o=function(t){t.get("vcard_updated")||e.getVCard(t.get("jid"))};e.on("initialized",function(){e.roster.on("add",o)});var u=function(){e.xmppstatus.get("fullname")===undefined&&e.getVCard(null,function(t,n,r){e.xmppstatus.save({fullname:r})})};e.on("statusInitialized",u)}})}),function(e,t){define("converse-minimize",["converse-core","converse-api"],t)}(this,function(e,t){"use strict";var n=t.env.jQuery,r=t.env._,i=t.env.b64_sha1,s=t.env.moment,o=t.env.utils,u=o.__.bind(e);t.plugins.add("minimize",{overrides:{_tearDown:function(){return this._super._tearDown.apply(this,arguments),this.minimized_chats&&(this.minimized_chats.undelegateEvents().model.reset(),this.minimized_chats.removeAll(),this.minimized_chats.tearDown().remove(),delete this.minimized_chats),this},onConnected:function(){return e.minimized_chats=new e.MinimizedChats({model:e.chatboxes}),this._super.onConnected.apply(this,arguments)},registerGlobalEventHandlers:function(){this._super.registerGlobalEventHandlers.apply(this,arguments),n(window).on("resize",r.debounce(function(t){e.chatboxviews.trimChats()},200))},wrappedChatBox:function(e){if(!e)return;var t=this._super.wrappedChatBox.apply(this,arguments);return t.maximize=e.maximize.bind(e),t.minimize=e.minimize.bind(e),t},ChatBox:{initialize:function(){this._super.initialize.apply(this,arguments);if(this.get("id")==="controlbox")return;this.save({minimized:this.get("minimized")||!1,time_minimized:this.get("time_minimized")||s()})},maximize:function(){this.save({minimized:!1,time_opened:s().valueOf()})},minimize:function(){this.save({minimized:!0,time_minimized:s().format()})}},ChatBoxes:{chatBoxShouldBeShown:function(e){return this._super.chatBoxShouldBeShown.apply(this,arguments)&&!e.get("minimized")}},ChatBoxViews:{showChat:function(e){var t=this._super.showChat.apply(this,arguments);return t.get("minimized")&&t.maximize(),t},onChatBoxAdded:function(e){this.trimChats(this._super.onChatBoxAdded.apply(this,arguments))},getChatBoxWidth:function(e){return!e.model.get("minimized")&&e.$el.is(":visible")?e.$el.outerWidth(!0):0},trimChats:function(t){if(e.no_trimming||this.model.length<=1)return;var i,s,o=e.minimized_chats.$el,u=r.contains(this.model.pluck("minimized"),!0)?o.outerWidth(!0):0,a=t?t.model.get("id"):null;s=r.reduce(this.xget(a),function(e,t){return e+this.getChatBoxWidth(t)}.bind(this),t?t.$el.outerWidth(!0):0),u+s>n("body").outerWidth(!0)&&(i=this.getOldestMaximizedChat([a]),i&&i.minimize())},getOldestMaximizedChat:function(e){var t=0,n=this.model.sort().at(t);while(r.contains(e,n.get("id"))||n.get("minimized")===!0){t++,n=this.model.at(t);if(!n)return null}return n}}},initialize:function(){this.updateSettings({no_trimming:!1}),e.MinimizedChatBoxView=Backbone.View.extend({tagName:"div",className:"chat-head",events:{"click .close-chatbox-button":"close","click .restore-chat":"restore"},initialize:function(){this.model.messages.on("add",function(e){e.get("message")&&this.updateUnreadMessagesCounter()},this),this.model.on("change:minimized",this.clearUnreadMessagesCounter,this)},render:function(){var t=r.extend(this.model.toJSON(),{tooltip:u("Click to restore this chat")});return this.model.get("chatroom")?(t.title=this.model.get("name"),this.$el.addClass("chat-head-chatroom")):(t.title=this.model.get("fullname"),this.$el.addClass("chat-head-chatbox")),this.$el.html(e.templates.trimmed_chat(t))},clearUnreadMessagesCounter:function(){this.model.set({num_unread:0}),this.render()},updateUnreadMessagesCounter:function(){this.model.set({num_unread:this.model.get("num_unread")+1}),this.render()},close:function(t){return t&&t.preventDefault&&t.preventDefault(),this.remove(),this.model.destroy(),e.emit("chatBoxClosed",this),this},restore:r.debounce(function(e){e&&e.preventDefault&&e.preventDefault(),this.model.messages.off("add",null,this),this.remove(),this.model.maximize()},200,!0)}),e.MinimizedChats=Backbone.Overview.extend({el:"#minimized-chats",events:{"click #toggle-minimized-chats":"toggle"},initialize:function(){this.initToggle(),this.model.on("add",this.onChanged,this),this.model.on("destroy",this.removeChat,this),this.model.on("change:minimized",this.onChanged,this),this.model.on("change:num_unread",this.updateUnreadMessagesCounter,this)},tearDown:function(){return this.model.off("add",this.onChanged),this.model.off("destroy",this.removeChat),this.model.off("change:minimized",this.onChanged),this.model.off("change:num_unread",this.updateUnreadMessagesCounter),this},initToggle:function(){this.toggleview=new e.MinimizedChatsToggleView({model:new e.MinimizedChatsToggle});var t=i("converse.minchatstoggle"+e.bare_jid);this.toggleview.model.id=t,this.toggleview.model.browserStorage=new Backbone.BrowserStorage[e.storage](t),this.toggleview.model.fetch()},render:function(){return this.keys().length===0?this.$el.hide("fast",e.chatboxviews.trimChats.bind(e.chatboxviews)):this.keys().length===1&&this.$el.show("fast",e.chatboxviews.trimChats.bind(e.chatboxviews)),this.$el},toggle:function(e){e&&e.preventDefault&&e.preventDefault(),this.toggleview.model.save({collapsed:!this.toggleview.model.get("collapsed")}),this.$(".minimized-chats-flyout").toggle()},onChanged:function(e){if(e.get("id")==="controlbox")return;e.get("minimized")?this.addChat(e):this.get(e.get("id"))&&this.removeChat(e)},addChat:function(t){var n=this.get(t.get("id"));if(n&&n.$el.parent().length!==0)return;var r=new e.MinimizedChatBoxView({model:t});this.$(".minimized-chats-flyout").append(r.render()),this.add(t.get("id"),r),this.toggleview.model.set({num_minimized:this.keys().length}),this.render()},removeChat:function(e){this.remove(e.get("id")),this.toggleview.model.set({num_minimized:this.keys().length}),this.render()},updateUnreadMessagesCounter:function(){var e=this.model.pluck("num_unread"),t=0,n;for(n=0;n<e.length;n++)t+=e[n];this.toggleview.model.set({num_unread:t}),this.render()}}),e.MinimizedChatsToggle=Backbone.Model.extend({initialize:function(){this.set({collapsed:this.get("collapsed")||!1,num_minimized:this.get("num_minimized")||0,num_unread:this.get("num_unread")||0})}}),e.MinimizedChatsToggleView=Backbone.View.extend({el:"#toggle-minimized-chats",initialize:function(){this.model.on("change:num_minimized",this.render,this),this.model.on("change:num_unread",this.render,this),this.$flyout=this.$el.siblings(".minimized-chats-flyout")},render:function(){return this.$el.html(e.templates.toggle_chats(r.extend(this.model.toJSON(),{Minimized:u("Minimized")}))),this.model.get("collapsed")?this.$flyout.hide():this.$flyout.show(),this.$el}}),e.on("controlBoxOpened",function(t,n){e.chatboxviews.trimChats(n)})}})}),function(e,t){define("converse-otr",["otr","converse-core","converse-api","converse-minimize"],t)}(this,function(e,t,n){"use strict";var r=n.env.Strophe,i=n.env.utils,s=n.env.b64_sha1,o=n.env.jQuery,u=n.env._,a=i.__.bind(t),f=typeof crypto!="undefined"&&(typeof crypto.randomBytes=="function"||typeof crypto.getRandomValues=="function"),l=f&&typeof CryptoJS!="undefined"&&typeof e.OTR!="undefined"&&typeof e.DSA!="undefined",c=0,h=1,p=2,d=3,v={},m={};m[c]="unencrypted",m[h]="unverified",m[p]="verified",m[d]="finished",n.plugins.add("otr",{overrides:{_initialize:function(){this._super._initialize.apply(this,arguments),this.otr=new this.OTR},registerGlobalEventHandlers:function(){this._super.registerGlobalEventHandlers(),o(document).click(function(){o(".toggle-otr ul").is(":visible")&&o(".toggle-otr ul",this).slideUp(),o(".toggle-smiley ul").is(":visible")&&o(".toggle-smiley ul",this).slideUp()})},wrappedChatBox:function(e){var t=this._super.wrappedChatBox.apply(this,arguments);if(!e)return;return u.extend(t,{endOTR:e.endOTR.bind(e),initiateOTR:e.initiateOTR.bind(e)})},ChatBox:{initialize:function(){this._super.initialize.apply(this,arguments),this.get("box_id")!=="controlbox"&&this.save({otr_status:this.get("otr_status")||c})},isOTRMessage:function(e){var t=e.children("body"),n=t.length>0?t.text():undefined;return!!n.match(/^\?OTR/)},shouldPlayNotification:function(e){return this._super.shouldPlayNotification.apply(this,arguments)&&(!this.isOTRMessage(e)||!!u.contains([h,p],this.get("otr_status")))},createMessage:function(e,t,n){var r=this._super.converse,i=e.children("body"),s=i.length>0?i.text():undefined;if(!s||!r.allow_otr)return this._super.createMessage.apply(this,arguments);if(s.match(/^\?OTRv23?/))this.initiateOTR(s);else if(u.contains([h,p],this.get("otr_status")))this.otr.receiveMsg(s);else{if(!s.match(/^\?OTR/))return this._super.createMessage.apply(this,arguments);this.otr?this.otr.receiveMsg(s):this.initiateOTR(s)}},getSession:function(t){var n=this._super.converse,r=CryptoJS.lib.PasswordBasedCipher,i,o,u,f;if(n.cache_otr_key){i=n.otr.getSessionPassphrase();if(typeof i!="undefined"){o=window.sessionStorage[s(this.id+"instance_tag")],u=window.sessionStorage[s(this.id+"priv_key")],f=window.sessionStorage[s(this.connection.jid+"pass_check")];if(u&&o&&typeof f!="undefined"){var l=r.decrypt(CryptoJS.algo.AES,u,i),c=e.DSA.parsePrivate(l.toString(CryptoJS.enc.Latin1));if(r.decrypt(CryptoJS.algo.AES,f,i).toString(CryptoJS.enc.Latin1)==="match"){this.trigger("showHelpMessages",[a("Re-establishing encrypted session")]),t({key:c,instance_tag:o});return}}}}this.trigger("showHelpMessages",[a("Generating private key."),a("Your browser might become unresponsive.")],null,!0),window.setTimeout(function(){var r=e.OTR.makeInstanceTag();t({key:n.otr.generatePrivateKey.call(this,r),instance_tag:r})},500)},updateOTRStatus:function(t){switch(t){case e.OTR.CONST.STATUS_AKE_SUCCESS:this.otr.msgstate===e.OTR.CONST.MSGSTATE_ENCRYPTED&&this.save({otr_status:h});break;case e.OTR.CONST.STATUS_END_OTR:this.otr.msgstate===e.OTR.CONST.MSGSTATE_FINISHED?this.save({otr_status:d}):this.otr.msgstate===e.OTR.CONST.MSGSTATE_PLAINTEXT&&this.save({otr_status:c})}},onSMP:function(e,t){switch(e){case"question":this.otr.smpSecret(prompt(a("Authentication request from %1$s\n\nYour chat contact is attempting to verify your identity, by asking you the question below.\n\n%2$s",[this.get("fullname"),t])));break;case"trust":t===!0?this.save({otr_status:p}):(this.trigger("showHelpMessages",[a("Could not verify this user's identify.")],"error"),this.save({otr_status:h}));break;default:throw new TypeError("ChatBox.onSMP: Unknown type for SMP")}},initiateOTR:function(t){this.save({otr_status:c}),this.getSession(function(n){var r=this._super.converse;this.otr=new e.OTR({fragment_size:140,send_interval:200,priv:n.key,instance_tag:n.instance_tag,debug:this.debug}),this.otr.on("status",this.updateOTRStatus.bind(this)),this.otr.on("smp",this.onSMP.bind(this)),this.otr.on("ui",function(e){this.trigger("showReceivedOTRMessage",e)}.bind(this)),this.otr.on("io",function(e){this.trigger("sendMessage",new r.Message({message:e}))}.bind(this)),this.otr.on("error",function(e){this.trigger("showOTRError",e)}.bind(this)),this.trigger("showHelpMessages",[a("Exchanging private key with contact.")]),t?this.otr.receiveMsg(t):this.otr.sendQueryMsg()}.bind(this))},endOTR:function(){this.otr&&this.otr.endOtr(),this.save({otr_status:c})}},ChatBoxView:{events:{"click .toggle-otr":"toggleOTRMenu","click .start-otr":"startOTRFromToolbar","click .end-otr":"endOTR","click .auth-otr":"authOTR"},initialize:function(){var e=this._super.converse;this._super.initialize.apply(this,arguments),this.model.on("change:otr_status",this.onOTRStatusChanged,this),this.model.on("showOTRError",this.showOTRError,this),this.model.on("showSentOTRMessage",function(e){this.showMessage({message:e,sender:"me"})},this),this.model.on("showReceivedOTRMessage",function(e){this.showMessage({message:e,sender:"them"})},this),(u.contains([h,p],this.model.get("otr_status"))||e.use_otr_by_default)&&this.model.initiateOTR()},createMessageStanza:function(){var e=this._super.createMessageStanza.apply(this,arguments);return this.model.get("otr_status")!==c&&e.c("private",{xmlns:r.NS.CARBONS}),e},onMessageSubmitted:function(e){var t=this._super.converse;if(!t.connection.authenticated)return this.showHelpMessages(["Sorry, the connection has been lost, and your message could not be sent"],"error");var n=e.replace(/^\s*/,"").match(/^\/(.*)\s*$/);if(n){if(t.allow_otr&&n[1]==="endotr")return this.endOTR();if(t.allow_otr&&n[1]==="otr")return this.model.initiateOTR()}u.contains([h,p],this.model.get("otr_status"))?(this.model.otr.sendMsg(e),this.model.trigger("showSentOTRMessage",e)):this._super.onMessageSubmitted.apply(this,arguments)},onOTRStatusChanged:function(){this.renderToolbar().informOTRChange()},informOTRChange:function(){var e=this.model.toJSON(),t=[];return e.otr_status===c?t.push(a("Your messages are not encrypted anymore")):e.otr_status===h?t.push(a("Your messages are now encrypted but your contact's identity has not been verified.")):e.otr_status===p?t.push(a("Your contact's identify has been verified.")):e.otr_status===d&&t.push(a("Your contact has ended encryption on their end, you should do the same.")),this.showHelpMessages(t,"info",!1)},showOTRError:function(e){var t=this._super.converse;e==="Message cannot be sent at this time."?this.showHelpMessages([a("Your message could not be sent")],"error"):e==="Received an unencrypted message."?this.showHelpMessages([a("We received an unencrypted message")],"error"):e==="Received an unreadable encrypted message."?this.showHelpMessages([a("We received an unreadable encrypted message")],"error"):this.showHelpMessages(["Encryption error occured: "+e],"error"),t.log("OTR ERROR:"+e)},startOTRFromToolbar:function(e){o(e.target).parent().parent().slideUp(),e.stopPropagation(),this.model.initiateOTR()},endOTR:function(e){typeof e!="undefined"&&(e.preventDefault(),e.stopPropagation()),this.model.endOTR()},authOTR:function(e){var t=this._super.converse,n=o(e.target).data().scheme,r,i,s;n==="fingerprint"?(r=confirm(a("Here are the fingerprints, please confirm them with %1$s, outside of this chat.\n\nFingerprint for you, %2$s: %3$s\n\nFingerprint for %1$s: %4$s\n\nIf you have confirmed that the fingerprints match, click OK, otherwise click Cancel.",[this.model.get("fullname"),t.xmppstatus.get("fullname")||t.bare_jid,this.model.otr.priv.fingerprint(),this.model.otr.their_priv_pk.fingerprint()])),r===!0?this.model.save({otr_status:p}):this.model.save({otr_status:h})):n==="smp"?(alert(a("You will be prompted to provide a security question and then an answer to that question.\n\nYour contact will then be prompted the same question and if they type the exact same answer (case sensitive), their identity will be verified.")),i=prompt(a("What is your security question?")),i&&(s=prompt(a("What is the answer to the security question?")),this.model.otr.smpSecret(s,i))):this.showHelpMessages([a("Invalid authentication scheme provided")],"error")},toggleOTRMenu:function(e){e.stopPropagation(),this.$el.find(".toggle-otr ul").slideToggle(200)},getOTRTooltip:function(){var e=this.model.toJSON();if(e.otr_status===c)return a("Your messages are not encrypted. Click here to enable OTR encryption.");if(e.otr_status===h)return a("Your messages are encrypted, but your contact has not been verified.");if(e.otr_status===p)return a("Your messages are encrypted and your contact verified.");if(e.otr_status===d)return a("Your contact has closed their end of the private session, you should do the same")},renderToolbar:function(e){var t=this._super.converse;if(!t.show_toolbar)return;var n=this.model.toJSON();return e=u.extend(e||{},{FINISHED:d,UNENCRYPTED:c,UNVERIFIED:h,VERIFIED:p,allow_otr:t.allow_otr&&!this.is_chatroom,label_end_encrypted_conversation:a("End encrypted conversation"),label_refresh_encrypted_conversation:a("Refresh encrypted conversation"),label_start_encrypted_conversation:a("Start encrypted conversation"),label_verify_with_fingerprints:a("Verify with fingerprints"),label_verify_with_smp:a("Verify with SMP"),label_whats_this:a("What's this?"),otr_status_class:m[n.otr_status],otr_tooltip:this.getOTRTooltip(),otr_translated_status:v[n.otr_status]}),this._super.renderToolbar.call(this,e),this.$el.find(".chat-toolbar").append(t.templates.toolbar_otr(u.extend(this.model.toJSON(),e||{}))),this}},MinimizedChatBoxView:{initialize:function(){this._super.initialize.apply(this,arguments),this.model.on("showReceivedOTRMessage",this.updateUnreadMessagesCounter,this),this.model.on("showSentOTRMessage",this.updateUnreadMessagesCounter,this)}}},initialize:function(){var t=this.converse;v[c]=a("unencrypted"),v[h]=a("unverified"),v[p]=a("verified"),v[d]=a("finished"),a=i.__.bind(t);var n={allow_otr:!0,cache_otr_key:!1,use_otr_by_default:!1};u.extend(t.default_settings,n),u.extend(t,n),u.extend(t,u.pick(t.user_settings,Object.keys(n))),t.allow_otr=t.allow_otr&&l,t.use_otr_by_default=t.use_otr_by_default&&t.allow_otr,t.OTR=Backbone.Model.extend({getSessionPassphrase:function(){if(t.authentication==="prebind"){var e=s(t.connection.jid),n=window.sessionStorage[e];return typeof n=="undefined"&&(n=Math.floor(Math.random()*4294967295).toString(),window.sessionStorage[e]=n),n}return t.connection.pass},generatePrivateKey:function(n){var r=new e.DSA,i=t.connection.jid;if(t.cache_otr_key){var o=CryptoJS.lib.PasswordBasedCipher,u=this.getSessionPassphrase();typeof u!="undefined"&&(window.sessionStorage[s(i+"priv_key")]=o.encrypt(CryptoJS.algo.AES,r.packPrivate(),u).toString(),window.sessionStorage[s(i+"instance_tag")]=n,window.sessionStorage[s(i+"pass_check")]=o.encrypt(CryptoJS.algo.AES,"match",u).toString())}return r}})}})}),function(e,t){define("converse-register",["converse-core","converse-api","converse-controlbox"],t)}(this,function(e,t){"use strict";var n=t.env.Strophe,r=t.env.utils,i=t.env.$iq,s=t.env.jQuery,o=t.env._,u=r.__.bind(e);n.addNamespace("REGISTER","jabber:iq:register");var a=0;Object.keys(n.Status).forEach(function(e){a=Math.max(a,n.Status[e])}),n.Status.REGIFAIL=a+1,n.Status.REGISTERED=a+2,n.Status.CONFLICT=a+3,n.Status.NOTACCEPTABLE=a+5,t.plugins.add("register",{overrides:{ControlBoxView:{renderLoginPanel:function(){this._super.renderLoginPanel.apply(this,arguments);var e=this._super.converse,t;return e.allow_registration&&(t={$parent:this.$el.find(".controlbox-panes"),model:this},typeof this.registerpanel=="undefined"?this.registerpanel=new e.RegisterPanel(t):this.registerpanel.delegateEvents().initialize(t),this.registerpanel.render().$el.hide()),this}}},initialize:function(){var e=this.converse;this.updateSettings({allow_registration:!0,domain_placeholder:u(" e.g. conversejs.org"),providers_link:"https://xmpp.net/directory.php"}),e.RegisterPanel=Backbone.View.extend({tagName:"div",id:"register",className:"controlbox-pane",events:{"submit form#converse-register":"onProviderChosen"},initialize:function(e){this.reset(),this.$parent=e.$parent,this.$tabs=e.$parent.parent().find("#controlbox-tabs"),this.registerHooks()},render:function(){return this.$parent.append(this.$el.html(e.templates.register_panel({label_domain:u("Your XMPP provider's domain name:"),label_register:u("Fetch registration form"),help_providers:u("Tip: A list of public XMPP providers is available"),help_providers_link:u("here"),href_providers:e.providers_link,domain_placeholder:e.domain_placeholder}))),this.$tabs.append(e.templates.register_tab({label_register:u("Register")})),this},registerHooks:function(){var t=e.connection,n=t._connect_cb.bind(t);t._connect_cb=function(e,t,r){this._registering?this.getRegistrationFields(e,t,r)&&(this._registering=!1):n(e,t,r)}.bind(this)},getRegistrationFields:function(t,r,s){e.log("sendQueryStanza was called");var o=e.connection;o.connected=!0;var a=o._proto._reqToData(t);if(!a)return;if(o._proto._connect_cb(a)===n.Status.CONNFAIL)return!1;var f=a.getElementsByTagName("register"),l=a.getElementsByTagName("mechanism");return f.length===0&&l.length===0?(o._proto._no_auth_received(r),!1):f.length===0?(o._changeConnectStatus(n.Status.REGIFAIL,u("Sorry, the given provider does not support in band account registration. Please try with a different provider.")),!0):(o._addSysHandler(this.onRegistrationFields.bind(this),null,"iq",null,null),o.send(i({type:"get"}).c("query",{xmlns:n.NS.REGISTER}).tree()),!0)},onRegistrationFields:function(t){return t.getElementsByTagName("query").length!==1?(e.connection._changeConnectStatus(n.Status.REGIFAIL,"unknown"),!1):(this.setFields(t),this.renderRegistrationForm(t),!1)},reset:function(e){var t={fields:{},urls:[],title:"",instructions:"",registered:!1,_registering:!1,domain:null,form_type:null};o.extend(this,t),e&&o.extend(this,o.pick(e,Object.keys(t)))},onProviderChosen:function(t){t&&t.preventDefault&&t.preventDefault();var r=s(t.target),i=r.find("input[name=domain]"),o=i.val();if(!o){i.addClass("error");return}return r.find("input[type=submit]").hide().after(e.templates.registration_request({cancel:u("Cancel"),info_message:u("Requesting a registration form from the XMPP server")})),r.find("button.cancel").on("click",this.cancelRegistration.bind(this)),this.reset({domain:n.getDomainFromJid(o),_registering:!0}),e.connection.connect(this.domain,"",this.onRegistering.bind(this)),!1},giveFeedback:function(e,t){this.$(".reg-feedback").attr("class","reg-feedback").text(e),t&&s(".reg-feedback").addClass(t)},onRegistering:function(t,r){var i;e.log("onRegistering"),o.contains([n.Status.DISCONNECTED,n.Status.CONNFAIL,n.Status.REGIFAIL,n.Status.NOTACCEPTABLE,n.Status.CONFLICT],t)?(e.log("Problem during registration: Strophe.Status is: "+t),this.cancelRegistration(),r?this.giveFeedback(r,"error"):this.giveFeedback(u('Something went wrong while establishing a connection with "%1$s". Are you sure it exists?',this.domain),"error")):t===n.Status.REGISTERED&&(e.log("Registered successfully."),e.connection.reset(),i=this,this.$("form").hide(function(){s(this).replaceWith('<span class="spinner centered"/>'),i.fields.password&&i.fields.username?(e.connection.connect(i.fields.username.toLowerCase()+"@"+i.domain.toLowerCase(),i.fields.password,e.onConnectStatusChanged),e.chatboxviews.get("controlbox").switchTab({target:i.$tabs.find(".current")}).giveFeedback(u("Now logging you in"))):e.chatboxviews.get("controlbox").renderLoginPanel().giveFeedback(u("Registered successfully")),i.reset()}))},renderRegistrationForm:function(t){var n=this.$("form"),i=s(t),a,f;n.empty().append(e.templates.registration_form({domain:this.domain,title:this.title,instructions:this.instructions})),this.form_type==="xform"?(a=i.find("field"),o.each(a,function(e){n.append(r.xForm2webForm.bind(this,s(e),i))}.bind(this))):(o.each(Object.keys(this.fields),function(t){t==="username"?f=e.templates.form_username({domain:" @"+this.domain,name:t,type:"text",label:t,value:"",required:1}):(n.append("<label>"+t+"</label>"),f=s('<input placeholder="'+t+'" name="'+t+'"></input>'),(t==="password"||t==="email")&&f.attr("type",t)),n.append(f)}.bind(this)),o.each(this.urls,function(e){n.append(s('<a target="blank"></a>').attr("href",e).text(e))}.bind(this))),this.fields?(n.append('<input type="submit" class="pure-button button-primary" value="'+u("Register")+'"/>'),n.on("submit",this.submitRegistrationForm.bind(this)),n.append('<input type="button" class="pure-button button-cancel" value="'+u("Cancel")+'"/>'),n.find("input[type=button]").on("click",this.cancelRegistration.bind(this))):(n.append('<input type="button" class="submit" value="'+u("Return")+'"/>'),n.find("input[type=button]").on("click",this.cancelRegistration.bind(this)))},reportErrors:function(e){var t=this.$("form"),n,r=s(e).find("error text"),i=t.find(".form-errors");i.length?i.empty():(n='<legend class="form-errors"></legend>',t.find("p.instructions").length?t.find("p.instructions").append(n):t.prepend(n),i=t.find(".form-errors")),r.each(function(e,t){i.append(s("<p>").text(s(t).text()))}),r.length||i.append(s("<p>").text(u("The provider rejected your registration attempt. Please check the values you entered for correctness."))),i.show()},cancelRegistration:function(t){t&&t.preventDefault&&t.preventDefault(),e.connection.reset(),this.render()},submitRegistrationForm:function(t){t&&t.preventDefault&&t.preventDefault();var o=this.$("input.required:emptyVal");if(o.length){o.addClass("error");return}var u=s(t.target).find(":input:not([type=button]):not([type=submit])"),a=i({type:"set"}).c("query",{xmlns:n.NS.REGISTER});this.form_type==="xform"?(a.c("x",{xmlns:n.NS.XFORM,type:"submit"}),u.each(function(){a.cnode(r.webForm2xForm(this)).up()})):u.each(function(){var e=s(this);a.c(e.attr("name"),{},e.val())}),e.connection._addSysHandler(this._onRegisterIQ.bind(this),null,"iq",null,null),e.connection.send(a),this.setFields(a.tree())},setFields:function(e){var t=s(e).find("query"),r;t.length>0&&(r=t.find('x[xmlns="'+n.NS.XFORM+'"]'),r.length>0?this._setFieldsFromXForm(r):this._setFieldsFromLegacy(t))},_setFieldsFromLegacy:function(e){e.children().each(function(e,t){var r=s(t);if(t.tagName.toLowerCase()==="instructions"){this.instructions=n.getText(t);return}if(t.tagName.toLowerCase()==="x"){r.attr("xmlns")==="jabber:x:oob"&&r.find("url").each(function(e,t){this.urls.push(s(t).text())}.bind(this));return}this.fields[t.tagName.toLowerCase()]=n.getText(t)}.bind(this)),this.form_type="legacy"},_setFieldsFromXForm:function(t){this.title=t.find("title").text(),this.instructions=t.find("instructions").text(),t.find("field").each(function(t,n){var r=n.getAttribute("var");r?this.fields[r.toLowerCase()]=s(n).children("value").text():e.log("WARNING: Found field we couldn't parse")}.bind(this)),this.form_type="xform"},_onRegisterIQ:function(t){var r=null,i=t.getElementsByTagName("query");i.length>0&&(i=i[0]);if(t.getAttribute("type")==="error"){e.log("Registration failed."),r=t.getElementsByTagName("error");if(r.length!==1)return e.connection._changeConnectStatus(n.Status.REGIFAIL,"unknown"),!1;r=r[0].firstChild.tagName.toLowerCase(),r==="conflict"?e.connection._changeConnectStatus(n.Status.CONFLICT,r):r==="not-acceptable"?e.connection._changeConnectStatus(n.Status.NOTACCEPTABLE,r):e.connection._changeConnectStatus(n.Status.REGIFAIL,r),this.reportErrors(t)}else e.connection._changeConnectStatus(n.Status.REGISTERED,null);return!1},remove:function(){this.$tabs.empty(),this.$el.parent().empty()}})}})}),function(e,t){define("converse-ping",["converse-core","converse-api","strophe.ping"],t)}(this,function(e,t){"use strict";var n=t.env.Strophe,r=t.env._;t.plugins.add("ping",{overrides:{onConnected:function(){var t=this._super.onConnected();return t.done(e.registerPingHandler),t},onReconnected:function(){var t=this._super.onReconnected();return t.done(e.registerPingHandler),t}},initialize:function(){var e=this.converse;this.updateSettings({ping_interval:180}),e.ping=function(t,r,i,s){e.lastStanzaDate=new Date;if(typeof t=="undefined"||t===null)t=n.getDomainFromJid(e.bare_jid);return typeof s=="undefined"&&(s=null),typeof r=="undefined"&&(r=null),typeof i=="undefined"&&(i=null),e.connection?(e.connection.ping.ping(t,r,i,s),!0):!1},e.pong=function(t){return e.lastStanzaDate=new Date,e.connection.ping.pong(t),!0},e.registerPongHandler=function(){e.connection.disco.addFeature(n.NS.PING),e.connection.ping.addPingHandler(e.pong)},e.registerPingHandler=function(){e.registerPongHandler(),e.ping_interval>0&&(e.connection.addHandler(function(){return e.lastStanzaDate=new Date,!0}),e.connection.addTimedHandler(1e3,function(){var t=new Date;return e.lastStanzaDate||(e.lastStanzaDate=t),(t-e.lastStanzaDate)/1e3>e.ping_interval?e.ping():!0}))},r.extend(t,{ping:function(t){e.ping(t)}})}})}),function(e,t){define("converse-notification",["converse-core","converse-api"],t)}(this,function(e,t){"use strict";var n=t.env.jQuery,r=t.env.utils,i=t.env.Strophe,s=t.env._,o=r.__.bind(e),u=r.___,a="Notification"in window;t.plugins.add("notification",{initialize:function(){var e=this.converse;this.updateSettings({show_desktop_notifications:!0,chatstate_notification_blacklist:[],play_sounds:!1,sounds_path:"/sounds/",notification_icon:"/logo/conversejs.png"}),e.isOnlyChatStateNotification=function(t){return t.find("body").length===0&&(t.find(e.ACTIVE).length!==0||t.find(e.COMPOSING).length!==0||t.find(e.INACTIVE).length!==0||t.find(e.PAUSED).length!==0||t.find(e.GONE).length!==0)},e.shouldNotifyOfGroupMessage=function(t){var n=t.attr("from"),r=i.getResourceFromJid(n),s=r&&i.unescapeNode(r)||"";if(s===""||t.find("delay").length>0)return!1;var o=e.chatboxes.get(i.getBareJidFromJid(n)),u=t.children("body").text();return s===o.get("nick")||!(new RegExp("\\b"+o.get("nick")+"\\b")).test(u)?!1:!0},e.shouldNotifyOfMessage=function(t){var n=t.find("forwarded");if(n.length)return!1;if(t.attr("type")==="groupchat")return e.shouldNotifyOfGroupMessage(t);var r=i.getBareJidFromJid(t.attr("from"))===e.bare_jid;return!e.isOnlyChatStateNotification(t)&&!r},e.playSoundNotification=function(t){var n;e.play_sounds&&typeof Audio!="undefined"&&(n=new Audio(e.sounds_path+"msg_received.ogg"),n.canPlayType("/audio/ogg")?n.play():(n=new Audio(e.sounds_path+"msg_received.mp3"),n.play()))},e.areDesktopNotificationsEnabled=function(t){var n=a&&e.show_desktop_notifications&&Notification.permission==="granted";return t?n:n&&e.windowState==="blur"},e.showMessageNotification=function(t){var n=i.getBareJidFromJid(t.attr("from")),r=e.roster.get(n),s=new Notification(o(u("%1$s says"),r.get("fullname")),{body:t.children("body").text(),lang:e.i18n.locale_data.converse[""].lang,icon:e.notification_icon});setTimeout(s.close.bind(s),5e3)},e.showChatStateNotification=function(t){if(s.contains(e.chatstate_notification_blacklist,t.get("jid")))return;var n=t.chat_status,r=null;n==="offline"?r=o("has gone offline"):n==="away"?r=o("has gone away"):n==="dnd"?r=o("is busy"):n==="online"&&(r=o("has come online"));if(r===null)return;var i=new Notification(t.fullname,{body:r,lang:e.i18n.locale_data.converse[""].lang,icon:"logo/conversejs.png"});setTimeout(i.close.bind(i),5e3)},e.showContactRequestNotification=function(t){var n=new Notification(t.fullname,{body:o("wants to be your contact"),lang:e.i18n.locale_data.converse[""].lang,icon:"logo/conversejs.png"});setTimeout(n.close.bind(n),5e3)},e.handleChatStateNotification=function(t,n){e.areDesktopNotificationsEnabled()&&e.showChatStateNotification(n)},e.handleMessageNotification=function(t,r){var i=n(r);if(!e.shouldNotifyOfMessage(i))return!1;e.playSoundNotification(i),e.areDesktopNotificationsEnabled()&&e.showMessageNotification(i)},e.handleContactRequestNotification=function(t,n){e.areDesktopNotificationsEnabled(!0)&&e.showContactRequestNotification(n)},e.requestPermission=function(e){a&&!s.contains(["denied","granted"],Notification.permission)&&Notification.requestPermission()},e.on("contactRequest",e.handleContactRequestNotification),e.on("contactStatusChanged",e.handleChatStateNotification),e.on("message",e.handleMessageNotification),e.on("connected",e.requestPermission)}})}),function(e,t){define("converse-headline",["converse-core","converse-api","converse-chatview"],t)}(this,function(e,t){"use strict";t.plugins.add("headline",{initialize:function(){}})});var config;typeof require=="undefined"&&(require={config:function(e){config=e}}),require.config({baseUrl:".",paths:{backbone:"components/backbone/backbone","backbone.browserStorage":"components/backbone.browserStorage/backbone.browserStorage","backbone.overview":"components/backbone.overview/backbone.overview",eventemitter:"components/otr/build/dep/eventemitter",jquery:"components/jquery/dist/jquery","jquery-private":"src/jquery-private","jquery.browser":"components/jquery.browser/dist/jquery.browser","jquery.easing":"components/jquery-easing-original/index",moment:"components/momentjs/moment",strophe:"components/strophejs/src/wrapper","strophe-base64":"components/strophejs/src/base64","strophe-bosh":"components/strophejs/src/bosh","strophe-core":"components/strophejs/src/core","strophe-md5":"components/strophejs/src/md5","strophe-polyfill":"components/strophejs/src/polyfills","strophe-sha1":"components/strophejs/src/sha1","strophe-utils":"components/strophejs/src/utils","strophe-websocket":"components/strophejs/src/websocket","strophe.disco":"components/strophejs-plugins/disco/strophe.disco","strophe.ping":"src/strophe.ping","strophe.rsm":"components/strophejs-plugins/rsm/strophe.rsm","strophe.vcard":"src/strophe.vcard",text:"components/requirejs-text/text",tpl:"components/requirejs-tpl-jcbrand/tpl",typeahead:"components/typeahead.js/index",underscore:"components/underscore/underscore",utils:"src/utils",polyfill:"src/polyfill","converse-api":"src/converse-api","converse-chatview":"src/converse-chatview","converse-controlbox":"src/converse-controlbox","converse-core":"src/converse-core","converse-headline":"src/converse-headline","converse-mam":"src/converse-mam","converse-minimize":"src/converse-minimize","converse-muc":"src/converse-muc","converse-notification":"src/converse-notification","converse-otr":"src/converse-otr","converse-ping":"src/converse-ping","converse-register":"src/converse-register","converse-rosterview":"src/converse-rosterview","converse-templates":"src/converse-templates","converse-vcard":"src/converse-vcard",bigint:"src/bigint",crypto:"src/crypto","crypto.aes":"components/otr/vendor/cryptojs/aes","crypto.cipher-core":"components/otr/vendor/cryptojs/cipher-core","crypto.core":"components/otr/vendor/cryptojs/core","crypto.enc-base64":"components/otr/vendor/cryptojs/enc-base64","crypto.evpkdf":"components/crypto-js-evanvosberg/src/evpkdf","crypto.hmac":"components/otr/vendor/cryptojs/hmac","crypto.md5":"components/crypto-js-evanvosberg/src/md5","crypto.mode-ctr":"components/otr/vendor/cryptojs/mode-ctr","crypto.pad-nopadding":"components/otr/vendor/cryptojs/pad-nopadding","crypto.sha1":"components/otr/vendor/cryptojs/sha1","crypto.sha256":"components/otr/vendor/cryptojs/sha256",salsa20:"components/otr/build/dep/salsa20",otr:"src/otr",locales:"src/locales",jed:"components/jed/jed",af:"locale/af/LC_MESSAGES/converse.json",de:"locale/de/LC_MESSAGES/converse.json",en:"locale/en/LC_MESSAGES/converse.json",es:"locale/es/LC_MESSAGES/converse.json",fr:"locale/fr/LC_MESSAGES/converse.json",he:"locale/he/LC_MESSAGES/converse.json",hu:"locale/hu/LC_MESSAGES/converse.json",id:"locale/id/LC_MESSAGES/converse.json",it:"locale/it/LC_MESSAGES/converse.json",ja:"locale/ja/LC_MESSAGES/converse.json",nb:"locale/nb/LC_MESSAGES/converse.json",nl:"locale/nl/LC_MESSAGES/converse.json",pl:"locale/pl/LC_MESSAGES/converse.json",pt_BR:"locale/pt_BR/LC_MESSAGES/converse.json",ru:"locale/ru/LC_MESSAGES/converse.json",uk:"locale/uk/LC_MESSAGES/converse.json",zh:"locale/zh/LC_MESSAGES/converse.json",moment_with_locales:"src/moment_locales",moment_af:"components/momentjs/locale/af",moment_de:"components/momentjs/locale/de",moment_es:"components/momentjs/locale/es",moment_fr:"components/momentjs/locale/fr",moment_he:"components/momentjs/locale/he",moment_hu:"components/momentjs/locale/hu",moment_id:"components/momentjs/locale/id",moment_it:"components/momentjs/locale/it",moment_ja:"components/momentjs/locale/ja",moment_nb:"components/momentjs/locale/nb",moment_nl:"components/momentjs/locale/nl",moment_pl:"components/momentjs/locale/pl","moment_pt-br":"components/momentjs/locale/pt-br",moment_ru:"components/momentjs/locale/ru",moment_uk:"components/momentjs/locale/uk",moment_zh:"components/momentjs/locale/zh-cn",action:"src/templates/action",add_contact_dropdown:"src/templates/add_contact_dropdown",add_contact_form:"src/templates/add_contact_form",change_status_message:"src/templates/change_status_message",chat_status:"src/templates/chat_status",chatarea:"src/templates/chatarea",chatbox:"src/templates/chatbox",chatroom:"src/templates/chatroom",chatroom_form:"src/templates/chatroom_form",chatroom_password_form:"src/templates/chatroom_password_form",chatroom_sidebar:"src/templates/chatroom_sidebar",chatrooms_tab:"src/templates/chatrooms_tab",chats_panel:"src/templates/chats_panel",choose_status:"src/templates/choose_status",contacts_panel:"src/templates/contacts_panel",contacts_tab:"src/templates/contacts_tab",controlbox:"src/templates/controlbox",controlbox_toggle:"src/templates/controlbox_toggle",field:"src/templates/field",form_captcha:"src/templates/form_captcha",form_checkbox:"src/templates/form_checkbox",form_input:"src/templates/form_input",form_select:"src/templates/form_select",form_textarea:"src/templates/form_textarea",form_username:"src/templates/form_username",group_header:"src/templates/group_header",info:"src/templates/info",login_panel:"src/templates/login_panel",login_tab:"src/templates/login_tab",message:"src/templates/message",new_day:"src/templates/new_day",occupant:"src/templates/occupant",pending_contact:"src/templates/pending_contact",pending_contacts:"src/templates/pending_contacts",register_panel:"src/templates/register_panel",register_tab:"src/templates/register_tab",registration_form:"src/templates/registration_form",registration_request:"src/templates/registration_request",requesting_contact:"src/templates/requesting_contact",requesting_contacts:"src/templates/requesting_contacts",room_description:"src/templates/room_description",room_item:"src/templates/room_item",room_panel:"src/templates/room_panel",roster:"src/templates/roster",roster_item:"src/templates/roster_item",search_contact:"src/templates/search_contact",select_option:"src/templates/select_option",status_option:"src/templates/status_option",toggle_chats:"src/templates/toggle_chats",toolbar:"src/templates/toolbar",toolbar_otr:"src/templates/toolbar_otr",trimmed_chat:"src/templates/trimmed_chat",vcard:"src/templates/vcard"},map:{"*":{jquery:"jquery-private"},"jquery-private":{jquery:"jquery"}},tpl:{templateSettings:{evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g}},shim:{"crypto.aes":{deps:["crypto.cipher-core"]},"crypto.cipher-core":{deps:["crypto.enc-base64","crypto.evpkdf"]},"crypto.enc-base64":{deps:["crypto.core"]},"crypto.evpkdf":{deps:["crypto.md5"]},"crypto.hmac":{deps:["crypto.core"]},"crypto.md5":{deps:["crypto.core"]},"crypto.mode-ctr":{deps:["crypto.cipher-core"]},"crypto.pad-nopadding":{deps:["crypto.cipher-core"]},"crypto.sha1":{deps:["crypto.core"]},"crypto.sha256":{deps:["crypto.core"]},bigint:{deps:["crypto"]},"strophe.ping":{deps:["strophe"]},"strophe.register":{deps:["strophe"]},"strophe.vcard":{deps:["strophe"]}}}),typeof define!="undefined"&&define("converse",["jquery","converse-api","locales","converse-chatview","converse-mam","converse-muc","converse-vcard","converse-otr","converse-controlbox","converse-register","converse-ping","converse-notification","converse-minimize","converse-headline"],function(e,t){return window.converse=t,e(window).trigger("converse-loaded",t),t}),require(["converse"]),define("jquery",[],function(){return jQuery}),define("jquery-private",[],function(){return jQuery}),define("jquery.browser",[],function(){return jQuery}),define("typeahead",[],function(){return jQuery}),define("underscore",[],function(){return _}),define("moment_with_locales",[],function(){return moment}),define("strophe",[],function(){return{Strophe:Strophe,$build:$build,$iq:$iq,$msg:$msg,$pres:$pres,SHA1:SHA1,Base64:Base64,MD5:MD5,b64_hmac_sha1:SHA1.b64_hmac_sha1,b64_sha1:SHA1.b64_sha1,str_hmac_sha1:SHA1.str_hmac_sha1,str_sha1:SHA1.str_sha1}});var strophePlugin=function(){return Strophe},emptyFunction=function(){};define("strophe.disco",["strophe"],strophePlugin),define("strophe.ping",["strophe"],strophePlugin),define("strophe.rsm",["strophe"],strophePlugin),define("strophe.vcard",["strophe"],strophePlugin),define("backbone",[],emptyFunction),define("backbone.browserStorage",["backbone"],emptyFunction),define("backbone.overview",["backbone"],emptyFunction),define("otr",[],function(){return{DSA:DSA,OTR:OTR}}),define("locales",[],emptyFunction);